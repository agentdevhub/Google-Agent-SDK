
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Google ADK(Agent Development Kit ) 是由谷歌开源的 AI 代理框架，专为开发和部署 AI 代理而设计，支持 Gemini 模型和 Google AI 工具的紧密集成，一个开源的、代码优先的Python工具包，用于灵活可控地构建、评估和部署复杂AI智能体。">
      
      
      
        <link rel="canonical" href="https://google-agent-sdk.agentdevhub.com/get-started/tutorial/">
      
      
        <link rel="prev" href="../quickstart-streaming/">
      
      
        <link rel="next" href="../testing/">
      
      
      <link rel="icon" href="../../assets/agent-development-kit.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.11">
    
    
      
        <title>教程 - Google ADK(Agent Development Kit ) 中文文档</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Google Sans";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="white">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#adk" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      <!--
 Copyright 2025 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!-- Determine classes -->


  


<!-- Header -->
<header class="md-header md-header--shadow" data-md-component="header">
  <nav
    class="md-header__inner md-grid"
    aria-label="Header"
  >

    <!-- Link to home -->
    <a
      href="../.."
      title="Google ADK(Agent Development Kit ) 中文文档"
      class="md-header__button md-logo"
      aria-label="Google ADK(Agent Development Kit ) 中文文档"
      data-md-component="logo"
    >
      
  <img src="../../assets/agent-development-kit.png" alt="logo">

    </a>

    <!-- Button to open drawer -->
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>

    <!-- Header title -->
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            <a
      href="../.."
      title="Google ADK(Agent Development Kit ) 中文文档"
      aria-label="Google ADK(Agent Development Kit ) 中文文档"
      data-md-component="logo"
    >
            Google ADK(Agent Development Kit ) 中文文档
            </a>
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              教程
            
            </a>
          </span>
        </div>
      </div>
    </div>

    <!-- Color palette toggle -->
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="white"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="white" data-md-color-accent="white"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    

    <!-- User preference: color palette -->
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    

    <!-- Site language selector -->
    

    <!-- Button to open search modal -->
    
      

      <!-- Check if search is actually enabled - see https://t.ly/DT_0V -->
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>

        <!-- Search interface -->
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    

    <!-- Repository information -->
    
      <div class="md-header__source">
        <a href="https://github.com/agentdevhub/Google-Agent-SDK" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    Google-Agent-SDK
  </div>
</a>
      </div>
    
  </nav>

  <!-- Navigation tabs (sticky) -->
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Google ADK(Agent Development Kit ) 中文文档" class="md-nav__button md-logo" aria-label="Google ADK(Agent Development Kit ) 中文文档" data-md-component="logo">
      
  <img src="../../assets/agent-development-kit.png" alt="logo">

    </a>
    Google ADK(Agent Development Kit ) 中文文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/agentdevhub/Google-Agent-SDK" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    Google-Agent-SDK
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    首页
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    入门指南
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            入门指南
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    安装指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    快速入门
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quickstart-streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    快速入门 (streaming)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    教程
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    教程
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0" class="md-nav__link">
    <span class="md-ellipsis">
      第0步：设置与安装
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第0步：设置与安装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      库安装
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      导入库
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      设置API密钥
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      定义模型常量以便使用
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-" class="md-nav__link">
    <span class="md-ellipsis">
      第1步：你的第一个智能体 - 基础天气查询
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第1步：你的第一个智能体 - 基础天气查询">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 定义工具
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 定义智能体
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-runnersession-service" class="md-nav__link">
    <span class="md-ellipsis">
      3. 设置Runner和Session Service
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 与智能体交互
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 运行对话
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2litellm" class="md-nav__link">
    <span class="md-ellipsis">
      第2步：使用LiteLLM实现多模型支持
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第2步：使用LiteLLM实现多模型支持">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-litellm" class="md-nav__link">
    <span class="md-ellipsis">
      1. 导入LiteLlm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    <span class="md-ellipsis">
      2. 定义并测试多模型智能体
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-" class="md-nav__link">
    <span class="md-ellipsis">
      第3步：构建智能体团队 - 问候与告别的委派
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第3步：构建智能体团队 - 问候与告别的委派">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 为子智能体定义工具
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 定义子智能体（问候与告别）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 定义带子智能体的根智能体
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_1" class="md-nav__link">
    <span class="md-ellipsis">
      4. 与智能体团队交互
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4_2" class="md-nav__link">
    <span class="md-ellipsis">
      第4步：通过会话状态添加记忆与个性化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第4步：通过会话状态添加记忆与个性化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_2" class="md-nav__link">
    <span class="md-ellipsis">
      1. 初始化新会话服务和状态
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_3" class="md-nav__link">
    <span class="md-ellipsis">
      2. 创建状态感知天气工具
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_1" class="md-nav__link">
    <span class="md-ellipsis">
      3. 重新定义子智能体并更新根智能体
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_3" class="md-nav__link">
    <span class="md-ellipsis">
      4. 交互并测试状态流
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-before_model_callback" class="md-nav__link">
    <span class="md-ellipsis">
      第5步：添加安全性 - 使用before_model_callback的输入防护
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第5步：添加安全性 - 使用before_model_callback的输入防护">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_3" class="md-nav__link">
    <span class="md-ellipsis">
      1. 定义防护回调函数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_4" class="md-nav__link">
    <span class="md-ellipsis">
      2. 更新根智能体使用回调
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_2" class="md-nav__link">
    <span class="md-ellipsis">
      3. 交互测试防护
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    测试方法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/google/adk-samples" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    示例代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    关于 ADK
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../agents/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    代理系统
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            代理系统
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/llm-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LLM 代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../agents/workflow-agents/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    工作流代理
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            工作流代理
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/workflow-agents/sequential-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    顺序代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/workflow-agents/loop-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    循环代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/workflow-agents/parallel-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    并行代理
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/custom-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    自定义代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/multi-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    多代理系统
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    模型
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../tools/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    工具集
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            工具集
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/function-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    函数工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/built-in-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    内置工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/third-party-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    第三方工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/google-cloud-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Google Cloud 工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/mcp-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MCP 工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/openapi-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OpenAPI 工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/authentication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    身份验证
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../deploy/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    部署
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            部署
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/agent-engine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent Engine
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/cloud-run/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cloud Run
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../sessions/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    会话与记忆
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            会话与记忆
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sessions/session/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    会话
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sessions/state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    状态
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sessions/memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    记忆机制
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../artifacts/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    制品
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            制品
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../callbacks/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    回调函数
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            回调函数
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../callbacks/types-of-callbacks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    回调类型
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../callbacks/design-patterns-and-best-practices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    回调模式
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../runtime/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    运行时
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            运行时
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../events/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    事件
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            事件
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../context/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    上下文
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            上下文
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../evaluate/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    评估
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            评估
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    指南
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            指南
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/responsible-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    负责任代理指南
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    贡献指南
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API 参考
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0" class="md-nav__link">
    <span class="md-ellipsis">
      第0步：设置与安装
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第0步：设置与安装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      库安装
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      导入库
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      设置API密钥
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      定义模型常量以便使用
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-" class="md-nav__link">
    <span class="md-ellipsis">
      第1步：你的第一个智能体 - 基础天气查询
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第1步：你的第一个智能体 - 基础天气查询">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 定义工具
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 定义智能体
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-runnersession-service" class="md-nav__link">
    <span class="md-ellipsis">
      3. 设置Runner和Session Service
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 与智能体交互
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 运行对话
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2litellm" class="md-nav__link">
    <span class="md-ellipsis">
      第2步：使用LiteLLM实现多模型支持
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第2步：使用LiteLLM实现多模型支持">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-litellm" class="md-nav__link">
    <span class="md-ellipsis">
      1. 导入LiteLlm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    <span class="md-ellipsis">
      2. 定义并测试多模型智能体
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-" class="md-nav__link">
    <span class="md-ellipsis">
      第3步：构建智能体团队 - 问候与告别的委派
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第3步：构建智能体团队 - 问候与告别的委派">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 为子智能体定义工具
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 定义子智能体（问候与告别）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 定义带子智能体的根智能体
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_1" class="md-nav__link">
    <span class="md-ellipsis">
      4. 与智能体团队交互
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4_2" class="md-nav__link">
    <span class="md-ellipsis">
      第4步：通过会话状态添加记忆与个性化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第4步：通过会话状态添加记忆与个性化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_2" class="md-nav__link">
    <span class="md-ellipsis">
      1. 初始化新会话服务和状态
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_3" class="md-nav__link">
    <span class="md-ellipsis">
      2. 创建状态感知天气工具
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_1" class="md-nav__link">
    <span class="md-ellipsis">
      3. 重新定义子智能体并更新根智能体
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_3" class="md-nav__link">
    <span class="md-ellipsis">
      4. 交互并测试状态流
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-before_model_callback" class="md-nav__link">
    <span class="md-ellipsis">
      第5步：添加安全性 - 使用before_model_callback的输入防护
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第5步：添加安全性 - 使用before_model_callback的输入防护">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_3" class="md-nav__link">
    <span class="md-ellipsis">
      1. 定义防护回调函数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_4" class="md-nav__link">
    <span class="md-ellipsis">
      2. 更新根智能体使用回调
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_2" class="md-nav__link">
    <span class="md-ellipsis">
      3. 交互测试防护
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="adk">构建你的第一个智能体团队：基于ADK的渐进式天气机器人</h1>
<!-- 可选的外层容器，用于整体内边距/间距控制 -->
<div style="margin-bottom: 10px;">
    <a href="https://colab.research.google.com/github/google/adk-docs/blob/main/examples/python/notebooks/adk_tutorial.ipynb" target="_blank" style="display: inline-flex; align-items: center; gap: 5px; text-decoration: none; color: #4285F4;">
      <img width="32px" src="https://www.gstatic.com/pantheon/images/bigquery/welcome_page/colab-logo.svg" alt="Google Colaboratory logo">
      <span>Open in Colab</span>
    </a>
  </div>

<!-- 第二行：分享链接 -->
<!-- 这个div作为"分享到"文本和图标的弹性容器 -->
<div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
    <!-- Share Text -->
    <span style="font-weight: bold;">Share to:</span>

    <!-- Social Media Links -->
    <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A//github.com/google/adk-docs/blob/main/examples/python/notebooks/adk_tutorial.ipynb" target="_blank" title="Share on LinkedIn">
      <img width="20px" src="https://upload.wikimedia.org/wikipedia/commons/8/81/LinkedIn_icon.svg" alt="LinkedIn logo" style="vertical-align: middle;">
    </a>
    <a href="https://bsky.app/intent/compose?text=https%3A//github.com/google/adk-docs/blob/main/examples/python/notebooks/adk_tutorial.ipynb" target="_blank" title="分享至Bluesky">
      <img width="20px" src="https://upload.wikimedia.org/wikipedia/commons/7/7a/Bluesky_Logo.svg" alt="Bluesky logo" style="vertical-align: middle;">
    </a>
    <a href="https://twitter.com/intent/tweet?url=https%3A//github.com/google/adk-docs/blob/main/examples/python/notebooks/adk_tutorial.ipynb" target="_blank" title="分享至X（推特）">
      <img width="20px" src="https://upload.wikimedia.org/wikipedia/commons/5/5a/X_icon_2.svg" alt="X logo" style="vertical-align: middle;">
    </a>
    <a href="https://reddit.com/submit?url=https%3A//github.com/google/adk-docs/blob/main/examples/python/notebooks/adk_tutorial.ipynb" target="_blank" title="分享至Reddit">
      <img width="20px" src="https://redditinc.com/hubfs/Reddit%20Inc/Brand/Reddit_Logo.png" alt="Reddit logo" style="vertical-align: middle;">
    </a>
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//github.com/google/adk-docs/blob/main/examples/python/notebooks/adk_tutorial.ipynb" target="_blank" title="分享至Facebook">
      <img width="20px" src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="Facebook logo" style="vertical-align: middle;">
    </a>
  </div>

<p></div>
本教程基于<a href="https://google.github.io/adk-docs/get-started/">Agent Development Kit</a>的<a href="https://google.github.io/adk-docs/get-started/quickstart/">快速入门示例</a>扩展而来。现在，你已经准备好深入探索并构建一个更复杂的<strong>多智能体系统</strong>了。</p>
<p>我们将着手构建一个<strong>天气机器人智能体团队</strong>，在简单基础上逐步叠加高级功能。从一个能查询天气的单一智能体开始，我们将逐步添加以下能力：</p>
<ul>
<li>利用不同AI模型（Gemini、GPT、Claude）  </li>
<li>为不同任务设计专用子智能体（如问候和告别）  </li>
<li>实现智能体间的智能委派  </li>
<li>通过持久会话状态赋予智能体记忆能力  </li>
<li>使用回调函数实现关键安全防护机制  </li>
</ul>
<p><strong>为什么选择天气机器人团队？</strong></p>
<p>这个看似简单的用例，提供了一个实用且易于理解的场景，来探索构建复杂现实世界智能应用所需的核心ADK概念。你将学习如何构建交互结构、管理状态、确保安全性，以及协调多个AI"大脑"协同工作。</p>
<p><strong>再认识一下ADK</strong></p>
<p>ADK是一个Python框架，旨在简化基于大模型(LLMs)的应用开发。它提供了强大的构建模块，用于创建能够推理、规划、使用工具、与用户动态交互，并在团队中有效协作的智能体。</p>
<p><strong>在本进阶教程中，你将掌握：</strong></p>
<ul>
<li>✅ <strong>工具定义与使用</strong>：编写Python函数(<code>tools</code>)，赋予智能体特定能力（如获取数据），并指导智能体如何有效使用它们  </li>
<li>✅ <strong>多模型灵活性</strong>：通过LiteLLM集成配置智能体使用各种主流大模型（Gemini、GPT-4o、Claude Sonnet），让你能为每项任务选择最佳模型  </li>
<li>✅ <strong>智能体委派与协作</strong>：设计专用子智能体，实现用户请求在团队内自动路由(<code>auto flow</code>)到最合适的智能体  </li>
<li>✅ <strong>会话状态记忆</strong>：使用<code>Session State</code>和<code>ToolContext</code>让智能体记住跨对话轮次的信息，实现更具上下文感知的交互  </li>
<li>✅ <strong>回调安全防护</strong>：实现<code>before_model_callback</code>和<code>before_tool_callback</code>来检查、修改或基于预定义规则阻止请求/工具使用，增强应用安全性和控制力  </li>
</ul>
<p><strong>最终成果预期：</strong></p>
<p>完成本教程后，你将构建一个功能完善的多智能体天气机器人系统。该系统不仅能提供天气信息，还能处理礼貌对话、记住上次查询的城市，并在定义的安全边界内运行，所有功能都通过ADK协调实现。</p>
<p><strong>先决条件：</strong></p>
<ul>
<li>✅ <strong>扎实的Python编程基础</strong>  </li>
<li>✅ <strong>熟悉大模型(LLMs)、API和智能体概念</strong>  </li>
<li>❗ <strong>关键要求：完成ADK快速入门教程或具备同等ADK基础知识（Agent、Runner、SessionService、基本工具使用）</strong>。本教程直接基于这些概念构建  </li>
<li>✅ <strong>计划使用的大模型API密钥</strong>（如Google AI Studio的Gemini、OpenAI Platform、Anthropic Console）</li>
</ul>
<p><strong>准备好构建你的智能体团队了吗？让我们开始吧！</strong></p>
<h2 id="0">第0步：设置与安装</h2>
<h3 id="_1">库安装</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>!pip install google-adk -q
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>!pip install litellm -q
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>print(&quot;Installation complete.&quot;)
</span></code></pre></div>
<h3 id="_2">导入库</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>import os
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>import asyncio
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>from google.adk.agents import Agent
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>from google.adk.models.lite_llm import LiteLlm # For multi-model support
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>from google.adk.sessions import InMemorySessionService
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>from google.adk.runners import Runner
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>from google.genai import types # For creating message Content/Parts
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>import warnings
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a># Ignore all warnings
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>warnings.filterwarnings(&quot;ignore&quot;)
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>import logging
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>logging.basicConfig(level=logging.ERROR)
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>print(&quot;Libraries imported.&quot;)
</span></code></pre></div>
<h3 id="api">设置API密钥</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a># --- IMPORTANT: Replace placeholders with your real API keys ---
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a># Gemini API Key (Get from Google AI Studio: https://aistudio.google.com/app/apikey)
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>os.environ[&quot;GOOGLE_API_KEY&quot;] = &quot;YOUR_GOOGLE_API_KEY&quot; # &lt;--- REPLACE
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a># OpenAI API Key (Get from OpenAI Platform: https://platform.openai.com/api-keys)
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>os.environ[&#39;OPENAI_API_KEY&#39;] = &#39;YOUR_OPENAI_API_KEY&#39; # &lt;--- REPLACE
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a># Anthropic API Key (Get from Anthropic Console: https://console.anthropic.com/settings/keys)
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>os.environ[&#39;ANTHROPIC_API_KEY&#39;] = &#39;YOUR_ANTHROPIC_API_KEY&#39; # &lt;--- REPLACE
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a># --- Verify Keys (Optional Check) ---
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>print(&quot;API Keys Set:&quot;)
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>print(f&quot;Google API Key set: {&#39;Yes&#39; if os.environ.get(&#39;GOOGLE_API_KEY&#39;) and os.environ[&#39;GOOGLE_API_KEY&#39;] != &#39;YOUR_GOOGLE_API_KEY&#39; else &#39;No (REPLACE PLACEHOLDER!)&#39;}&quot;)
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>print(f&quot;OpenAI API Key set: {&#39;Yes&#39; if os.environ.get(&#39;OPENAI_API_KEY&#39;) and os.environ[&#39;OPENAI_API_KEY&#39;] != &#39;YOUR_OPENAI_API_KEY&#39; else &#39;No (REPLACE PLACEHOLDER!)&#39;}&quot;)
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>print(f&quot;Anthropic API Key set: {&#39;Yes&#39; if os.environ.get(&#39;ANTHROPIC_API_KEY&#39;) and os.environ[&#39;ANTHROPIC_API_KEY&#39;] != &#39;YOUR_ANTHROPIC_API_KEY&#39; else &#39;No (REPLACE PLACEHOLDER!)&#39;}&quot;)
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a># Configure ADK to use API keys directly (not Vertex AI for this multi-model setup)
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>os.environ[&quot;GOOGLE_GENAI_USE_VERTEXAI&quot;] = &quot;False&quot;
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a># @markdown **Security Note:** It&#39;s best practice to manage API keys securely (e.g., using Colab Secrets or environment variables) rather than hardcoding them directly in the notebook. Replace the placeholder strings above.
</span></code></pre></div>
<h3 id="_3">定义模型常量以便使用</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>MODEL_GEMINI_2_0_FLASH = &quot;gemini-2.0-flash&quot;
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a># Note: Specific model names might change. Refer to LiteLLM or the model provider&#39;s documentation.
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>MODEL_GPT_4O = &quot;openai/gpt-4o&quot;
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>MODEL_CLAUDE_SONNET = &quot;anthropic/claude-3-sonnet-20240229&quot;
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>print(&quot;\nEnvironment configured.&quot;)
</span></code></pre></div>
<h2 id="1-">第1步：你的第一个智能体 - 基础天气查询</h2>
<p>让我们从构建天气机器人的基础组件开始：一个能执行特定任务（查询天气信息）的单一智能体。这需要创建两个核心部分：</p>
<ol>
<li><strong>工具</strong>：一个Python函数，赋予智能体获取天气数据的<em>能力</em>  </li>
<li><strong>智能体</strong>：理解用户请求、知道自己有天气工具，并决定何时及如何使用该工具的AI"大脑"</li>
</ol>
<hr />
<h3 id="1"><strong>1. 定义工具</strong></h3>
<p>在ADK中，<strong>工具</strong>是赋予智能体超越文本生成的具体能力的构建块。它们通常是执行特定操作的常规Python函数，如调用API、查询数据库或执行计算。</p>
<p>我们的第一个工具将提供<em>模拟</em>天气报告。这让我们可以专注于智能体结构，而无需外部API密钥。之后，你可以轻松将这个模拟函数替换为调用真实天气服务的函数。</p>
<p><strong>关键概念：文档字符串至关重要！</strong> 智能体的大模型严重依赖函数的<strong>文档字符串</strong>来理解：</p>
<ul>
<li>工具<em>做什么</em>  </li>
<li><em>何时</em>使用它  </li>
<li>它需要<em>什么参数</em>(<code>city: str</code>)  </li>
<li>它返回<em>什么信息</em></li>
</ul>
<p><strong>最佳实践</strong>：为工具编写清晰、描述性强且准确的文档字符串。这对大模型正确使用工具至关重要。</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># @title Define the get_weather Tool</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_weather</span><span class="p">(</span><span class="n">city</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves the current weather report for a specified city.</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="sd">    Args:</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="sd">        city (str): The name of the city (e.g., &quot;New York&quot;, &quot;London&quot;, &quot;Tokyo&quot;).</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="sd">    Returns:</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="sd">        dict: A dictionary containing the weather information.</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="sd">              Includes a &#39;status&#39; key (&#39;success&#39; or &#39;error&#39;).</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="sd">              If &#39;success&#39;, includes a &#39;report&#39; key with weather details.</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="sd">              If &#39;error&#39;, includes an &#39;error_message&#39; key.</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="c1"># Best Practice: Log tool execution for easier debugging</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: get_weather called for city: </span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>    <span class="n">city_normalized</span> <span class="o">=</span> <span class="n">city</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># Basic input normalization</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>    <span class="c1"># Mock weather data for simplicity</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>    <span class="n">mock_weather_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>        <span class="s2">&quot;newyork&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="s2">&quot;The weather in New York is sunny with a temperature of 25°C.&quot;</span><span class="p">},</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>        <span class="s2">&quot;london&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="s2">&quot;It&#39;s cloudy in London with a temperature of 15°C.&quot;</span><span class="p">},</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>        <span class="s2">&quot;tokyo&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="s2">&quot;Tokyo is experiencing light rain and a temperature of 18°C.&quot;</span><span class="p">},</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>    <span class="p">}</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>    <span class="c1"># Best Practice: Handle potential errors gracefully within the tool</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>    <span class="k">if</span> <span class="n">city_normalized</span> <span class="ow">in</span> <span class="n">mock_weather_db</span><span class="p">:</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>        <span class="k">return</span> <span class="n">mock_weather_db</span><span class="p">[</span><span class="n">city_normalized</span><span class="p">]</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Sorry, I don&#39;t have weather information for &#39;</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">}</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a><span class="c1"># Example tool usage (optional self-test)</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a><span class="nb">print</span><span class="p">(</span><span class="n">get_weather</span><span class="p">(</span><span class="s2">&quot;New York&quot;</span><span class="p">))</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a><span class="nb">print</span><span class="p">(</span><span class="n">get_weather</span><span class="p">(</span><span class="s2">&quot;Paris&quot;</span><span class="p">))</span>
</span></code></pre></div>
<hr />
<h3 id="2"><strong>2. 定义智能体</strong></h3>
<p>现在，让我们创建<strong>智能体</strong>本身。ADK中的<code>Agent</code>协调用户、大模型和可用工具之间的交互。</p>
<p>我们通过几个关键参数配置它：</p>
<ul>
<li><code>name</code>：该智能体的唯一标识符（如"weather_agent_v1"）  </li>
<li><code>model</code>：指定使用哪个大模型（如<code>MODEL_GEMINI_2_5_PRO</code>）。我们从特定的Gemini模型开始  </li>
<li><code>description</code>：智能体整体用途的简明摘要。这在其他智能体需要决定是否将任务委派给<em>此</em>智能体时变得至关重要  </li>
<li><code>instruction</code>：详细指导大模型如何行为、其角色、目标，特别是<em>如何及何时</em>使用其分配的<code>tools</code>  </li>
<li><code>tools</code>：包含智能体允许使用的实际Python工具函数的列表（如<code>[get_weather]</code>）</li>
</ul>
<p><strong>最佳实践</strong>：提供清晰具体的<code>instruction</code>提示。指令越详细，大模型越能理解其角色和如何有效使用工具。如果需要，明确说明错误处理。</p>
<p><strong>最佳实践</strong>：选择描述性的<code>name</code>和<code>description</code>值。这些由ADK内部使用，对自动委派等功能至关重要（稍后介绍）。</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># @title Define the Weather Agent</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="c1"># Use one of the model constants defined earlier</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">AGENT_MODEL</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_5_PRO</span> <span class="c1"># Starting with a powerful Gemini model</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="n">weather_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_v1&quot;</span><span class="p">,</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="n">model</span><span class="o">=</span><span class="n">AGENT_MODEL</span><span class="p">,</span> <span class="c1"># Specifies the underlying LLM</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Provides weather information for specific cities.&quot;</span><span class="p">,</span> <span class="c1"># Crucial for delegation later</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are a helpful weather assistant. Your primary goal is to provide current weather reports. &quot;</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>                <span class="s2">&quot;When the user asks for the weather in a specific city, &quot;</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>                <span class="s2">&quot;you MUST use the &#39;get_weather&#39; tool to find the information. &quot;</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>                <span class="s2">&quot;Analyze the tool&#39;s response: if the status is &#39;error&#39;, inform the user politely about the error message. &quot;</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>                <span class="s2">&quot;If the status is &#39;success&#39;, present the weather &#39;report&#39; clearly and concisely to the user. &quot;</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>                <span class="s2">&quot;Only use the tool when a city is mentioned for a weather request.&quot;</span><span class="p">,</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather</span><span class="p">],</span> <span class="c1"># Make the tool available to this agent</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="p">)</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent &#39;</span><span class="si">{</span><span class="n">weather_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using model &#39;</span><span class="si">{</span><span class="n">AGENT_MODEL</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="3-runnersession-service"><strong>3. 设置Runner和Session Service</strong></h3>
<p>为了管理对话和执行智能体，我们还需要两个组件：</p>
<ul>
<li><code>SessionService</code>：负责管理不同用户和会话的对话历史和状态。<code>InMemorySessionService</code>是一个简单实现，将所有内容存储在内存中，适合测试和简单应用。它跟踪交换的消息。我们将在第4步进一步探索状态持久化  </li>
<li><code>Runner</code>：协调交互流程的引擎。它接收用户输入，将其路由到适当的智能体，根据智能体逻辑管理对大模型和工具的调用，通过<code>SessionService</code>处理会话更新，并生成表示交互进度的事件</li>
</ul>
<div class="language-py highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># @title Setup Session Service and Runner</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="c1"># --- Session Management ---</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="c1"># Key Concept: SessionService stores conversation history &amp; state.</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="c1"># InMemorySessionService is simple, non-persistent storage for this tutorial.</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="n">session_service</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="c1"># Define constants for identifying the interaction context</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="n">APP_NAME</span> <span class="o">=</span> <span class="s2">&quot;weather_tutorial_app&quot;</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="n">USER_ID</span> <span class="o">=</span> <span class="s2">&quot;user_1&quot;</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="n">SESSION_ID</span> <span class="o">=</span> <span class="s2">&quot;session_001&quot;</span> <span class="c1"># Using a fixed ID for simplicity</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="c1"># Create the specific session where the conversation will happen</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="n">session</span> <span class="o">=</span> <span class="n">session_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>    <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>    <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>    <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="p">)</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session created: App=&#39;</span><span class="si">{</span><span class="n">APP_NAME</span><span class="si">}</span><span class="s2">&#39;, User=&#39;</span><span class="si">{</span><span class="n">USER_ID</span><span class="si">}</span><span class="s2">&#39;, Session=&#39;</span><span class="si">{</span><span class="n">SESSION_ID</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="c1"># --- Runner ---</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="c1"># Key Concept: Runner orchestrates the agent execution loop.</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="n">runner</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>    <span class="n">agent</span><span class="o">=</span><span class="n">weather_agent</span><span class="p">,</span> <span class="c1"># The agent we want to run</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>    <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>   <span class="c1"># Associates runs with our app</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>    <span class="n">session_service</span><span class="o">=</span><span class="n">session_service</span> <span class="c1"># Uses our session manager</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="p">)</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runner created for agent &#39;</span><span class="si">{</span><span class="n">runner</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="4"><strong>4. 与智能体交互</strong></h3>
<p>我们需要一种向智能体发送消息并接收其响应的方法。由于大模型调用和工具执行可能需要时间，ADK的<code>Runner</code>异步运行。</p>
<p>我们将定义一个<code>async</code>辅助函数(<code>call_agent_async</code>)，该函数：</p>
<ol>
<li>接收用户查询字符串  </li>
<li>将其打包为ADK <code>Content</code>格式  </li>
<li>调用<code>runner.run_async</code>，提供用户/会话上下文和新消息  </li>
<li>遍历runner生成的<strong>事件</strong>。事件表示智能体执行中的步骤（如请求工具调用、接收工具结果、中间大模型思考、最终响应）  </li>
<li>使用<code>event.is_final_response()</code>识别并打印<strong>最终响应</strong>事件</li>
</ol>
<p><strong>为什么使用<code>async</code>？</strong> 与大模型和潜在工具（如外部API）的交互是I/O密集型操作。使用<code>asyncio</code>允许程序高效处理这些操作而不会阻塞执行。</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># @title Define Agent Interaction Function</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.genai</span><span class="w"> </span><span class="kn">import</span> <span class="n">types</span> <span class="c1"># For creating message Content/Parts</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;Sends a query to the agent and prints the final response.&quot;&quot;&quot;</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&gt;&gt;&gt; User Query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>  <span class="c1"># Prepare the user&#39;s message in ADK format</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>  <span class="n">content</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">query</span><span class="p">)])</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>  <span class="n">final_response_text</span> <span class="o">=</span> <span class="s2">&quot;Agent did not produce a final response.&quot;</span> <span class="c1"># Default</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>  <span class="c1"># Key Concept: run_async executes the agent logic and yields Events.</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>  <span class="c1"># We iterate through events to find the final answer.</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>  <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">,</span> <span class="n">new_message</span><span class="o">=</span><span class="n">content</span><span class="p">):</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>      <span class="c1"># You can uncomment the line below to see *all* events during execution</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>      <span class="c1"># print(f&quot;  [Event] Author: {event.author}, Type: {type(event).__name__}, Final: {event.is_final_response()}, Content: {event.content}&quot;)</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>      <span class="c1"># Key Concept: is_final_response() marks the concluding message for the turn.</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>      <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_final_response</span><span class="p">():</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>          <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>             <span class="c1"># Assuming text response in the first part</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>             <span class="n">final_response_text</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>          <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">actions</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">escalate</span><span class="p">:</span> <span class="c1"># Handle potential errors/escalations</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>             <span class="n">final_response_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Agent escalated: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">error_message</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;No specific message.&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>          <span class="c1"># Add more checks here if needed (e.g., specific error codes)</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>          <span class="k">break</span> <span class="c1"># Stop processing events once the final response is found</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;&lt;&lt; Agent Response: </span><span class="si">{</span><span class="n">final_response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="5"><strong>5. 运行对话</strong></h3>
<p>最后，让我们通过向智能体发送几个查询来测试我们的设置。我们将<code>async</code>调用包装在主要的<code>async</code>函数中，并使用<code>await</code>运行它。</p>
<p>观察输出：</p>
<ul>
<li>查看用户查询  </li>
<li>注意智能体使用工具时的<code>--- Tool: get_weather called... ---</code>日志  </li>
<li>观察智能体的最终响应，包括它如何处理巴黎天气数据不可用的情况</li>
</ul>
<div class="language-py highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># @title Run the Initial Conversation</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="c1"># We need an async function to await our interaction helper</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_conversation</span><span class="p">():</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="s2">&quot;What is the weather like in London?&quot;</span><span class="p">)</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="s2">&quot;How about Paris?&quot;</span><span class="p">)</span> <span class="c1"># Expecting the tool&#39;s error message</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="s2">&quot;Tell me the weather in New York&quot;</span><span class="p">)</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="c1"># Execute the conversation using await in an async context (like Colab/Jupyter)</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="k">await</span> <span class="n">run_conversation</span><span class="p">()</span>
</span></code></pre></div>
<p><strong>预期输出：</strong></p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="go">&gt;&gt;&gt; User Query: What is the weather like in London?</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="go">--- Tool: get_weather called for city: London ---</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="go">&lt;&lt;&lt; Agent Response: The weather in London is cloudy with a temperature of 15°C.</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="go">&gt;&gt;&gt; User Query: How about Paris?</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="go">--- Tool: get_weather called for city: Paris ---</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="go">&lt;&lt;&lt; Agent Response: Sorry, I don&#39;t have weather information for Paris.</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="go">&gt;&gt;&gt; User Query: Tell me the weather in New York</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="go">--- Tool: get_weather called for city: New York ---</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="go">&lt;&lt;&lt; Agent Response: The weather in New York is sunny with a temperature of 25°C.</span>
</span></code></pre></div>
<hr />
<p>恭喜！你已成功构建并与你的第一个ADK智能体进行了交互。它能理解用户请求，使用工具查找信息，并根据工具结果做出适当响应。</p>
<p>下一步，我们将探索如何轻松切换支撑该智能体的底层语言模型。</p>
<h2 id="2litellm">第2步：使用LiteLLM实现多模型支持</h2>
<p>在第1步中，我们构建了一个由特定Gemini模型驱动的功能性天气智能体。虽然有效，但现实世界的应用通常受益于使用<em>不同</em>大模型(LLMs)的灵活性。为什么？</p>
<ul>
<li><strong>性能</strong>：某些模型擅长特定任务（如编码、推理、创意写作）  </li>
<li><strong>成本</strong>：不同模型有不同价格点  </li>
<li><strong>能力</strong>：模型提供多样化功能、上下文窗口大小和微调选项  </li>
<li><strong>可用性/冗余</strong>：拥有备选方案确保即使一个提供商出现问题，你的应用仍能正常运行  </li>
</ul>
<p>ADK通过与<a href="https://github.com/BerriAI/litellm"><strong>LiteLLM</strong></a>库的集成，使模型切换变得无缝。LiteLLM作为100多种不同大模型的一致接口。</p>
<p><strong>在本步骤中，我们将：</strong></p>
<ol>
<li>学习如何配置ADK <code>Agent</code>使用OpenAI(GPT)和Anthropic(Claude)等提供商的模型，使用<code>LiteLlm</code>包装器  </li>
<li>定义、配置（使用它们自己的会话和runner）并立即测试我们的天气智能体实例，每个实例由不同大模型支持  </li>
<li>与这些不同智能体交互，观察即使使用相同底层工具，它们的响应也可能存在差异  </li>
</ol>
<hr />
<h3 id="1-litellm"><strong>1. 导入<code>LiteLlm</code></strong></h3>
<p>我们在初始设置（第0步）中已导入此组件，但它是多模型支持的关键：</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># Ensure this import is present from your setup cells</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.lite_llm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiteLlm</span>
</span></code></pre></div>
<hr />
<h3 id="2_1"><strong>2. 定义并测试多模型智能体</strong></h3>
<p>我们不再仅传递模型名称字符串（默认为Google的Gemini模型），而是将所需的模型标识符字符串包装在<code>LiteLlm</code>类中。</p>
<ul>
<li><strong>关键概念：<code>LiteLlm</code>包装器</strong>：<code>LiteLlm(model="provider/model_name")</code>语法告诉ADK通过LiteLLM库将该智能体的请求路由到指定的模型提供商  </li>
</ul>
<p>确保你已在第0步配置了OpenAI和Anthropic的必要API密钥。我们将使用之前定义的<code>call_agent_async</code>函数（现在接受<code>runner</code>、<code>user_id</code>和<code>session_id</code>）在设置后立即与每个智能体交互。</p>
<p>下面的每个代码块将：
* 使用特定的LiteLLM模型(<code>MODEL_GPT_4O</code>或<code>MODEL_CLAUDE_SONNET</code>)定义智能体<br />
<em> 为该智能体的测试运行创建</em>新的独立<em><code>InMemorySessionService</code>和会话。这为本次演示保持对话历史的隔离<br />
</em> 创建配置给特定智能体及其会话服务的<code>Runner</code><br />
* 立即调用<code>call_agent_async</code>发送查询并测试智能体  </p>
<p><strong>最佳实践</strong>：使用常量表示模型名称（如第0步定义的<code>MODEL_GPT_4O</code>、<code>MODEL_CLAUDE_SONNET</code>），避免拼写错误并使代码更易管理  </p>
<p><strong>错误处理</strong>：我们将智能体定义包装在<code>try...except</code>块中。这防止整个代码单元因特定提供商的API密钥缺失或无效而失败，允许教程继续使用<em>已配置</em>的模型进行  </p>
<p>首先，让我们创建并测试使用OpenAI的GPT-4o的智能体。</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># @title Define and Test GPT Agent</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="c1"># Make sure &#39;get_weather&#39; function from Step 1 is defined in your environment.</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="c1"># Make sure &#39;call_agent_async&#39; is defined from earlier.</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="c1"># --- Agent using GPT-4o ---</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="n">weather_agent_gpt</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Initialize to None</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="n">runner_gpt</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># Initialize runner to None</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="n">weather_agent_gpt</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_gpt&quot;</span><span class="p">,</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>        <span class="c1"># Key change: Wrap the LiteLLM model identifier</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>        <span class="n">model</span><span class="o">=</span><span class="n">LiteLlm</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">MODEL_GPT_4O</span><span class="p">),</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Provides weather information (using GPT-4o).&quot;</span><span class="p">,</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are a helpful weather assistant powered by GPT-4o. &quot;</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>                    <span class="s2">&quot;Use the &#39;get_weather&#39; tool for city weather requests. &quot;</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>                    <span class="s2">&quot;Clearly present successful reports or polite error messages based on the tool&#39;s output status.&quot;</span><span class="p">,</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather</span><span class="p">],</span> <span class="c1"># Re-use the same tool</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>    <span class="p">)</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent &#39;</span><span class="si">{</span><span class="n">weather_agent_gpt</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using model &#39;</span><span class="si">{</span><span class="n">MODEL_GPT_4O</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>    <span class="c1"># InMemorySessionService is simple, non-persistent storage for this tutorial.</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>    <span class="n">session_service_gpt</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span> <span class="c1"># Create a dedicated service</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>    <span class="c1"># Define constants for identifying the interaction context</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>    <span class="n">APP_NAME_GPT</span> <span class="o">=</span> <span class="s2">&quot;weather_tutorial_app_gpt&quot;</span> <span class="c1"># Unique app name for this test</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>    <span class="n">USER_ID_GPT</span> <span class="o">=</span> <span class="s2">&quot;user_1_gpt&quot;</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>    <span class="n">SESSION_ID_GPT</span> <span class="o">=</span> <span class="s2">&quot;session_001_gpt&quot;</span> <span class="c1"># Using a fixed ID for simplicity</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>    <span class="c1"># Create the specific session where the conversation will happen</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>    <span class="n">session_gpt</span> <span class="o">=</span> <span class="n">session_service_gpt</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>        <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME_GPT</span><span class="p">,</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>        <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_GPT</span><span class="p">,</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>        <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_GPT</span>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>    <span class="p">)</span>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session created: App=&#39;</span><span class="si">{</span><span class="n">APP_NAME_GPT</span><span class="si">}</span><span class="s2">&#39;, User=&#39;</span><span class="si">{</span><span class="n">USER_ID_GPT</span><span class="si">}</span><span class="s2">&#39;, Session=&#39;</span><span class="si">{</span><span class="n">SESSION_ID_GPT</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>    <span class="c1"># Create a runner specific to this agent and its session service</span>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a>    <span class="n">runner_gpt</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>        <span class="n">agent</span><span class="o">=</span><span class="n">weather_agent_gpt</span><span class="p">,</span>
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a>        <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME_GPT</span><span class="p">,</span>       <span class="c1"># Use the specific app name</span>
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a>        <span class="n">session_service</span><span class="o">=</span><span class="n">session_service_gpt</span> <span class="c1"># Use the specific session service</span>
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a>        <span class="p">)</span>
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runner created for agent &#39;</span><span class="si">{</span><span class="n">runner_gpt</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a>
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a>    <span class="c1"># --- Test the GPT Agent ---</span>
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing GPT Agent ---&quot;</span><span class="p">)</span>
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a>    <span class="c1"># Ensure call_agent_async uses the correct runner, user_id, session_id</span>
</span><span id="__span-11-50"><a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a>    <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;What&#39;s the weather in Tokyo?&quot;</span><span class="p">,</span>
</span><span id="__span-11-51"><a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a>                           <span class="n">runner</span><span class="o">=</span><span class="n">runner_gpt</span><span class="p">,</span>
</span><span id="__span-11-52"><a id="__codelineno-11-52" name="__codelineno-11-52" href="#__codelineno-11-52"></a>                           <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_GPT</span><span class="p">,</span>
</span><span id="__span-11-53"><a id="__codelineno-11-53" name="__codelineno-11-53" href="#__codelineno-11-53"></a>                           <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_GPT</span><span class="p">)</span>
</span><span id="__span-11-54"><a id="__codelineno-11-54" name="__codelineno-11-54" href="#__codelineno-11-54"></a>
</span><span id="__span-11-55"><a id="__codelineno-11-55" name="__codelineno-11-55" href="#__codelineno-11-55"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-11-56"><a id="__codelineno-11-56" name="__codelineno-11-56" href="#__codelineno-11-56"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not create or run GPT agent &#39;</span><span class="si">{</span><span class="n">MODEL_GPT_4O</span><span class="si">}</span><span class="s2">&#39;. Check API Key and model name. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>接下来，我们对Anthropic的Claude Sonnet做同样操作。</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># @title Define and Test Claude Agent</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="c1"># Make sure &#39;get_weather&#39; function from Step 1 is defined in your environment.</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="c1"># Make sure &#39;call_agent_async&#39; is defined from earlier.</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="c1"># --- Agent using Claude Sonnet ---</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="n">weather_agent_claude</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Initialize to None</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="n">runner_claude</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># Initialize runner to None</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>    <span class="n">weather_agent_claude</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_claude&quot;</span><span class="p">,</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>        <span class="c1"># Key change: Wrap the LiteLLM model identifier</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>        <span class="n">model</span><span class="o">=</span><span class="n">LiteLlm</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">MODEL_CLAUDE_SONNET</span><span class="p">),</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Provides weather information (using Claude Sonnet).&quot;</span><span class="p">,</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are a helpful weather assistant powered by Claude Sonnet. &quot;</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>                    <span class="s2">&quot;Use the &#39;get_weather&#39; tool for city weather requests. &quot;</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>                    <span class="s2">&quot;Analyze the tool&#39;s dictionary output (&#39;status&#39;, &#39;report&#39;/&#39;error_message&#39;). &quot;</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>                    <span class="s2">&quot;Clearly present successful reports or polite error messages.&quot;</span><span class="p">,</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather</span><span class="p">],</span> <span class="c1"># Re-use the same tool</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>    <span class="p">)</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Agent &#39;</span><span class="si">{</span><span class="n">weather_agent_claude</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using model &#39;</span><span class="si">{</span><span class="n">MODEL_CLAUDE_SONNET</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>    <span class="c1"># InMemorySessionService is simple, non-persistent storage for this tutorial.</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>    <span class="n">session_service_claude</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span> <span class="c1"># Create a dedicated service</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>    <span class="c1"># Define constants for identifying the interaction context</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>    <span class="n">APP_NAME_CLAUDE</span> <span class="o">=</span> <span class="s2">&quot;weather_tutorial_app_claude&quot;</span> <span class="c1"># Unique app name</span>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>    <span class="n">USER_ID_CLAUDE</span> <span class="o">=</span> <span class="s2">&quot;user_1_claude&quot;</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>    <span class="n">SESSION_ID_CLAUDE</span> <span class="o">=</span> <span class="s2">&quot;session_001_claude&quot;</span> <span class="c1"># Using a fixed ID for simplicity</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>    <span class="c1"># Create the specific session where the conversation will happen</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>    <span class="n">session_claude</span> <span class="o">=</span> <span class="n">session_service_claude</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>        <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME_CLAUDE</span><span class="p">,</span>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>        <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_CLAUDE</span><span class="p">,</span>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a>        <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_CLAUDE</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>    <span class="p">)</span>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session created: App=&#39;</span><span class="si">{</span><span class="n">APP_NAME_CLAUDE</span><span class="si">}</span><span class="s2">&#39;, User=&#39;</span><span class="si">{</span><span class="n">USER_ID_CLAUDE</span><span class="si">}</span><span class="s2">&#39;, Session=&#39;</span><span class="si">{</span><span class="n">SESSION_ID_CLAUDE</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a>    <span class="c1"># Create a runner specific to this agent and its session service</span>
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a>    <span class="n">runner_claude</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a>        <span class="n">agent</span><span class="o">=</span><span class="n">weather_agent_claude</span><span class="p">,</span>
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a>        <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME_CLAUDE</span><span class="p">,</span>       <span class="c1"># Use the specific app name</span>
</span><span id="__span-12-44"><a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a>        <span class="n">session_service</span><span class="o">=</span><span class="n">session_service_claude</span> <span class="c1"># Use the specific session service</span>
</span><span id="__span-12-45"><a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a>        <span class="p">)</span>
</span><span id="__span-12-46"><a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runner created for agent &#39;</span><span class="si">{</span><span class="n">runner_claude</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="__span-12-47"><a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a>
</span><span id="__span-12-48"><a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a>    <span class="c1"># --- Test the Claude Agent ---</span>
</span><span id="__span-12-49"><a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing Claude Agent ---&quot;</span><span class="p">)</span>
</span><span id="__span-12-50"><a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a>    <span class="c1"># Ensure call_agent_async uses the correct runner, user_id, session_id</span>
</span><span id="__span-12-51"><a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a>    <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;Weather in London please.&quot;</span><span class="p">,</span>
</span><span id="__span-12-52"><a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a>                           <span class="n">runner</span><span class="o">=</span><span class="n">runner_claude</span><span class="p">,</span>
</span><span id="__span-12-53"><a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a>                           <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_CLAUDE</span><span class="p">,</span>
</span><span id="__span-12-54"><a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a>                           <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_CLAUDE</span><span class="p">)</span>
</span><span id="__span-12-55"><a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a>
</span><span id="__span-12-56"><a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-12-57"><a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not create or run Claude agent &#39;</span><span class="si">{</span><span class="n">MODEL_CLAUDE_SONNET</span><span class="si">}</span><span class="s2">&#39;. Check API Key and model name. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>仔细观察两个代码块的输出。你应该看到：</p>
<ol>
<li>每个智能体(<code>weather_agent_gpt</code>、<code>weather_agent_claude</code>)成功创建（如果API密钥有效）  </li>
<li>为每个智能体设置了专用会话和runner  </li>
<li>每个智能体在处理查询时正确识别需要使用<code>get_weather</code>工具（你会看到<code>--- Tool: get_weather called... ---</code>日志）  </li>
<li><em>底层工具逻辑</em>保持相同，始终返回我们的模拟数据  </li>
<li>但每个智能体生成的<strong>最终文本响应</strong>可能在措辞、语气或格式上略有不同。这是因为指令提示由不同大模型(GPT-4o vs Claude Sonnet)解释执行  </li>
</ol>
<p>这一步展示了ADK + LiteLLM提供的强大功能和灵活性。你可以轻松尝试和部署使用各种大模型的智能体，同时保持核心应用逻辑（工具、基本智能体结构）一致。</p>
<p>下一步，我们将超越单一智能体，构建一个小型团队，让智能体可以相互委派任务！</p>
<hr />
<h2 id="3-">第3步：构建智能体团队 - 问候与告别的委派</h2>
<p>在第1和2步中，我们构建并实验了一个专注于天气查询的单一智能体。虽然对其特定任务有效，但现实世界的应用通常涉及处理更广泛的用户交互。我们可以继续向单一天气智能体添加更多工具和复杂指令，但这很快就会变得难以管理且效率低下。</p>
<p>更稳健的方法是构建一个<strong>智能体团队</strong>。这涉及：</p>
<ol>
<li>创建多个<strong>专用智能体</strong>，每个智能体设计用于特定能力（如一个处理天气，一个处理问候，一个处理计算）  </li>
<li>指定一个<strong>根智能体</strong>（或协调器）接收初始用户请求  </li>
<li>使根智能体能够基于用户意图将请求<strong>委派</strong>给最合适的专用子智能体  </li>
</ol>
<p><strong>为什么要构建智能体团队？</strong></p>
<ul>
<li><strong>模块化</strong>：更易于开发、测试和维护单个智能体  </li>
<li><strong>专业化</strong>：每个智能体可以针对其特定任务进行微调（指令、模型选择）  </li>
<li><strong>可扩展性</strong>：通过添加新智能体更简单地增加新能力  </li>
<li><strong>效率</strong>：允许对简单任务（如问候）使用可能更简单/更便宜的模型  </li>
</ul>
<p><strong>在本步骤中，我们将：</strong></p>
<ol>
<li>定义处理问候(<code>say_hello</code>)和告别(<code>say_goodbye</code>)的简单工具  </li>
<li>创建两个新的专用子智能体：<code>greeting_agent</code>和<code>farewell_agent</code>  </li>
<li>更新我们的主天气智能体(<code>weather_agent_v2</code>)作为<strong>根智能体</strong>  </li>
<li>用其子智能体配置根智能体，实现<strong>自动委派</strong>  </li>
<li>通过向根智能体发送不同类型的请求测试委派流程  </li>
</ol>
<hr />
<h3 id="1_1"><strong>1. 为子智能体定义工具</strong></h3>
<p>首先，让我们创建将作为新专家智能体工具的简单Python函数。记住，清晰的文档字符串对将使用它们的智能体至关重要。</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># @title Define Tools for Greeting and Farewell Agents</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="c1"># Ensure &#39;get_weather&#39; from Step 1 is available if running this step independently.</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="c1"># def get_weather(city: str) -&gt; dict: ... (from Step 1)</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">say_hello</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;there&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides a simple greeting, optionally addressing the user by name.</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="sd">    Args:</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="sd">        name (str, optional): The name of the person to greet. Defaults to &quot;there&quot;.</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="sd">    Returns:</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="sd">        str: A friendly greeting message.</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: say_hello called with name: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Hello, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">!&quot;</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="k">def</span><span class="w"> </span><span class="nf">say_goodbye</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides a simple farewell message to conclude the conversation.&quot;&quot;&quot;</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: say_goodbye called ---&quot;</span><span class="p">)</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>    <span class="k">return</span> <span class="s2">&quot;Goodbye! Have a great day.&quot;</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Greeting and Farewell tools defined.&quot;</span><span class="p">)</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="c1"># Optional self-test</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="nb">print</span><span class="p">(</span><span class="n">say_hello</span><span class="p">(</span><span class="s2">&quot;Alice&quot;</span><span class="p">))</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="nb">print</span><span class="p">(</span><span class="n">say_goodbye</span><span class="p">())</span>
</span></code></pre></div>
<hr />
<h3 id="2_2"><strong>2. 定义子智能体（问候与告别）</strong></h3>
<p>现在，为我们的专家创建<code>Agent</code>实例。注意它们高度聚焦的<code>instruction</code>，以及关键的清晰<code>description</code>。<code>description</code>是<em>根智能体</em>用来决定<em>何时</em>委派给这些子智能体的主要信息。</p>
<p>我们甚至可以为这些子智能体使用不同的大模型！让我们为问候智能体分配GPT-4o，并保持告别智能体也使用GPT-4o（如果愿意且API密钥已设置，你可以轻松切换其中一个使用Claude或Gemini）。</p>
<p><strong>最佳实践</strong>：子智能体的<code>description</code>字段应准确简洁地总结其特定能力。这对有效的自动委派至关重要。</p>
<p><strong>最佳实践</strong>：子智能体的<code>instruction</code>字段应针对其有限范围定制，明确告诉它们该做什么和<em>不该</em>做什么（如"你的<em>唯一</em>任务是..."）。</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># @title Define Greeting and Farewell Sub-Agents</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="c1"># Ensure LiteLlm is imported and API keys are set (from Step 0/2)</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="c1"># from google.adk.models.lite_llm import LiteLlm</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="c1"># MODEL_GPT_4O, MODEL_CLAUDE_SONNET etc. should be defined</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="c1"># --- Greeting Agent ---</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="n">greeting_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>    <span class="n">greeting_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>        <span class="c1"># Using a potentially different/cheaper model for a simple task</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>        <span class="n">model</span><span class="o">=</span><span class="n">LiteLlm</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">MODEL_GPT_4O</span><span class="p">),</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;greeting_agent&quot;</span><span class="p">,</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Greeting Agent. Your ONLY task is to provide a friendly greeting to the user. &quot;</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>                    <span class="s2">&quot;Use the &#39;say_hello&#39; tool to generate the greeting. &quot;</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>                    <span class="s2">&quot;If the user provides their name, make sure to pass it to the tool. &quot;</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>                    <span class="s2">&quot;Do not engage in any other conversation or tasks.&quot;</span><span class="p">,</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple greetings and hellos using the &#39;say_hello&#39; tool.&quot;</span><span class="p">,</span> <span class="c1"># Crucial for delegation</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_hello</span><span class="p">],</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>    <span class="p">)</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Agent &#39;</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using model &#39;</span><span class="si">{</span><span class="n">MODEL_GPT_4O</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not create Greeting agent. Check API Key (</span><span class="si">{</span><span class="n">MODEL_GPT_4O</span><span class="si">}</span><span class="s2">). Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="c1"># --- Farewell Agent ---</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="n">farewell_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a>    <span class="n">farewell_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a>        <span class="c1"># Can use the same or a different model</span>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a>        <span class="n">model</span><span class="o">=</span><span class="n">LiteLlm</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">MODEL_GPT_4O</span><span class="p">),</span> <span class="c1"># Sticking with GPT for this example</span>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;farewell_agent&quot;</span><span class="p">,</span>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Farewell Agent. Your ONLY task is to provide a polite goodbye message. &quot;</span>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a>                    <span class="s2">&quot;Use the &#39;say_goodbye&#39; tool when the user indicates they are leaving or ending the conversation &quot;</span>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a>                    <span class="s2">&quot;(e.g., using words like &#39;bye&#39;, &#39;goodbye&#39;, &#39;thanks bye&#39;, &#39;see you&#39;). &quot;</span>
</span><span id="__span-14-35"><a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a>                    <span class="s2">&quot;Do not perform any other actions.&quot;</span><span class="p">,</span>
</span><span id="__span-14-36"><a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple farewells and goodbyes using the &#39;say_goodbye&#39; tool.&quot;</span><span class="p">,</span> <span class="c1"># Crucial for delegation</span>
</span><span id="__span-14-37"><a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_goodbye</span><span class="p">],</span>
</span><span id="__span-14-38"><a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a>    <span class="p">)</span>
</span><span id="__span-14-39"><a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Agent &#39;</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using model &#39;</span><span class="si">{</span><span class="n">MODEL_GPT_4O</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="__span-14-40"><a id="__codelineno-14-40" name="__codelineno-14-40" href="#__codelineno-14-40"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-14-41"><a id="__codelineno-14-41" name="__codelineno-14-41" href="#__codelineno-14-41"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not create Farewell agent. Check API Key (</span><span class="si">{</span><span class="n">MODEL_GPT_4O</span><span class="si">}</span><span class="s2">). Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="3"><strong>3. 定义带子智能体的根智能体</strong></h3>
<p>现在，我们升级<code>weather_agent</code>。关键变化是：</p>
<ul>
<li>添加<code>sub_agents</code>参数：我们传递包含刚创建的<code>greeting_agent</code>和<code>farewell_agent</code>实例的列表  </li>
<li>更新<code>instruction</code>：我们明确告诉根智能体<em>关于</em>其子智能体以及<em>何时</em>应将任务委派给它们  </li>
</ul>
<p><strong>关键概念：自动委派（Auto Flow）</strong> 通过提供<code>sub_agents</code>列表，ADK启用自动委派。当根智能体收到用户查询时，其大模型不仅考虑自己的指令和工具，还考虑每个子智能体的<code>description</code>。如果大模型确定查询更符合子智能体的描述能力（如"处理简单问候"），它将自动生成特殊内部动作以<em>转移控制</em>给该子智能体处理该轮次。子智能体然后使用自己的模型、指令和工具处理查询。</p>
<p><strong>最佳实践</strong>：确保根智能体的指令明确指导其委派决策。按名称提及子智能体，并描述应发生委派的条件。</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># @title Define the Root Agent with Sub-Agents</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="c1"># Ensure sub-agents were created successfully before defining the root agent.</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="c1"># Also ensure the original &#39;get_weather&#39; tool is defined.</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="n">root_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="n">runner_root</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Initialize runner</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="k">if</span> <span class="n">greeting_agent</span> <span class="ow">and</span> <span class="n">farewell_agent</span> <span class="ow">and</span> <span class="s1">&#39;get_weather&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>    <span class="c1"># Let&#39;s use a capable Gemini model for the root agent to handle orchestration</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>    <span class="n">root_agent_model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>    <span class="n">weather_agent_team</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_v2&quot;</span><span class="p">,</span> <span class="c1"># Give it a new version name</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>        <span class="n">model</span><span class="o">=</span><span class="n">root_agent_model</span><span class="p">,</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The main coordinator agent. Handles weather requests and delegates greetings/farewells to specialists.&quot;</span><span class="p">,</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the main Weather Agent coordinating a team. Your primary responsibility is to provide weather information. &quot;</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>                    <span class="s2">&quot;Use the &#39;get_weather&#39; tool ONLY for specific weather requests (e.g., &#39;weather in London&#39;). &quot;</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>                    <span class="s2">&quot;You have specialized sub-agents: &quot;</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>                    <span class="s2">&quot;1. &#39;greeting_agent&#39;: Handles simple greetings like &#39;Hi&#39;, &#39;Hello&#39;. Delegate to it for these. &quot;</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>                    <span class="s2">&quot;2. &#39;farewell_agent&#39;: Handles simple farewells like &#39;Bye&#39;, &#39;See you&#39;. Delegate to it for these. &quot;</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>                    <span class="s2">&quot;Analyze the user&#39;s query. If it&#39;s a greeting, delegate to &#39;greeting_agent&#39;. If it&#39;s a farewell, delegate to &#39;farewell_agent&#39;. &quot;</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>                    <span class="s2">&quot;If it&#39;s a weather request, handle it yourself using &#39;get_weather&#39;. &quot;</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>                    <span class="s2">&quot;For anything else, respond appropriately or state you cannot handle it.&quot;</span><span class="p">,</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather</span><span class="p">],</span> <span class="c1"># Root agent still needs the weather tool for its core task</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>        <span class="c1"># Key change: Link the sub-agents here!</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>        <span class="n">sub_agents</span><span class="o">=</span><span class="p">[</span><span class="n">greeting_agent</span><span class="p">,</span> <span class="n">farewell_agent</span><span class="p">]</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>    <span class="p">)</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Root Agent &#39;</span><span class="si">{</span><span class="n">weather_agent_team</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using model &#39;</span><span class="si">{</span><span class="n">root_agent_model</span><span class="si">}</span><span class="s2">&#39; with sub-agents: </span><span class="si">{</span><span class="p">[</span><span class="n">sa</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">weather_agent_team</span><span class="o">.</span><span class="n">sub_agents</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Cannot create root agent because one or more sub-agents failed to initialize or &#39;get_weather&#39; tool is missing.&quot;</span><span class="p">)</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">greeting_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - Greeting Agent is missing.&quot;</span><span class="p">)</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">farewell_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - Farewell Agent is missing.&quot;</span><span class="p">)</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>    <span class="k">if</span> <span class="s1">&#39;get_weather&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - get_weather function is missing.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="4_1"><strong>4. 与智能体团队交互</strong></h3>
<p>现在我们已经定义了根智能体(<code>weather_agent_team</code> - <em>注意：确保此变量名与之前代码块中定义的匹配，可能是<code># @title Define the Root Agent with Sub-Agents</code>，可能命名为<code>root_agent</code></em>)及其专用子智能体，让我们测试委派机制。</p>
<p>以下代码块将：</p>
<ol>
<li>定义<code>async</code>函数<code>run_team_conversation</code>  </li>
<li>在此函数内，为此次测试运行创建<em>新的专用</em><code>InMemorySessionService</code>和特定会话(<code>session_001_agent_team</code>)。这隔离了测试团队动态的对话历史  </li>
<li>创建<code>Runner</code>(<code>runner_agent_team</code>)，配置为使用我们的<code>weather_agent_team</code>（根智能体）和专用会话服务  </li>
<li>使用更新后的<code>call_agent_async</code>函数向<code>runner_agent_team</code>发送不同类型的查询（问候、天气请求、告别）。我们明确传递此特定测试的runner、用户ID和会话ID  </li>
<li>立即执行<code>run_team_conversation</code>函数  </li>
</ol>
<p>我们预期以下流程：</p>
<ol>
<li>"Hello there!"查询交给<code>runner_agent_team</code>  </li>
<li>根智能体(<code>weather_agent_team</code>)接收它，基于其指令和<code>greeting_agent</code>的描述委派任务  </li>
<li><code>greeting_agent</code>处理查询，调用其<code>say_hello</code>工具并生成响应  </li>
<li>"What is the weather in New York?"查询<em>不</em>委派，由根智能体直接使用其<code>get_weather</code>工具处理  </li>
<li>"Thanks, bye!"查询委派给<code>farewell_agent</code>，它使用其<code>say_goodbye</code>工具  </li>
</ol>
<div class="language-py highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># @title Interact with the Agent Team</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="c1"># Ensure the root agent (e.g., &#39;weather_agent_team&#39; or &#39;root_agent&#39; from the previous cell) is defined.</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="c1"># Ensure the call_agent_async function is defined.</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="c1"># Check if the root agent variable exists before defining the conversation function</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="n">root_agent_var_name</span> <span class="o">=</span> <span class="s1">&#39;root_agent&#39;</span> <span class="c1"># Default name from Step 3 guide</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="k">if</span> <span class="s1">&#39;weather_agent_team&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="c1"># Check if user used this name instead</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>    <span class="n">root_agent_var_name</span> <span class="o">=</span> <span class="s1">&#39;weather_agent_team&#39;</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="k">elif</span> <span class="s1">&#39;root_agent&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Root agent (&#39;root_agent&#39; or &#39;weather_agent_team&#39;) not found. Cannot define run_team_conversation.&quot;</span><span class="p">)</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>    <span class="c1"># Assign a dummy value to prevent NameError later if the code block runs anyway</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>    <span class="n">root_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="k">if</span> <span class="n">root_agent_var_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">root_agent_var_name</span><span class="p">]:</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_team_conversation</span><span class="p">():</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing Agent Team Delegation ---&quot;</span><span class="p">)</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>        <span class="c1"># InMemorySessionService is simple, non-persistent storage for this tutorial.</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>        <span class="n">session_service</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>        <span class="c1"># Define constants for identifying the interaction context</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>        <span class="n">APP_NAME</span> <span class="o">=</span> <span class="s2">&quot;weather_tutorial_agent_team&quot;</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>        <span class="n">USER_ID</span> <span class="o">=</span> <span class="s2">&quot;user_1_agent_team&quot;</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>        <span class="n">SESSION_ID</span> <span class="o">=</span> <span class="s2">&quot;session_001_agent_team&quot;</span> <span class="c1"># Using a fixed ID for simplicity</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>        <span class="c1"># Create the specific session where the conversation will happen</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>        <span class="n">session</span> <span class="o">=</span> <span class="n">session_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>            <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>            <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>            <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>        <span class="p">)</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session created: App=&#39;</span><span class="si">{</span><span class="n">APP_NAME</span><span class="si">}</span><span class="s2">&#39;, User=&#39;</span><span class="si">{</span><span class="n">USER_ID</span><span class="si">}</span><span class="s2">&#39;, Session=&#39;</span><span class="si">{</span><span class="n">SESSION_ID</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>        <span class="c1"># --- Get the actual root agent object ---</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a>        <span class="c1"># Use the determined variable name</span>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>        <span class="n">actual_root_agent</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">root_agent_var_name</span><span class="p">]</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a>        <span class="c1"># Create a runner specific to this agent team test</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a>        <span class="n">runner_agent_team</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-16-40"><a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a>            <span class="n">agent</span><span class="o">=</span><span class="n">actual_root_agent</span><span class="p">,</span> <span class="c1"># Use the root agent object</span>
</span><span id="__span-16-41"><a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a>            <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>       <span class="c1"># Use the specific app name</span>
</span><span id="__span-16-42"><a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a>            <span class="n">session_service</span><span class="o">=</span><span class="n">session_service</span> <span class="c1"># Use the specific session service</span>
</span><span id="__span-16-43"><a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a>            <span class="p">)</span>
</span><span id="__span-16-44"><a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a>        <span class="c1"># Corrected print statement to show the actual root agent&#39;s name</span>
</span><span id="__span-16-45"><a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runner created for agent &#39;</span><span class="si">{</span><span class="n">actual_root_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="__span-16-46"><a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a>
</span><span id="__span-16-47"><a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a>        <span class="c1"># Always interact via the root agent&#39;s runner, passing the correct IDs</span>
</span><span id="__span-16-48"><a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a>        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;Hello there!&quot;</span><span class="p">,</span>
</span><span id="__span-16-49"><a id="__codelineno-16-49" name="__codelineno-16-49" href="#__codelineno-16-49"></a>                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_agent_team</span><span class="p">,</span>
</span><span id="__span-16-50"><a id="__codelineno-16-50" name="__codelineno-16-50" href="#__codelineno-16-50"></a>                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-16-51"><a id="__codelineno-16-51" name="__codelineno-16-51" href="#__codelineno-16-51"></a>                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-16-52"><a id="__codelineno-16-52" name="__codelineno-16-52" href="#__codelineno-16-52"></a>        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;What is the weather in New York?&quot;</span><span class="p">,</span>
</span><span id="__span-16-53"><a id="__codelineno-16-53" name="__codelineno-16-53" href="#__codelineno-16-53"></a>                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_agent_team</span><span class="p">,</span>
</span><span id="__span-16-54"><a id="__codelineno-16-54" name="__codelineno-16-54" href="#__codelineno-16-54"></a>                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-16-55"><a id="__codelineno-16-55" name="__codelineno-16-55" href="#__codelineno-16-55"></a>                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-16-56"><a id="__codelineno-16-56" name="__codelineno-16-56" href="#__codelineno-16-56"></a>        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;Thanks, bye!&quot;</span><span class="p">,</span>
</span><span id="__span-16-57"><a id="__codelineno-16-57" name="__codelineno-16-57" href="#__codelineno-16-57"></a>                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_agent_team</span><span class="p">,</span>
</span><span id="__span-16-58"><a id="__codelineno-16-58" name="__codelineno-16-58" href="#__codelineno-16-58"></a>                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-16-59"><a id="__codelineno-16-59" name="__codelineno-16-59" href="#__codelineno-16-59"></a>                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-16-60"><a id="__codelineno-16-60" name="__codelineno-16-60" href="#__codelineno-16-60"></a>
</span><span id="__span-16-61"><a id="__codelineno-16-61" name="__codelineno-16-61" href="#__codelineno-16-61"></a>    <span class="c1"># Execute the conversation</span>
</span><span id="__span-16-62"><a id="__codelineno-16-62" name="__codelineno-16-62" href="#__codelineno-16-62"></a>    <span class="c1"># Note: This may require API keys for the models used by root and sub-agents!</span>
</span><span id="__span-16-63"><a id="__codelineno-16-63" name="__codelineno-16-63" href="#__codelineno-16-63"></a>    <span class="k">await</span> <span class="n">run_team_conversation</span><span class="p">()</span>
</span><span id="__span-16-64"><a id="__codelineno-16-64" name="__codelineno-16-64" href="#__codelineno-16-64"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-16-65"><a id="__codelineno-16-65" name="__codelineno-16-65" href="#__codelineno-16-65"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ Skipping agent team conversation as the root agent was not successfully defined in the previous step.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p>仔细观察输出日志，特别是<code>--- Tool: ... called ---</code>消息。你应该观察到：</p>
<ul>
<li>对于"Hello there!"，调用了<code>say_hello</code>工具（表明<code>greeting_agent</code>处理了它）  </li>
<li>对于"What is the weather in New York?"，调用了<code>get_weather</code>工具（表明根智能体处理了它）  </li>
<li>对于"Thanks, bye!"，调用了<code>say_goodbye</code>工具（表明<code>farewell_agent</code>处理了它）  </li>
</ul>
<p>这确认了成功的<strong>自动委派</strong>！根智能体在其指令和<code>sub_agents</code>的<code>description</code>指导下，正确将用户请求路由到团队内适当的专家智能体。</p>
<p>你现在已用多个协作智能体构建了你的应用。这种模块化设计是构建更复杂、更有能力的智能体系统的基础。下一步，我们将使用会话状态赋予智能体跨轮次记忆信息的能力。</p>
<h2 id="4_2">第4步：通过会话状态添加记忆与个性化</h2>
<p>到目前为止，我们的智能体团队可以通过委派处理不同任务，但每次交互都是全新的——智能体没有记忆过去对话或会话中的用户偏好。要创建更复杂和上下文感知的体验，智能体需要<strong>记忆</strong>。ADK通过<strong>会话状态</strong>提供这一点。</p>
<p><strong>什么是会话状态？</strong></p>
<ul>
<li>它是绑定到特定用户会话（由<code>APP_NAME</code>、<code>USER_ID</code>、<code>SESSION_ID</code>标识）的Python字典(<code>session.state</code>)  </li>
<li>它在会话内<em>跨多个对话轮次</em>持久保存信息  </li>
<li>智能体和工具可以读取和写入此状态，使它们能记住细节、调整行为并个性化响应  </li>
</ul>
<p><strong>智能体如何与状态交互：</strong></p>
<ol>
<li><strong><code>ToolContext</code>（主要方法）</strong>：工具可以接受<code>ToolContext</code>对象（如果声明为最后一个参数，ADK会自动提供）。此对象通过<code>tool_context.state</code>提供对会话状态的直接访问，允许工具在执行<em>期间</em>读取偏好或保存结果  </li>
<li><strong><code>output_key</code>（自动保存智能体响应）</strong>：可以配置<code>Agent</code>带有<code>output_key="your_key"</code>。ADK然后将自动保存智能体每轮次的最终文本响应到<code>session.state["your_key"]</code>  </li>
</ol>
<p><strong>在本步骤中，我们将增强天气机器人团队：</strong></p>
<ol>
<li>使用<strong>新</strong><code>InMemorySessionService</code>隔离演示状态  </li>
<li>用用户对<code>temperature_unit</code>的偏好初始化会话状态  </li>
<li>创建天气工具的状态感知版本(<code>get_weather_stateful</code>)，通过<code>ToolContext</code>读取此偏好并调整其输出格式（摄氏度/华氏度）  </li>
<li>更新根智能体使用此状态感知工具，并配置<code>output_key</code>自动将其最终天气报告保存到会话状态  </li>
<li>运行对话观察初始状态如何影响工具，手动状态更改如何改变后续行为，以及<code>output_key</code>如何持久保存智能体响应  </li>
</ol>
<hr />
<h3 id="1_2"><strong>1. 初始化新会话服务和状态</strong></h3>
<p>为了清晰演示状态管理而不受之前步骤干扰，我们将实例化新的<code>InMemorySessionService</code>。我们还将创建一个会话，其初始状态定义用户的温度单位偏好。</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># @title 1. Initialize New Session Service and State</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="c1"># Import necessary session components</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.sessions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemorySessionService</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="c1"># Create a NEW session service instance for this state demonstration</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="n">session_service_stateful</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ New InMemorySessionService created for state demonstration.&quot;</span><span class="p">)</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="c1"># Define a NEW session ID for this part of the tutorial</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="n">SESSION_ID_STATEFUL</span> <span class="o">=</span> <span class="s2">&quot;session_state_demo_001&quot;</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="n">USER_ID_STATEFUL</span> <span class="o">=</span> <span class="s2">&quot;user_state_demo&quot;</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="c1"># Define initial state data - user prefers Celsius initially</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>    <span class="s2">&quot;user_preference_temperature_unit&quot;</span><span class="p">:</span> <span class="s2">&quot;Celsius&quot;</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="p">}</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="c1"># Create the session, providing the initial state</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="n">session_stateful</span> <span class="o">=</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>    <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span> <span class="c1"># Use the consistent app name</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>    <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>    <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>    <span class="n">state</span><span class="o">=</span><span class="n">initial_state</span> <span class="c1"># &lt;&lt;&lt; Initialize state during creation</span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a><span class="p">)</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Session &#39;</span><span class="si">{</span><span class="n">SESSION_ID_STATEFUL</span><span class="si">}</span><span class="s2">&#39; created for user &#39;</span><span class="si">{</span><span class="n">USER_ID_STATEFUL</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a><span class="c1"># Verify the initial state was set correctly</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a><span class="n">retrieved_session</span> <span class="o">=</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a>                                                         <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a>                                                         <span class="n">session_id</span> <span class="o">=</span> <span class="n">SESSION_ID_STATEFUL</span><span class="p">)</span>
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Initial Session State ---&quot;</span><span class="p">)</span>
</span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a><span class="k">if</span> <span class="n">retrieved_session</span><span class="p">:</span>
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">retrieved_session</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-17-36"><a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Could not retrieve session.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="2_3"><strong>2. 创建状态感知天气工具</strong></h3>
<p>现在，我们创建天气工具的新版本。其关键特性是接受<code>tool_context: ToolContext</code>，这允许它访问<code>tool_context.state</code>。它将读取<code>user_preference_temperature_unit</code>并相应格式化温度。</p>
<p><strong>关键概念：<code>ToolContext</code></strong> 此对象是你的工具逻辑与会话上下文交互的桥梁，包括读取和写入状态变量。如果定义为工具函数的最后一个参数，ADK会自动注入它。</p>
<p><strong>最佳实践</strong>：从状态读取时，使用<code>dictionary.get('key', default_value)</code>处理键可能尚不存在的情况，确保你的工具不会崩溃。</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># @title 2. Create State-Aware Weather Tool</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.tools.tool_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolContext</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_weather_stateful</span><span class="p">(</span><span class="n">city</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_context</span><span class="p">:</span> <span class="n">ToolContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves weather, converts temp unit based on session state.&quot;&quot;&quot;</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: get_weather_stateful called for </span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>    <span class="c1"># --- Read preference from state ---</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>    <span class="n">preferred_unit</span> <span class="o">=</span> <span class="n">tool_context</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_preference_temperature_unit&quot;</span><span class="p">,</span> <span class="s2">&quot;Celsius&quot;</span><span class="p">)</span> <span class="c1"># Default to Celsius</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: Reading state &#39;user_preference_temperature_unit&#39;: </span><span class="si">{</span><span class="n">preferred_unit</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>    <span class="n">city_normalized</span> <span class="o">=</span> <span class="n">city</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>    <span class="c1"># Mock weather data (always stored in Celsius internally)</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>    <span class="n">mock_weather_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>        <span class="s2">&quot;newyork&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;temp_c&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;sunny&quot;</span><span class="p">},</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>        <span class="s2">&quot;london&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;temp_c&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;cloudy&quot;</span><span class="p">},</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>        <span class="s2">&quot;tokyo&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;temp_c&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;light rain&quot;</span><span class="p">},</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>    <span class="p">}</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>    <span class="k">if</span> <span class="n">city_normalized</span> <span class="ow">in</span> <span class="n">mock_weather_db</span><span class="p">:</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">mock_weather_db</span><span class="p">[</span><span class="n">city_normalized</span><span class="p">]</span>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>        <span class="n">temp_c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;temp_c&quot;</span><span class="p">]</span>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a>        <span class="n">condition</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a>        <span class="c1"># Format temperature based on state preference</span>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>        <span class="k">if</span> <span class="n">preferred_unit</span> <span class="o">==</span> <span class="s2">&quot;Fahrenheit&quot;</span><span class="p">:</span>
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a>            <span class="n">temp_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_c</span> <span class="o">*</span> <span class="mi">9</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span> <span class="c1"># Calculate Fahrenheit</span>
</span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a>            <span class="n">temp_unit</span> <span class="o">=</span> <span class="s2">&quot;°F&quot;</span>
</span><span id="__span-18-30"><a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># Default to Celsius</span>
</span><span id="__span-18-31"><a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a>            <span class="n">temp_value</span> <span class="o">=</span> <span class="n">temp_c</span>
</span><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a>            <span class="n">temp_unit</span> <span class="o">=</span> <span class="s2">&quot;°C&quot;</span>
</span><span id="__span-18-33"><a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a>
</span><span id="__span-18-34"><a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a>        <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The weather in </span><span class="si">{</span><span class="n">city</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s2"> with a temperature of </span><span class="si">{</span><span class="n">temp_value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}{</span><span class="n">temp_unit</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="__span-18-35"><a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="n">report</span><span class="p">}</span>
</span><span id="__span-18-36"><a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: Generated report in </span><span class="si">{</span><span class="n">preferred_unit</span><span class="si">}</span><span class="s2">. Result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-18-37"><a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a>
</span><span id="__span-18-38"><a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a>        <span class="c1"># Example of writing back to state (optional for this tool)</span>
</span><span id="__span-18-39"><a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a>        <span class="n">tool_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;last_city_checked_stateful&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">city</span>
</span><span id="__span-18-40"><a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: Updated state &#39;last_city_checked_stateful&#39;: </span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-18-41"><a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a>
</span><span id="__span-18-42"><a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-18-43"><a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-18-44"><a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a>        <span class="c1"># Handle city not found</span>
</span><span id="__span-18-45"><a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a>        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Sorry, I don&#39;t have weather information for &#39;</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
</span><span id="__span-18-46"><a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: City &#39;</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">&#39; not found. ---&quot;</span><span class="p">)</span>
</span><span id="__span-18-47"><a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>
</span><span id="__span-18-48"><a id="__codelineno-18-48" name="__codelineno-18-48" href="#__codelineno-18-48"></a>
</span><span id="__span-18-49"><a id="__codelineno-18-49" name="__codelineno-18-49" href="#__codelineno-18-49"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ State-aware &#39;get_weather_stateful&#39; tool defined.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="3_1"><strong>3. 重新定义子智能体并更新根智能体</strong></h3>
<p>为确保此步骤自包含并正确构建，我们首先完全按照第3步中的定义重新定义<code>greeting_agent</code>和<code>farewell_agent</code>。然后定义我们的新根智能体(<code>weather_agent_v4_stateful</code>)：</p>
<ul>
<li>它使用新的<code>get_weather_stateful</code>工具  </li>
<li>它包含问候和告别子智能体用于委派  </li>
<li><strong>关键</strong>是设置<code>output_key="last_weather_report"</code>自动将其最终天气响应保存到会话状态  </li>
</ul>
<div class="language-py highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1"># @title 3. Redefine Sub-Agents and Update Root Agent with output_key</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="c1"># Ensure necessary imports: Agent, LiteLlm, Runner</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.lite_llm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiteLlm</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.runners</span><span class="w"> </span><span class="kn">import</span> <span class="n">Runner</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="c1"># Ensure tools &#39;say_hello&#39;, &#39;say_goodbye&#39; are defined (from Step 3)</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="c1"># Ensure model constants MODEL_GPT_4O, MODEL_GEMINI_2_5_PRO etc. are defined</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="c1"># --- Redefine Greeting Agent (from Step 3) ---</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="n">greeting_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>    <span class="n">greeting_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>        <span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;greeting_agent&quot;</span><span class="p">,</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Greeting Agent. Your ONLY task is to provide a friendly greeting using the &#39;say_hello&#39; tool. Do nothing else.&quot;</span><span class="p">,</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple greetings and hellos using the &#39;say_hello&#39; tool.&quot;</span><span class="p">,</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_hello</span><span class="p">],</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>    <span class="p">)</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Agent &#39;</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; redefined.&quot;</span><span class="p">)</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not redefine Greeting agent. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="c1"># --- Redefine Farewell Agent (from Step 3) ---</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="n">farewell_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a>    <span class="n">farewell_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a>        <span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;farewell_agent&quot;</span><span class="p">,</span>
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Farewell Agent. Your ONLY task is to provide a polite goodbye message using the &#39;say_goodbye&#39; tool. Do not perform any other actions.&quot;</span><span class="p">,</span>
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple farewells and goodbyes using the &#39;say_goodbye&#39; tool.&quot;</span><span class="p">,</span>
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_goodbye</span><span class="p">],</span>
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a>    <span class="p">)</span>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Agent &#39;</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; redefined.&quot;</span><span class="p">)</span>
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-19-36"><a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not redefine Farewell agent. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-19-37"><a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a>
</span><span id="__span-19-38"><a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a><span class="c1"># --- Define the Updated Root Agent ---</span>
</span><span id="__span-19-39"><a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a><span class="n">root_agent_stateful</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-19-40"><a id="__codelineno-19-40" name="__codelineno-19-40" href="#__codelineno-19-40"></a><span class="n">runner_root_stateful</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Initialize runner</span>
</span><span id="__span-19-41"><a id="__codelineno-19-41" name="__codelineno-19-41" href="#__codelineno-19-41"></a>
</span><span id="__span-19-42"><a id="__codelineno-19-42" name="__codelineno-19-42" href="#__codelineno-19-42"></a><span class="c1"># Check prerequisites before creating the root agent</span>
</span><span id="__span-19-43"><a id="__codelineno-19-43" name="__codelineno-19-43" href="#__codelineno-19-43"></a><span class="k">if</span> <span class="n">greeting_agent</span> <span class="ow">and</span> <span class="n">farewell_agent</span> <span class="ow">and</span> <span class="s1">&#39;get_weather_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-19-44"><a id="__codelineno-19-44" name="__codelineno-19-44" href="#__codelineno-19-44"></a>
</span><span id="__span-19-45"><a id="__codelineno-19-45" name="__codelineno-19-45" href="#__codelineno-19-45"></a>    <span class="n">root_agent_model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span> <span class="c1"># Choose orchestration model</span>
</span><span id="__span-19-46"><a id="__codelineno-19-46" name="__codelineno-19-46" href="#__codelineno-19-46"></a>
</span><span id="__span-19-47"><a id="__codelineno-19-47" name="__codelineno-19-47" href="#__codelineno-19-47"></a>    <span class="n">root_agent_stateful</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-19-48"><a id="__codelineno-19-48" name="__codelineno-19-48" href="#__codelineno-19-48"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_v4_stateful&quot;</span><span class="p">,</span> <span class="c1"># New version name</span>
</span><span id="__span-19-49"><a id="__codelineno-19-49" name="__codelineno-19-49" href="#__codelineno-19-49"></a>        <span class="n">model</span><span class="o">=</span><span class="n">root_agent_model</span><span class="p">,</span>
</span><span id="__span-19-50"><a id="__codelineno-19-50" name="__codelineno-19-50" href="#__codelineno-19-50"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Main agent: Provides weather (state-aware unit), delegates greetings/farewells, saves report to state.&quot;</span><span class="p">,</span>
</span><span id="__span-19-51"><a id="__codelineno-19-51" name="__codelineno-19-51" href="#__codelineno-19-51"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the main Weather Agent. Your job is to provide weather using &#39;get_weather_stateful&#39;. &quot;</span>
</span><span id="__span-19-52"><a id="__codelineno-19-52" name="__codelineno-19-52" href="#__codelineno-19-52"></a>                    <span class="s2">&quot;The tool will format the temperature based on user preference stored in state. &quot;</span>
</span><span id="__span-19-53"><a id="__codelineno-19-53" name="__codelineno-19-53" href="#__codelineno-19-53"></a>                    <span class="s2">&quot;Delegate simple greetings to &#39;greeting_agent&#39; and farewells to &#39;farewell_agent&#39;. &quot;</span>
</span><span id="__span-19-54"><a id="__codelineno-19-54" name="__codelineno-19-54" href="#__codelineno-19-54"></a>                    <span class="s2">&quot;Handle only weather requests, greetings, and farewells.&quot;</span><span class="p">,</span>
</span><span id="__span-19-55"><a id="__codelineno-19-55" name="__codelineno-19-55" href="#__codelineno-19-55"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather_stateful</span><span class="p">],</span> <span class="c1"># Use the state-aware tool</span>
</span><span id="__span-19-56"><a id="__codelineno-19-56" name="__codelineno-19-56" href="#__codelineno-19-56"></a>        <span class="n">sub_agents</span><span class="o">=</span><span class="p">[</span><span class="n">greeting_agent</span><span class="p">,</span> <span class="n">farewell_agent</span><span class="p">],</span> <span class="c1"># Include sub-agents</span>
</span><span id="__span-19-57"><a id="__codelineno-19-57" name="__codelineno-19-57" href="#__codelineno-19-57"></a>        <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;last_weather_report&quot;</span> <span class="c1"># &lt;&lt;&lt; Auto-save agent&#39;s final weather response</span>
</span><span id="__span-19-58"><a id="__codelineno-19-58" name="__codelineno-19-58" href="#__codelineno-19-58"></a>    <span class="p">)</span>
</span><span id="__span-19-59"><a id="__codelineno-19-59" name="__codelineno-19-59" href="#__codelineno-19-59"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Root Agent &#39;</span><span class="si">{</span><span class="n">root_agent_stateful</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using stateful tool and output_key.&quot;</span><span class="p">)</span>
</span><span id="__span-19-60"><a id="__codelineno-19-60" name="__codelineno-19-60" href="#__codelineno-19-60"></a>
</span><span id="__span-19-61"><a id="__codelineno-19-61" name="__codelineno-19-61" href="#__codelineno-19-61"></a>    <span class="c1"># --- Create Runner for this Root Agent &amp; NEW Session Service ---</span>
</span><span id="__span-19-62"><a id="__codelineno-19-62" name="__codelineno-19-62" href="#__codelineno-19-62"></a>    <span class="n">runner_root_stateful</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-19-63"><a id="__codelineno-19-63" name="__codelineno-19-63" href="#__codelineno-19-63"></a>        <span class="n">agent</span><span class="o">=</span><span class="n">root_agent_stateful</span><span class="p">,</span>
</span><span id="__span-19-64"><a id="__codelineno-19-64" name="__codelineno-19-64" href="#__codelineno-19-64"></a>        <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-19-65"><a id="__codelineno-19-65" name="__codelineno-19-65" href="#__codelineno-19-65"></a>        <span class="n">session_service</span><span class="o">=</span><span class="n">session_service_stateful</span> <span class="c1"># Use the NEW stateful session service</span>
</span><span id="__span-19-66"><a id="__codelineno-19-66" name="__codelineno-19-66" href="#__codelineno-19-66"></a>    <span class="p">)</span>
</span><span id="__span-19-67"><a id="__codelineno-19-67" name="__codelineno-19-67" href="#__codelineno-19-67"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Runner created for stateful root agent &#39;</span><span class="si">{</span><span class="n">runner_root_stateful</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; using stateful session service.&quot;</span><span class="p">)</span>
</span><span id="__span-19-68"><a id="__codelineno-19-68" name="__codelineno-19-68" href="#__codelineno-19-68"></a>
</span><span id="__span-19-69"><a id="__codelineno-19-69" name="__codelineno-19-69" href="#__codelineno-19-69"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-19-70"><a id="__codelineno-19-70" name="__codelineno-19-70" href="#__codelineno-19-70"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Cannot create stateful root agent. Prerequisites missing.&quot;</span><span class="p">)</span>
</span><span id="__span-19-71"><a id="__codelineno-19-71" name="__codelineno-19-71" href="#__codelineno-19-71"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">greeting_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - greeting_agent definition missing.&quot;</span><span class="p">)</span>
</span><span id="__span-19-72"><a id="__codelineno-19-72" name="__codelineno-19-72" href="#__codelineno-19-72"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">farewell_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - farewell_agent definition missing.&quot;</span><span class="p">)</span>
</span><span id="__span-19-73"><a id="__codelineno-19-73" name="__codelineno-19-73" href="#__codelineno-19-73"></a>    <span class="k">if</span> <span class="s1">&#39;get_weather_stateful&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - get_weather_stateful tool missing.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="4_3"><strong>4. 交互并测试状态流</strong></h3>
<p>现在，让我们执行一个对话，设计用于使用<code>runner_root_stateful</code>（关联我们的状态感知智能体和<code>session_service_stateful</code>）测试状态交互。我们将使用之前定义的<code>call_agent_async</code>函数，确保传递正确的runner、用户ID(<code>USER_ID_STATEFUL</code>)和会话ID(<code>SESSION_ID_STATEFUL</code>)。</p>
<p>对话流程将是：</p>
<ol>
<li><strong>检查天气（伦敦）</strong>：<code>get_weather_stateful</code>工具应从第1节初始化的会话状态读取初始"摄氏度"偏好。根智能体的最终响应（摄氏度的天气报告）应通过<code>output_key</code>配置保存到<code>state['last_weather_report']</code>  </li>
<li><strong>手动更新状态</strong>：我们将<em>直接修改</em>存储在<code>InMemorySessionService</code>实例(<code>session_service_stateful</code>)中的状态  <ul>
<li><strong>为什么直接修改？</strong> <code>session_service.get_session()</code>方法返回会话的<em>副本</em>。修改该副本不会影响后续智能体运行中使用的状态。对于使用<code>InMemorySessionService</code>的测试场景，我们访问内部<code>sessions</code>字典来更改<code>user_preference_temperature_unit</code>的实际存储状态值为"华氏度"。<em>注意：在实际应用中，状态更改通常由工具或智能体逻辑返回<code>EventActions(state_delta=...)</code>触发，而非直接手动更新</em>  </li>
</ul>
</li>
<li><strong>再次检查天气（纽约）</strong>：<code>get_weather_stateful</code>工具现在应从状态读取更新的"华氏度"偏好并相应转换温度。根智能体的<em>新</em>响应（华氏度的天气）将由于<code>output_key</code>覆盖<code>state['last_weather_report']</code>中的先前值  </li>
<li><strong>问候智能体</strong>：验证委派给<code>greeting_agent</code>在状态感知操作旁边仍正常工作。此交互将成为<code>output_key</code>在此特定序列中保存的<em>最后</em>响应  </li>
<li><strong>检查最终状态</strong>：对话后，我们最后一次检索会话（获取副本）并打印其状态，确认<code>user_preference_temperature_unit</code>确实是"华氏度"，观察<code>output_key</code>保存的最终值（在此运行中将是问候），并查看工具写入的<code>last_city_checked_stateful</code>值  </li>
</ol>
<div class="language-py highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># Ensure the stateful runner (runner_root_stateful) is available from the previous cell</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="c1"># Ensure call_agent_async, USER_ID_STATEFUL, SESSION_ID_STATEFUL, APP_NAME are defined</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="k">if</span> <span class="s1">&#39;runner_root_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">runner_root_stateful</span><span class="p">:</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>  <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_stateful_conversation</span><span class="p">():</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing State: Temp Unit Conversion &amp; output_key ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>      <span class="c1"># 1. Check weather (Uses initial state: Celsius)</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Turn 1: Requesting weather in London (expect Celsius) ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>      <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="o">=</span> <span class="s2">&quot;What&#39;s the weather in London?&quot;</span><span class="p">,</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>                             <span class="n">runner</span><span class="o">=</span><span class="n">runner_root_stateful</span><span class="p">,</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>                             <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>                             <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>                            <span class="p">)</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>      <span class="c1"># 2. Manually update state preference to Fahrenheit - DIRECTLY MODIFY STORAGE</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Manually Updating State: Setting unit to Fahrenheit ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>      <span class="k">try</span><span class="p">:</span>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>          <span class="c1"># Access the internal storage directly - THIS IS SPECIFIC TO InMemorySessionService for testing</span>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>          <span class="n">stored_session</span> <span class="o">=</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">APP_NAME</span><span class="p">][</span><span class="n">USER_ID_STATEFUL</span><span class="p">][</span><span class="n">SESSION_ID_STATEFUL</span><span class="p">]</span>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>          <span class="n">stored_session</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;user_preference_temperature_unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Fahrenheit&quot;</span>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>          <span class="c1"># Optional: You might want to update the timestamp as well if any logic depends on it</span>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>          <span class="c1"># import time</span>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>          <span class="c1"># stored_session.last_update_time = time.time()</span>
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>          <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Stored session state updated. Current &#39;user_preference_temperature_unit&#39;: </span><span class="si">{</span><span class="n">stored_session</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;user_preference_temperature_unit&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>      <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>          <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Error: Could not retrieve session &#39;</span><span class="si">{</span><span class="n">SESSION_ID_STATEFUL</span><span class="si">}</span><span class="s2">&#39; from internal storage for user &#39;</span><span class="si">{</span><span class="n">USER_ID_STATEFUL</span><span class="si">}</span><span class="s2">&#39; in app &#39;</span><span class="si">{</span><span class="n">APP_NAME</span><span class="si">}</span><span class="s2">&#39; to update state. Check IDs and if session was created. ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-20-29"><a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>           <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Error updating internal session state: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-30"><a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a>
</span><span id="__span-20-31"><a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a>      <span class="c1"># 3. Check weather again (Tool should now use Fahrenheit)</span>
</span><span id="__span-20-32"><a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a>      <span class="c1"># This will also update &#39;last_weather_report&#39; via output_key</span>
</span><span id="__span-20-33"><a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a>      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Turn 2: Requesting weather in New York (expect Fahrenheit) ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-34"><a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a>      <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="o">=</span> <span class="s2">&quot;Tell me the weather in New York.&quot;</span><span class="p">,</span>
</span><span id="__span-20-35"><a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a>                             <span class="n">runner</span><span class="o">=</span><span class="n">runner_root_stateful</span><span class="p">,</span>
</span><span id="__span-20-36"><a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a>                             <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-20-37"><a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a>                             <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span>
</span><span id="__span-20-38"><a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a>                            <span class="p">)</span>
</span><span id="__span-20-39"><a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a>
</span><span id="__span-20-40"><a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a>      <span class="c1"># 4. Test basic delegation (should still work)</span>
</span><span id="__span-20-41"><a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a>      <span class="c1"># This will update &#39;last_weather_report&#39; again, overwriting the NY weather report</span>
</span><span id="__span-20-42"><a id="__codelineno-20-42" name="__codelineno-20-42" href="#__codelineno-20-42"></a>      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Turn 3: Sending a greeting ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-43"><a id="__codelineno-20-43" name="__codelineno-20-43" href="#__codelineno-20-43"></a>      <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="o">=</span> <span class="s2">&quot;Hi!&quot;</span><span class="p">,</span>
</span><span id="__span-20-44"><a id="__codelineno-20-44" name="__codelineno-20-44" href="#__codelineno-20-44"></a>                             <span class="n">runner</span><span class="o">=</span><span class="n">runner_root_stateful</span><span class="p">,</span>
</span><span id="__span-20-45"><a id="__codelineno-20-45" name="__codelineno-20-45" href="#__codelineno-20-45"></a>                             <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-20-46"><a id="__codelineno-20-46" name="__codelineno-20-46" href="#__codelineno-20-46"></a>                             <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span>
</span><span id="__span-20-47"><a id="__codelineno-20-47" name="__codelineno-20-47" href="#__codelineno-20-47"></a>                            <span class="p">)</span>
</span><span id="__span-20-48"><a id="__codelineno-20-48" name="__codelineno-20-48" href="#__codelineno-20-48"></a>
</span><span id="__span-20-49"><a id="__codelineno-20-49" name="__codelineno-20-49" href="#__codelineno-20-49"></a>  <span class="c1"># Execute the conversation</span>
</span><span id="__span-20-50"><a id="__codelineno-20-50" name="__codelineno-20-50" href="#__codelineno-20-50"></a>  <span class="k">await</span> <span class="n">run_stateful_conversation</span><span class="p">()</span>
</span><span id="__span-20-51"><a id="__codelineno-20-51" name="__codelineno-20-51" href="#__codelineno-20-51"></a>
</span><span id="__span-20-52"><a id="__codelineno-20-52" name="__codelineno-20-52" href="#__codelineno-20-52"></a>  <span class="c1"># Inspect final session state after the conversation</span>
</span><span id="__span-20-53"><a id="__codelineno-20-53" name="__codelineno-20-53" href="#__codelineno-20-53"></a>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Inspecting Final Session State ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-54"><a id="__codelineno-20-54" name="__codelineno-20-54" href="#__codelineno-20-54"></a>  <span class="n">final_session</span> <span class="o">=</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-20-55"><a id="__codelineno-20-55" name="__codelineno-20-55" href="#__codelineno-20-55"></a>                                                       <span class="n">user_id</span><span class="o">=</span> <span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-20-56"><a id="__codelineno-20-56" name="__codelineno-20-56" href="#__codelineno-20-56"></a>                                                       <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span><span class="p">)</span>
</span><span id="__span-20-57"><a id="__codelineno-20-57" name="__codelineno-20-57" href="#__codelineno-20-57"></a>  <span class="k">if</span> <span class="n">final_session</span><span class="p">:</span>
</span><span id="__span-20-58"><a id="__codelineno-20-58" name="__codelineno-20-58" href="#__codelineno-20-58"></a>      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Preference: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_preference_temperature_unit&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-20-59"><a id="__codelineno-20-59" name="__codelineno-20-59" href="#__codelineno-20-59"></a>      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Last Weather Report (from output_key): </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_weather_report&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-20-60"><a id="__codelineno-20-60" name="__codelineno-20-60" href="#__codelineno-20-60"></a>      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Last City Checked (by tool): </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_city_checked_stateful&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-20-61"><a id="__codelineno-20-61" name="__codelineno-20-61" href="#__codelineno-20-61"></a>      <span class="c1"># Print full state for detailed view</span>
</span><span id="__span-20-62"><a id="__codelineno-20-62" name="__codelineno-20-62" href="#__codelineno-20-62"></a>      <span class="c1"># print(f&quot;Full State: {final_session.state}&quot;)</span>
</span><span id="__span-20-63"><a id="__codelineno-20-63" name="__codelineno-20-63" href="#__codelineno-20-63"></a>  <span class="k">else</span><span class="p">:</span>
</span><span id="__span-20-64"><a id="__codelineno-20-64" name="__codelineno-20-64" href="#__codelineno-20-64"></a>      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">❌ Error: Could not retrieve final session state.&quot;</span><span class="p">)</span>
</span><span id="__span-20-65"><a id="__codelineno-20-65" name="__codelineno-20-65" href="#__codelineno-20-65"></a>
</span><span id="__span-20-66"><a id="__codelineno-20-66" name="__codelineno-20-66" href="#__codelineno-20-66"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-20-67"><a id="__codelineno-20-67" name="__codelineno-20-67" href="#__codelineno-20-67"></a>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ Skipping state test conversation. Stateful root agent runner (&#39;runner_root_stateful&#39;) is not available.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p>通过回顾对话流程和最终会话状态打印，你可以确认：</p>
<ul>
<li><strong>状态读取</strong>：天气工具(<code>get_weather_stateful</code>)正确从状态读取<code>user_preference_temperature_unit</code>，最初对伦敦使用"摄氏度"  </li>
<li><strong>状态更新</strong>：直接修改成功将存储偏好更改为"华氏度"  </li>
<li><strong>状态读取（更新后）</strong>：当询问纽约天气时，工具随后读取"华氏度"并执行转换  </li>
<li><strong>工具状态写入</strong>：工具通过<code>tool_context.state</code>成功将<code>last_city_checked_stateful</code>（第二次天气检查后的"纽约"）写入状态  </li>
<li><strong>委派</strong>：对"Hi!"的<code>greeting_agent</code>委派在状态修改后仍正确运行  </li>
<li><strong><code>output_key</code></strong>：<code>output_key="last_weather_report"</code>成功保存根智能体<em>每轮次</em>的<em>最终</em>响应（根智能体最终响应的轮次）。在此序列中，最后响应是问候（"Hello, there!"），因此它覆盖了状态键中的天气报告  </li>
<li><strong>最终状态</strong>：最终检查确认偏好持久保存为"华氏度"  </li>
</ul>
<p>你现在已成功集成会话状态，使用<code>ToolContext</code>个性化智能体行为，为测试<code>InMemorySessionService</code>手动操作状态，并观察<code>output_key</code>如何提供简单机制将智能体的最后响应保存到状态。这种状态管理的基础理解是关键，因为我们将在下一步使用回调实现安全防护机制。</p>
<hr />
<h2 id="5-before_model_callback">第5步：添加安全性 - 使用<code>before_model_callback</code>的输入防护</h2>
<p>我们的智能体团队正变得更强大，能记住偏好并有效使用工具。然而，在现实场景中，我们经常需要安全机制来控制智能体行为，<em>在</em>潜在问题请求甚至到达核心大模型(LLM)之前。</p>
<p>ADK提供<strong>回调</strong>——允许你挂钩到智能体执行生命周期特定点的函数。<code>before_model_callback</code>特别适用于输入安全。</p>
<p><strong>什么是<code>before_model_callback</code>？</strong></p>
<ul>
<li>它是你定义的Python函数，ADK<em>刚好在</em>智能体将其编译的请求（包括对话历史、指令和最新用户消息）发送到底层大模型之前执行  </li>
<li><strong>目的</strong>：检查请求，必要时修改它，或基于预定义规则完全阻止它  </li>
</ul>
<p><strong>常见用例：</strong></p>
<ul>
<li><strong>输入验证/过滤</strong>：检查用户输入是否符合标准或包含不允许的内容（如PII或关键词）  </li>
<li><strong>防护</strong>：防止有害、离题或违反策略的请求被大模型处理  </li>
<li><strong>动态提示修改</strong>：在发送前向大模型请求上下文添加及时信息（如来自会话状态的信息）  </li>
</ul>
<p><strong>工作原理：</strong></p>
<ol>
<li>定义接受<code>callback_context: CallbackContext</code>和<code>llm_request: LlmRequest</code>的函数  </li>
<li><code>callback_context</code>：提供对智能体信息、会话状态(<code>callback_context.state</code>)等的访问  </li>
<li><code>llm_request</code>：包含打算发送给大模型的完整负载(<code>contents</code>、<code>config</code>)  </li>
<li>在函数内部：  </li>
<li><strong>检查</strong>：检查<code>llm_request.contents</code>（特别是最后用户消息）  </li>
<li><strong>修改（谨慎使用）</strong>：你可以更改<code>llm_request</code>的部分内容  </li>
<li><strong>阻止（防护）</strong>：返回<code>LlmResponse</code>对象。ADK将立即发送此响应<em>跳过</em>该轮次的大模型调用  </li>
<li><strong>允许</strong>：返回<code>None</code>。ADK继续使用（可能修改后的）请求调用大模型  </li>
</ol>
<p><strong>在本步骤中，我们将：</strong></p>
<ol>
<li>定义<code>before_model_callback</code>函数(<code>block_keyword_guardrail</code>)，检查用户输入中特定关键词("BLOCK")  </li>
<li>更新我们的状态感知根智能体(<code>weather_agent_v4_stateful</code>来自第4步)使用此回调  </li>
<li>创建与此更新智能体关联的新runner，但使用<em>相同的状态感知会话服务</em>以保持状态连续性  </li>
<li>通过发送正常和含关键词的请求测试防护  </li>
</ol>
<hr />
<h3 id="1_3"><strong>1. 定义防护回调函数</strong></h3>
<p>此函数将检查<code>llm_request</code>内容中的最后用户消息。如果找到"BLOCK"（不区分大小写），它构建并返回<code>LlmResponse</code>以阻止流程；否则返回<code>None</code>。</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># @title 1. Define the before_model_callback Guardrail</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="c1"># Ensure necessary imports are available</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.agents.callback_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">CallbackContext</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.llm_request</span><span class="w"> </span><span class="kn">import</span> <span class="n">LlmRequest</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.llm_response</span><span class="w"> </span><span class="kn">import</span> <span class="n">LlmResponse</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.genai</span><span class="w"> </span><span class="kn">import</span> <span class="n">types</span> <span class="c1"># For creating response content</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">block_keyword_guardrail</span><span class="p">(</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>    <span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">,</span> <span class="n">llm_request</span><span class="p">:</span> <span class="n">LlmRequest</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LlmResponse</span><span class="p">]:</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="sd">    Inspects the latest user message for &#39;BLOCK&#39;. If found, blocks the LLM call</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="sd">    and returns a predefined LlmResponse. Otherwise, returns None to proceed.</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>    <span class="n">agent_name</span> <span class="o">=</span> <span class="n">callback_context</span><span class="o">.</span><span class="n">agent_name</span> <span class="c1"># Get the name of the agent whose model call is being intercepted</span>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: block_keyword_guardrail running for agent: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>    <span class="c1"># Extract the text from the latest user message in the request history</span>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>    <span class="n">last_user_message_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>    <span class="k">if</span> <span class="n">llm_request</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>        <span class="c1"># Find the most recent message with role &#39;user&#39;</span>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>        <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">llm_request</span><span class="o">.</span><span class="n">contents</span><span class="p">):</span>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>            <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;user&#39;</span> <span class="ow">and</span> <span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>                <span class="c1"># Assuming text is in the first part for simplicity</span>
</span><span id="__span-21-27"><a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>                <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="__span-21-28"><a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a>                    <span class="n">last_user_message_text</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
</span><span id="__span-21-29"><a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a>                    <span class="k">break</span> <span class="c1"># Found the last user message text</span>
</span><span id="__span-21-30"><a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a>
</span><span id="__span-21-31"><a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Inspecting last user message: &#39;</span><span class="si">{</span><span class="n">last_user_message_text</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; ---&quot;</span><span class="p">)</span> <span class="c1"># Log first 100 chars</span>
</span><span id="__span-21-32"><a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a>
</span><span id="__span-21-33"><a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a>    <span class="c1"># --- Guardrail Logic ---</span>
</span><span id="__span-21-34"><a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a>    <span class="n">keyword_to_block</span> <span class="o">=</span> <span class="s2">&quot;BLOCK&quot;</span>
</span><span id="__span-21-35"><a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a>    <span class="k">if</span> <span class="n">keyword_to_block</span> <span class="ow">in</span> <span class="n">last_user_message_text</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span> <span class="c1"># Case-insensitive check</span>
</span><span id="__span-21-36"><a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Found &#39;</span><span class="si">{</span><span class="n">keyword_to_block</span><span class="si">}</span><span class="s2">&#39;. Blocking LLM call! ---&quot;</span><span class="p">)</span>
</span><span id="__span-21-37"><a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a>        <span class="c1"># Optionally, set a flag in state to record the block event</span>
</span><span id="__span-21-38"><a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a>        <span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;guardrail_block_keyword_triggered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-21-39"><a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Set state &#39;guardrail_block_keyword_triggered&#39;: True ---&quot;</span><span class="p">)</span>
</span><span id="__span-21-40"><a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a>
</span><span id="__span-21-41"><a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a>        <span class="c1"># Construct and return an LlmResponse to stop the flow and send this back instead</span>
</span><span id="__span-21-42"><a id="__codelineno-21-42" name="__codelineno-21-42" href="#__codelineno-21-42"></a>        <span class="k">return</span> <span class="n">LlmResponse</span><span class="p">(</span>
</span><span id="__span-21-43"><a id="__codelineno-21-43" name="__codelineno-21-43" href="#__codelineno-21-43"></a>            <span class="n">content</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span>
</span><span id="__span-21-44"><a id="__codelineno-21-44" name="__codelineno-21-44" href="#__codelineno-21-44"></a>                <span class="n">role</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="c1"># Mimic a response from the agent&#39;s perspective</span>
</span><span id="__span-21-45"><a id="__codelineno-21-45" name="__codelineno-21-45" href="#__codelineno-21-45"></a>                <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;I cannot process this request because it contains the blocked keyword &#39;</span><span class="si">{</span><span class="n">keyword_to_block</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)],</span>
</span><span id="__span-21-46"><a id="__codelineno-21-46" name="__codelineno-21-46" href="#__codelineno-21-46"></a>            <span class="p">)</span>
</span><span id="__span-21-47"><a id="__codelineno-21-47" name="__codelineno-21-47" href="#__codelineno-21-47"></a>            <span class="c1"># Note: You could also set an error_message field here if needed</span>
</span><span id="__span-21-48"><a id="__codelineno-21-48" name="__codelineno-21-48" href="#__codelineno-21-48"></a>        <span class="p">)</span>
</span><span id="__span-21-49"><a id="__codelineno-21-49" name="__codelineno-21-49" href="#__codelineno-21-49"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-21-50"><a id="__codelineno-21-50" name="__codelineno-21-50" href="#__codelineno-21-50"></a>        <span class="c1"># Keyword not found, allow the request to proceed to the LLM</span>
</span><span id="__span-21-51"><a id="__codelineno-21-51" name="__codelineno-21-51" href="#__codelineno-21-51"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Keyword not found. Allowing LLM call for </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">. ---&quot;</span><span class="p">)</span>
</span><span id="__span-21-52"><a id="__codelineno-21-52" name="__codelineno-21-52" href="#__codelineno-21-52"></a>        <span class="k">return</span> <span class="kc">None</span> <span class="c1"># Returning None signals ADK to continue normally</span>
</span><span id="__span-21-53"><a id="__codelineno-21-53" name="__codelineno-21-53" href="#__codelineno-21-53"></a>
</span><span id="__span-21-54"><a id="__codelineno-21-54" name="__codelineno-21-54" href="#__codelineno-21-54"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ block_keyword_guardrail function defined.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="2_4"><strong>2. 更新根智能体使用回调</strong></h3>
<p>我们重新定义根智能体，添加<code>before_model_callback</code>参数并指向我们的新防护函数。为清晰起见，我们给它一个新版本名称。</p>
<p><em>重要</em>：我们需要在此上下文中重新定义子智能体(<code>greeting_agent</code>、<code>farewell_agent</code>)和状态感知工具(<code>get_weather_stateful</code>)（如果它们尚未从之前步骤中获得），确保根智能体定义能访问其所有组件。</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1"># @title 2. Update Root Agent with before_model_callback</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="c1"># --- Redefine Sub-Agents (Ensures they exist in this context) ---</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="n">greeting_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>    <span class="c1"># Use a defined model constant</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>    <span class="n">greeting_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>        <span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;greeting_agent&quot;</span><span class="p">,</span> <span class="c1"># Keep original name for consistency</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Greeting Agent. Your ONLY task is to provide a friendly greeting using the &#39;say_hello&#39; tool. Do nothing else.&quot;</span><span class="p">,</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple greetings and hellos using the &#39;say_hello&#39; tool.&quot;</span><span class="p">,</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_hello</span><span class="p">],</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>    <span class="p">)</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Sub-Agent &#39;</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; redefined.&quot;</span><span class="p">)</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not redefine Greeting agent. Check Model/API Key (</span><span class="si">{</span><span class="n">MODEL_GPT_4O</span><span class="si">}</span><span class="s2">). Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="n">farewell_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>    <span class="c1"># Use a defined model constant</span>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>    <span class="n">farewell_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>        <span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;farewell_agent&quot;</span><span class="p">,</span> <span class="c1"># Keep original name</span>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Farewell Agent. Your ONLY task is to provide a polite goodbye message using the &#39;say_goodbye&#39; tool. Do not perform any other actions.&quot;</span><span class="p">,</span>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple farewells and goodbyes using the &#39;say_goodbye&#39; tool.&quot;</span><span class="p">,</span>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_goodbye</span><span class="p">],</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>    <span class="p">)</span>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Sub-Agent &#39;</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; redefined.&quot;</span><span class="p">)</span>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not redefine Farewell agent. Check Model/API Key (</span><span class="si">{</span><span class="n">MODEL_GPT_4O</span><span class="si">}</span><span class="s2">). Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a><span class="c1"># --- Define the Root Agent with the Callback ---</span>
</span><span id="__span-22-35"><a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a><span class="n">root_agent_model_guardrail</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-22-36"><a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a><span class="n">runner_root_model_guardrail</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-22-37"><a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a>
</span><span id="__span-22-38"><a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a><span class="c1"># Check all components before proceeding</span>
</span><span id="__span-22-39"><a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a><span class="k">if</span> <span class="n">greeting_agent</span> <span class="ow">and</span> <span class="n">farewell_agent</span> <span class="ow">and</span> <span class="s1">&#39;get_weather_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;block_keyword_guardrail&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-22-40"><a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a>
</span><span id="__span-22-41"><a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a>    <span class="c1"># Use a defined model constant like MODEL_GEMINI_2_5_PRO</span>
</span><span id="__span-22-42"><a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a>    <span class="n">root_agent_model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span>
</span><span id="__span-22-43"><a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a>
</span><span id="__span-22-44"><a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a>    <span class="n">root_agent_model_guardrail</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-22-45"><a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_v5_model_guardrail&quot;</span><span class="p">,</span> <span class="c1"># New version name for clarity</span>
</span><span id="__span-22-46"><a id="__codelineno-22-46" name="__codelineno-22-46" href="#__codelineno-22-46"></a>        <span class="n">model</span><span class="o">=</span><span class="n">root_agent_model</span><span class="p">,</span>
</span><span id="__span-22-47"><a id="__codelineno-22-47" name="__codelineno-22-47" href="#__codelineno-22-47"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Main agent: Handles weather, delegates greetings/farewells, includes input keyword guardrail.&quot;</span><span class="p">,</span>
</span><span id="__span-22-48"><a id="__codelineno-22-48" name="__codelineno-22-48" href="#__codelineno-22-48"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the main Weather Agent. Provide weather using &#39;get_weather_stateful&#39;. &quot;</span>
</span><span id="__span-22-49"><a id="__codelineno-22-49" name="__codelineno-22-49" href="#__codelineno-22-49"></a>                    <span class="s2">&quot;Delegate simple greetings to &#39;greeting_agent&#39; and farewells to &#39;farewell_agent&#39;. &quot;</span>
</span><span id="__span-22-50"><a id="__codelineno-22-50" name="__codelineno-22-50" href="#__codelineno-22-50"></a>                    <span class="s2">&quot;Handle only weather requests, greetings, and farewells.&quot;</span><span class="p">,</span>
</span><span id="__span-22-51"><a id="__codelineno-22-51" name="__codelineno-22-51" href="#__codelineno-22-51"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather</span><span class="p">],</span>
</span><span id="__span-22-52"><a id="__codelineno-22-52" name="__codelineno-22-52" href="#__codelineno-22-52"></a>        <span class="n">sub_agents</span><span class="o">=</span><span class="p">[</span><span class="n">greeting_agent</span><span class="p">,</span> <span class="n">farewell_agent</span><span class="p">],</span> <span class="c1"># Reference the redefined sub-agents</span>
</span><span id="__span-22-53"><a id="__codelineno-22-53" name="__codelineno-22-53" href="#__codelineno-22-53"></a>        <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;last_weather_report&quot;</span><span class="p">,</span> <span class="c1"># Keep output_key from Step 4</span>
</span><span id="__span-22-54"><a id="__codelineno-22-54" name="__codelineno-22-54" href="#__codelineno-22-54"></a>        <span class="n">before_model_callback</span><span class="o">=</span><span class="n">block_keyword_guardrail</span> <span class="c1"># &lt;&lt;&lt; Assign the guardrail callback</span>
</span><span id="__span-22-55"><a id="__codelineno-22-55" name="__codelineno-22-55" href="#__codelineno-22-55"></a>    <span class="p">)</span>
</span><span id="__span-22-56"><a id="__codelineno-22-56" name="__codelineno-22-56" href="#__codelineno-22-56"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Root Agent &#39;</span><span class="si">{</span><span class="n">root_agent_model_guardrail</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created with before_model_callback.&quot;</span><span class="p">)</span>
</span><span id="__span-22-57"><a id="__codelineno-22-57" name="__codelineno-22-57" href="#__codelineno-22-57"></a>
</span><span id="__span-22-58"><a id="__codelineno-22-58" name="__codelineno-22-58" href="#__codelineno-22-58"></a>    <span class="c1"># --- Create Runner for this Agent, Using SAME Stateful Session Service ---</span>
</span><span id="__span-22-59"><a id="__codelineno-22-59" name="__codelineno-22-59" href="#__codelineno-22-59"></a>    <span class="c1"># Ensure session_service_stateful exists from Step 4</span>
</span><span id="__span-22-60"><a id="__codelineno-22-60" name="__codelineno-22-60" href="#__codelineno-22-60"></a>    <span class="k">if</span> <span class="s1">&#39;session_service_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-22-61"><a id="__codelineno-22-61" name="__codelineno-22-61" href="#__codelineno-22-61"></a>        <span class="n">runner_root_model_guardrail</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-22-62"><a id="__codelineno-22-62" name="__codelineno-22-62" href="#__codelineno-22-62"></a>            <span class="n">agent</span><span class="o">=</span><span class="n">root_agent_model_guardrail</span><span class="p">,</span>
</span><span id="__span-22-63"><a id="__codelineno-22-63" name="__codelineno-22-63" href="#__codelineno-22-63"></a>            <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span> <span class="c1"># Use consistent APP_NAME</span>
</span><span id="__span-22-64"><a id="__codelineno-22-64" name="__codelineno-22-64" href="#__codelineno-22-64"></a>            <span class="n">session_service</span><span class="o">=</span><span class="n">session_service_stateful</span> <span class="c1"># &lt;&lt;&lt; Use the service from Step 4</span>
</span><span id="__span-22-65"><a id="__codelineno-22-65" name="__codelineno-22-65" href="#__codelineno-22-65"></a>        <span class="p">)</span>
</span><span id="__span-22-66"><a id="__codelineno-22-66" name="__codelineno-22-66" href="#__codelineno-22-66"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Runner created for guardrail agent &#39;</span><span class="si">{</span><span class="n">runner_root_model_guardrail</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, using stateful session service.&quot;</span><span class="p">)</span>
</span><span id="__span-22-67"><a id="__codelineno-22-67" name="__codelineno-22-67" href="#__codelineno-22-67"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-22-68"><a id="__codelineno-22-68" name="__codelineno-22-68" href="#__codelineno-22-68"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Cannot create runner. &#39;session_service_stateful&#39; from Step 4 is missing.&quot;</span><span class="p">)</span>
</span><span id="__span-22-69"><a id="__codelineno-22-69" name="__codelineno-22-69" href="#__codelineno-22-69"></a>
</span><span id="__span-22-70"><a id="__codelineno-22-70" name="__codelineno-22-70" href="#__codelineno-22-70"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-22-71"><a id="__codelineno-22-71" name="__codelineno-22-71" href="#__codelineno-22-71"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Cannot create root agent with model guardrail. One or more prerequisites are missing or failed initialization:&quot;</span><span class="p">)</span>
</span><span id="__span-22-72"><a id="__codelineno-22-72" name="__codelineno-22-72" href="#__codelineno-22-72"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">greeting_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - Greeting Agent&quot;</span><span class="p">)</span>
</span><span id="__span-22-73"><a id="__codelineno-22-73" name="__codelineno-22-73" href="#__codelineno-22-73"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">farewell_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - Farewell Agent&quot;</span><span class="p">)</span>
</span><span id="__span-22-74"><a id="__codelineno-22-74" name="__codelineno-22-74" href="#__codelineno-22-74"></a>    <span class="k">if</span> <span class="s1">&#39;get_weather_stateful&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - &#39;get_weather_stateful&#39; tool&quot;</span><span class="p">)</span>
</span><span id="__span-22-75"><a id="__codelineno-22-75" name="__codelineno-22-75" href="#__codelineno-22-75"></a>    <span class="k">if</span> <span class="s1">&#39;block_keyword_guardrail&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - &#39;block_keyword_guardrail&#39; callback&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="3_2"><strong>3. 交互测试防护</strong></h3>
<p>让我们测试防护行为。我们将使用与第4步<em>相同的会话</em>(<code>SESSION_ID_STATEFUL</code>)，以显示状态在这些更改中持续存在。</p>
<ol>
<li>发送正常天气请求（应通过防护并执行）  </li>
<li>发送包含"BLOCK"的请求（应被回调拦截）  </li>
<li>发送问候（应通过根智能体的防护，被委派并正常执行）  </li>
</ol>
<div class="language-py highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># @title 3. Interact to Test the Model Input Guardrail</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="c1"># Ensure the runner for the guardrail agent is available</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="k">if</span> <span class="n">runner_root_model_guardrail</span><span class="p">:</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>  <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_guardrail_test_conversation</span><span class="p">():</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing Model Input Guardrail ---&quot;</span><span class="p">)</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>      <span class="c1"># Use the runner for the agent with the callback and the existing stateful session ID</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>      <span class="n">interaction_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">query</span><span class="p">:</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="p">,</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>      <span class="n">runner_root_model_guardrail</span><span class="p">,</span> <span class="n">USER_ID_STATEFUL</span><span class="p">,</span> <span class="n">SESSION_ID_STATEFUL</span> <span class="c1"># &lt;-- Pass correct IDs</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>  <span class="p">)</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>      <span class="c1"># 1. Normal request (Callback allows, should use Fahrenheit from Step 4 state change)</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>      <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;What is the weather in London?&quot;</span><span class="p">)</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>      <span class="c1"># 2. Request containing the blocked keyword</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>      <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;BLOCK the request for weather in Tokyo&quot;</span><span class="p">)</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>      <span class="c1"># 3. Normal greeting (Callback allows root agent, delegation happens)</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>      <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;Hello again&quot;</span><span class="p">)</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>  <span class="c1"># Execute the conversation</span>
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>  <span class="k">await</span> <span class="n">run_guardrail_test_conversation</span><span class="p">()</span>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>  <span class="c1"># Optional: Check state for the trigger flag set by the callback</span>
</span><span id="__span-23-26"><a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>  <span class="n">final_session</span> <span class="o">=</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-23-27"><a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>                                                       <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-23-28"><a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>                                                       <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span><span class="p">)</span>
</span><span id="__span-23-29"><a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>  <span class="k">if</span> <span class="n">final_session</span><span class="p">:</span>
</span><span id="__span-23-30"><a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Final Session State (After Guardrail Test) ---&quot;</span><span class="p">)</span>
</span><span id="__span-23-31"><a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Guardrail Triggered Flag: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;guardrail_block_keyword_triggered&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-23-32"><a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a>      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Last Weather Report: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_weather_report&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Should be London weather</span>
</span><span id="__span-23-33"><a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temperature Unit: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_preference_temperature_unit&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Should be Fahrenheit</span>
</span><span id="__span-23-34"><a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a>  <span class="k">else</span><span class="p">:</span>
</span><span id="__span-23-35"><a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a>      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">❌ Error: Could not retrieve final session state.&quot;</span><span class="p">)</span>
</span><span id="__span-23-36"><a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a>
</span><span id="__span-23-37"><a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-23-38"><a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ Skipping model guardrail test. Runner (&#39;runner_root_model_guardrail&#39;) is not available.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p>观察执行流程：</p>
<ol>
<li><strong>伦敦天气</strong>：回调为<code>weather_agent_v5_model_guardrail</code>运行，检查消息，打印"未找到关键词。允许LLM调用。"并返回<code>None</code>。智能体继续，调用<code>get_weather_stateful</code>工具（使用第4步状态更改的"华氏度"偏好）并返回天气。此响应通过<code>output_key</code>更新<code>last_weather_report</code>  </li>
<li><strong>BLOCK请求</strong>：回调再次为<code>weather_agent_v5_model_guardrail</code>运行，检查消息，找到"BLOCK"，打印"阻止LLM调用！"，设置状态标志，并返回预定义的<code>LlmResponse</code>。智能体的底层大模型<em>从未</em>为此轮次调用。用户看到回调的阻止消息  </li>
<li><strong>再次问候</strong>：回调为<code>weather_agent_v5_model_guardrail</code>运行，允许请求。根智能体然后委派给<code>greeting_agent</code>。<em>注意：定义在根智能体上的<code>before_model_callback</code>不会自动应用于子智能体</em>。<code>greeting_agent</code>正常进行，调用其<code>say_hello</code>工具并返回问候  </li>
</ol>
<p>你已成功实现输入安全层！<code>before_model_callback</code>提供强大机制在昂贵或潜在风险的大模型调用前执行规则和控制智能体行为。接下来，我们将应用类似概念为工具使用本身添加防护</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright Google 2025
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "content.code.copy", "content.tabs.link", "content.code.select", "navigation.instant", "navigation.instant.progress", "navigation.path", "navigation.top", "navigation.tracking", "navigation.indexes", "toc.follow"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>