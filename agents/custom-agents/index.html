
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Google ADK(Agent Development Kit ) 是由谷歌开源的 AI 代理框架，专为开发和部署 AI 代理而设计，支持 Gemini 模型和 Google AI 工具的紧密集成，一个开源的、代码优先的Python工具包，用于灵活可控地构建、评估和部署复杂AI智能体。">
      
      
      
        <link rel="canonical" href="https://google-agent-sdk.agentdevhub.com/agents/custom-agents/">
      
      
        <link rel="prev" href="../workflow-agents/parallel-agents/">
      
      
        <link rel="next" href="../multi-agents/">
      
      
      <link rel="icon" href="../../assets/agent-development-kit.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.11">
    
    
      
        <title>自定义代理 - Google ADK(Agent Development Kit ) 中文文档</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Google Sans";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="white">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      <!--
 Copyright 2025 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!-- Determine classes -->


  


<!-- Header -->
<header class="md-header md-header--shadow" data-md-component="header">
  <nav
    class="md-header__inner md-grid"
    aria-label="Header"
  >

    <!-- Link to home -->
    <a
      href="../.."
      title="Google ADK(Agent Development Kit ) 中文文档"
      class="md-header__button md-logo"
      aria-label="Google ADK(Agent Development Kit ) 中文文档"
      data-md-component="logo"
    >
      
  <img src="../../assets/agent-development-kit.png" alt="logo">

    </a>

    <!-- Button to open drawer -->
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>

    <!-- Header title -->
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            <a
      href="../.."
      title="Google ADK(Agent Development Kit ) 中文文档"
      aria-label="Google ADK(Agent Development Kit ) 中文文档"
      data-md-component="logo"
    >
            Google ADK(Agent Development Kit ) 中文文档
            </a>
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              自定义代理
            
            </a>
          </span>
        </div>
      </div>
    </div>

    <!-- Color palette toggle -->
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="white"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="white" data-md-color-accent="white"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    

    <!-- User preference: color palette -->
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    

    <!-- Site language selector -->
    

    <!-- Button to open search modal -->
    
      

      <!-- Check if search is actually enabled - see https://t.ly/DT_0V -->
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>

        <!-- Search interface -->
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    

    <!-- Repository information -->
    
      <div class="md-header__source">
        <a href="https://github.com/agentdevhub/Google-Agent-SDK" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    Google-Agent-SDK
  </div>
</a>
      </div>
    
  </nav>

  <!-- Navigation tabs (sticky) -->
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Google ADK(Agent Development Kit ) 中文文档" class="md-nav__button md-logo" aria-label="Google ADK(Agent Development Kit ) 中文文档" data-md-component="logo">
      
  <img src="../../assets/agent-development-kit.png" alt="logo">

    </a>
    Google ADK(Agent Development Kit ) 中文文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/agentdevhub/Google-Agent-SDK" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    Google-Agent-SDK
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    首页
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../get-started/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    入门指南
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            入门指南
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    安装指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    快速入门
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/quickstart-streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    快速入门 (streaming)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    教程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    测试方法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/google/adk-samples" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    示例代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    关于 ADK
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    代理系统
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            代理系统
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../llm-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LLM 代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../workflow-agents/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    工作流代理
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            工作流代理
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workflow-agents/sequential-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    顺序代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workflow-agents/loop-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    循环代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workflow-agents/parallel-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    并行代理
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    自定义代理
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    自定义代理
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      引言：超越预定义工作流
    </span>
  </a>
  
    <nav class="md-nav" aria-label="引言：超越预定义工作流">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      什么是自定义智能体？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      使用场景
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      实现自定义逻辑
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      管理子智能体与状态
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storyflowagent" class="md-nav__link">
    <span class="md-ellipsis">
      设计模式示例：StoryFlowAgent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="设计模式示例：StoryFlowAgent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      第一部分：简化自定义智能体初始化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      第二部分：定义自定义执行逻辑
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm" class="md-nav__link">
    <span class="md-ellipsis">
      第三部分：定义LLM子智能体
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      第四部分：实例化并运行自定义智能体
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      完整代码示例
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multi-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    多代理系统
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    模型
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../tools/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    工具集
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            工具集
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/function-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    函数工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/built-in-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    内置工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/third-party-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    第三方工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/google-cloud-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Google Cloud 工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/mcp-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MCP 工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/openapi-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OpenAPI 工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/authentication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    身份验证
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../deploy/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    部署
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            部署
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/agent-engine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent Engine
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/cloud-run/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cloud Run
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../sessions/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    会话与记忆
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            会话与记忆
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sessions/session/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    会话
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sessions/state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    状态
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sessions/memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    记忆机制
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../artifacts/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    制品
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            制品
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../callbacks/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    回调函数
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            回调函数
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../callbacks/types-of-callbacks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    回调类型
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../callbacks/design-patterns-and-best-practices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    回调模式
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../runtime/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    运行时
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            运行时
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../events/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    事件
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            事件
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../context/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    上下文
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            上下文
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../evaluate/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    评估
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            评估
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    指南
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            指南
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/responsible-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    负责任代理指南
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    贡献指南
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API 参考
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      引言：超越预定义工作流
    </span>
  </a>
  
    <nav class="md-nav" aria-label="引言：超越预定义工作流">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      什么是自定义智能体？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      使用场景
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      实现自定义逻辑
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      管理子智能体与状态
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storyflowagent" class="md-nav__link">
    <span class="md-ellipsis">
      设计模式示例：StoryFlowAgent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="设计模式示例：StoryFlowAgent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      第一部分：简化自定义智能体初始化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      第二部分：定义自定义执行逻辑
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm" class="md-nav__link">
    <span class="md-ellipsis">
      第三部分：定义LLM子智能体
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      第四部分：实例化并运行自定义智能体
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      完整代码示例
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<div class="admonition warning">
<p class="admonition-title">高级概念</p>
<p>通过直接实现 <code>_run_async_impl</code> 来构建自定义智能体虽然能提供强大的控制能力，但比使用预定义的 <code>LlmAgent</code> 或标准 <code>WorkflowAgent</code> 类型更为复杂。建议先掌握基础智能体类型，再着手处理自定义编排逻辑。</p>
</div>
<h1 id="_1">自定义智能体</h1>
<p>自定义智能体为ADK提供了终极灵活性，允许您通过直接继承 <code>BaseAgent</code> 并实现自己的控制流来定义<strong>任意编排逻辑</strong>。这超越了 <code>SequentialAgent</code>、<code>LoopAgent</code> 和 <code>ParallelAgent</code> 的预定义模式，使您能够构建高度定制化的复杂智能体工作流。</p>
<h2 id="_2">引言：超越预定义工作流</h2>
<h3 id="_3">什么是自定义智能体？</h3>
<p>自定义智能体本质上是任何继承自 <code>google.adk.agents.BaseAgent</code> 并在异步方法 <code>_run_async_impl</code> 中实现核心执行逻辑的类。您可以完全控制该方法如何调用其他智能体（子智能体）、管理状态和处理事件。</p>
<h3 id="_4">使用场景</h3>
<p>虽然标准<a href="../workflow-agents/">工作流智能体</a>（<code>SequentialAgent</code>、<code>LoopAgent</code>、<code>ParallelAgent</code>）涵盖了常见编排模式，但在以下场景需要自定义智能体：</p>
<ul>
<li><strong>条件逻辑</strong>：根据运行时条件或上一步结果执行不同的子智能体或路径</li>
<li><strong>复杂状态管理</strong>：实现超越简单顺序传递的精细状态维护逻辑</li>
<li><strong>外部集成</strong>：在编排流控制中直接调用外部API、数据库或自定义Python库</li>
<li><strong>动态智能体选择</strong>：根据对情境或输入的动态评估选择后续子智能体</li>
<li><strong>独特工作流模式</strong>：实现不符合标准顺序、并行或循环结构的编排逻辑</li>
</ul>
<p><img alt="intro_components.png" src="../../assets/custom-agent-flow.png" /></p>
<h2 id="_5">实现自定义逻辑</h2>
<p>自定义智能体的核心是 <code>_run_async_impl</code> 方法，这里定义了其独特行为：</p>
<ul>
<li><strong>签名</strong>：<code>async def _run_async_impl(self, ctx: InvocationContext) -&gt; AsyncGenerator[Event, None]:</code></li>
<li><strong>异步生成器</strong>：必须是 <code>async def</code> 函数并返回 <code>AsyncGenerator</code>，以便将子智能体或自身逻辑产生的事件 <code>yield</code> 回传给运行器</li>
<li><strong><code>ctx</code>（调用上下文）</strong>：提供关键运行时信息访问，最重要的是 <code>ctx.session.state</code>——这是自定义智能体编排的步骤间共享数据的主要方式</li>
</ul>
<p><strong><code>_run_async_impl</code> 中的关键能力</strong>：</p>
<ol>
<li>
<p><strong>调用子智能体</strong>：使用子智能体的 <code>run_async</code> 方法调用它们（通常存储为实例属性如 <code>self.my_llm_agent</code>）并生成其事件：
    <div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">some_sub_agent</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="c1"># 可选检查或记录事件</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">yield</span> <span class="n">event</span> <span class="c1"># 向上传递事件</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>状态管理</strong>：通过会话状态字典（<code>ctx.session.state</code>）在子智能体调用间传递数据或做出决策：
    <div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># 读取前序智能体设置的数据</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">previous_result</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;some_key&quot;</span><span class="p">)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="c1"># 基于状态决策</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="k">if</span> <span class="n">previous_result</span> <span class="o">==</span> <span class="s2">&quot;some_value&quot;</span><span class="p">:</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="c1"># ... 调用特定子智能体 ...</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    <span class="c1"># ... 调用其他子智能体 ...</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="c1"># 存储结果供后续步骤使用（通常通过子智能体的output_key实现）</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="c1"># ctx.session.state[&quot;my_custom_result&quot;] = &quot;calculated_value&quot;</span>
</span></code></pre></div></p>
</li>
<li>
<p><strong>实现控制流</strong>：使用标准Python结构（<code>if</code>/<code>elif</code>/<code>else</code>、<code>for</code>/<code>while</code> 循环、<code>try</code>/<code>except</code>）创建涉及子智能体的复杂条件或迭代工作流</p>
</li>
</ol>
<h2 id="_6">管理子智能体与状态</h2>
<p>通常自定义智能体会编排其他智能体（如 <code>LlmAgent</code>、<code>LoopAgent</code> 等）：</p>
<ul>
<li><strong>初始化</strong>：通常将这些子智能体实例传入自定义智能体的 <code>__init__</code> 方法并存储为实例属性（如 <code>self.story_generator = story_generator_instance</code>），以便在 <code>_run_async_impl</code> 中访问</li>
<li><strong><code>sub_agents</code> 列表</strong>：使用 <code>super().__init__(...)</code> 初始化 <code>BaseAgent</code> 时应传递 <code>sub_agents</code> 列表，告知ADK框架该自定义智能体直接管理的子智能体层级关系。这对生命周期管理、内省等框架功能至关重要，即使 <code>_run_async_impl</code> 通过 <code>self.xxx_agent</code> 直接调用智能体</li>
<li><strong>状态</strong>：如前所述，<code>ctx.session.state</code> 是子智能体（特别是使用 <code>output_key</code> 的 <code>LlmAgent</code>）与编排器通信的标准方式，也是编排器向下传递必要输入的通道</li>
</ul>
<h2 id="storyflowagent">设计模式示例：<code>StoryFlowAgent</code></h2>
<p>通过示例展示自定义智能体的强大能力：包含条件逻辑的多阶段内容生成工作流。</p>
<p><strong>目标</strong>：创建生成故事→通过评审修订迭代优化→执行最终检查→<em>若最终语气检查失败则重新生成故事</em>的系统</p>
<p><strong>为何自定义</strong>：核心需求是<strong>基于语气检查结果的条件性重新生成</strong>。标准工作流智能体没有基于子智能体任务结果的条件分支功能，需要在编排器中实现自定义Python逻辑（<code>if tone == "negative": ...</code>）</p>
<hr />
<h3 id="_7">第一部分：简化自定义智能体初始化</h3>
<p>定义继承自 <code>BaseAgent</code> 的 <code>StoryFlowAgent</code>。在 <code>__init__</code> 中存储必要子智能体（传入）为实例属性，并告知 <code>BaseAgent</code> 框架该自定义智能体直接管理的顶层智能体。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">StoryFlowAgent</span><span class="p">(</span><span class="n">BaseAgent</span><span class="p">):</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="sd">    Custom agent for a story generation and refinement workflow.</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="sd">    This agent orchestrates a sequence of LLM agents to generate a story,</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="sd">    critique it, revise it, check grammar and tone, and potentially</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="sd">    regenerate the story if the tone is negative.</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>    <span class="c1"># --- Field Declarations for Pydantic ---</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    <span class="c1"># Declare the agents passed during initialization as class attributes with type hints</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    <span class="n">story_generator</span><span class="p">:</span> <span class="n">LlmAgent</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    <span class="n">critic</span><span class="p">:</span> <span class="n">LlmAgent</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    <span class="n">reviser</span><span class="p">:</span> <span class="n">LlmAgent</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span class="n">grammar_check</span><span class="p">:</span> <span class="n">LlmAgent</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>    <span class="n">tone_check</span><span class="p">:</span> <span class="n">LlmAgent</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>    <span class="n">loop_agent</span><span class="p">:</span> <span class="n">LoopAgent</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>    <span class="n">sequential_agent</span><span class="p">:</span> <span class="n">SequentialAgent</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>    <span class="c1"># model_config allows setting Pydantic configurations if needed, e.g., arbitrary_types_allowed</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>    <span class="n">model_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;arbitrary_types_allowed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>        <span class="n">story_generator</span><span class="p">:</span> <span class="n">LlmAgent</span><span class="p">,</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>        <span class="n">critic</span><span class="p">:</span> <span class="n">LlmAgent</span><span class="p">,</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>        <span class="n">reviser</span><span class="p">:</span> <span class="n">LlmAgent</span><span class="p">,</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>        <span class="n">grammar_check</span><span class="p">:</span> <span class="n">LlmAgent</span><span class="p">,</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>        <span class="n">tone_check</span><span class="p">:</span> <span class="n">LlmAgent</span><span class="p">,</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>    <span class="p">):</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="sd">        Initializes the StoryFlowAgent.</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="sd">        Args:</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a><span class="sd">            name: The name of the agent.</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a><span class="sd">            story_generator: An LlmAgent to generate the initial story.</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a><span class="sd">            critic: An LlmAgent to critique the story.</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="sd">            reviser: An LlmAgent to revise the story based on criticism.</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="sd">            grammar_check: An LlmAgent to check the grammar.</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="sd">            tone_check: An LlmAgent to analyze the tone.</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>        <span class="c1"># Create internal agents *before* calling super().__init__</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>        <span class="n">loop_agent</span> <span class="o">=</span> <span class="n">LoopAgent</span><span class="p">(</span>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CriticReviserLoop&quot;</span><span class="p">,</span> <span class="n">sub_agents</span><span class="o">=</span><span class="p">[</span><span class="n">critic</span><span class="p">,</span> <span class="n">reviser</span><span class="p">],</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">2</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>        <span class="p">)</span>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>        <span class="n">sequential_agent</span> <span class="o">=</span> <span class="n">SequentialAgent</span><span class="p">(</span>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PostProcessing&quot;</span><span class="p">,</span> <span class="n">sub_agents</span><span class="o">=</span><span class="p">[</span><span class="n">grammar_check</span><span class="p">,</span> <span class="n">tone_check</span><span class="p">]</span>
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>        <span class="p">)</span>
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>        <span class="c1"># Define the sub_agents list for the framework</span>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>        <span class="n">sub_agents_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-2-54"><a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>            <span class="n">story_generator</span><span class="p">,</span>
</span><span id="__span-2-55"><a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>            <span class="n">loop_agent</span><span class="p">,</span>
</span><span id="__span-2-56"><a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>            <span class="n">sequential_agent</span><span class="p">,</span>
</span><span id="__span-2-57"><a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>        <span class="p">]</span>
</span><span id="__span-2-58"><a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>
</span><span id="__span-2-59"><a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a>        <span class="c1"># Pydantic will validate and assign them based on the class annotations.</span>
</span><span id="__span-2-60"><a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="__span-2-61"><a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a>            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-2-62"><a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a>            <span class="n">story_generator</span><span class="o">=</span><span class="n">story_generator</span><span class="p">,</span>
</span><span id="__span-2-63"><a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a>            <span class="n">critic</span><span class="o">=</span><span class="n">critic</span><span class="p">,</span>
</span><span id="__span-2-64"><a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a>            <span class="n">reviser</span><span class="o">=</span><span class="n">reviser</span><span class="p">,</span>
</span><span id="__span-2-65"><a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a>            <span class="n">grammar_check</span><span class="o">=</span><span class="n">grammar_check</span><span class="p">,</span>
</span><span id="__span-2-66"><a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a>            <span class="n">tone_check</span><span class="o">=</span><span class="n">tone_check</span><span class="p">,</span>
</span><span id="__span-2-67"><a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a>            <span class="n">loop_agent</span><span class="o">=</span><span class="n">loop_agent</span><span class="p">,</span>
</span><span id="__span-2-68"><a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a>            <span class="n">sequential_agent</span><span class="o">=</span><span class="n">sequential_agent</span><span class="p">,</span>
</span><span id="__span-2-69"><a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a>            <span class="n">sub_agents</span><span class="o">=</span><span class="n">sub_agents_list</span><span class="p">,</span> <span class="c1"># Pass the sub_agents list directly</span>
</span><span id="__span-2-70"><a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a>        <span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="_8">第二部分：定义自定义执行逻辑</h3>
<p>该方法使用标准Python async/await和控制流编排子智能体：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>    <span class="nd">@override</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run_async_impl</span><span class="p">(</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">InvocationContext</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">Event</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="sd">        Implements the custom orchestration logic for the story workflow.</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="sd">        Uses the instance attributes assigned by Pydantic (e.g., self.story_generator).</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Starting story generation workflow.&quot;</span><span class="p">)</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>        <span class="c1"># 1. Initial Story Generation</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Running StoryGenerator...&quot;</span><span class="p">)</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">story_generator</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Event from StoryGenerator: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>            <span class="k">yield</span> <span class="n">event</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>        <span class="c1"># Check if story was generated before proceeding</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>        <span class="k">if</span> <span class="s2">&quot;current_story&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">state</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;current_story&quot;</span><span class="p">]:</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Failed to generate initial story. Aborting workflow.&quot;</span><span class="p">)</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>             <span class="k">return</span> <span class="c1"># Stop processing if initial story failed</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Story state after generator: </span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_story&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>        <span class="c1"># 2. Critic-Reviser Loop</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Running CriticReviserLoop...&quot;</span><span class="p">)</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>        <span class="c1"># Use the loop_agent instance attribute assigned during init</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_agent</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Event from CriticReviserLoop: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>            <span class="k">yield</span> <span class="n">event</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Story state after loop: </span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_story&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>        <span class="c1"># 3. Sequential Post-Processing (Grammar and Tone Check)</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Running PostProcessing...&quot;</span><span class="p">)</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>        <span class="c1"># Use the sequential_agent instance attribute assigned during init</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequential_agent</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Event from PostProcessing: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>            <span class="k">yield</span> <span class="n">event</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a>        <span class="c1"># 4. Tone-Based Conditional Logic</span>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a>        <span class="n">tone_check_result</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tone_check_result&quot;</span><span class="p">)</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Tone check result: </span><span class="si">{</span><span class="n">tone_check_result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>        <span class="k">if</span> <span class="n">tone_check_result</span> <span class="o">==</span> <span class="s2">&quot;negative&quot;</span><span class="p">:</span>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Tone is negative. Regenerating story...&quot;</span><span class="p">)</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a>            <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">story_generator</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Event from StoryGenerator (Regen): </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a>                <span class="k">yield</span> <span class="n">event</span>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Tone is not negative. Keeping current story.&quot;</span><span class="p">)</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a>            <span class="k">pass</span>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Workflow finished.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>逻辑说明</strong>：</p>
<ol>
<li>初始运行 <code>story_generator</code>，其输出预期存入 <code>ctx.session.state["current_story"]</code></li>
<li>运行 <code>loop_agent</code>（内部调用 <code>critic</code> 和 <code>reviser</code> 进行 <code>max_iterations</code> 次迭代），它们从/向状态读写 <code>current_story</code> 和 <code>criticism</code></li>
<li>运行 <code>sequential_agent</code>（调用 <code>grammar_check</code> 和 <code>tone_check</code>），读取 <code>current_story</code> 并向状态写入 <code>grammar_suggestions</code> 和 <code>tone_check_result</code></li>
<li><strong>自定义部分</strong>：<code>if</code> 语句检查状态中的 <code>tone_check_result</code>，若为"negative"则再次调用 <code>story_generator</code> 覆盖状态中的 <code>current_story</code>，否则结束流程</li>
</ol>
<hr />
<h3 id="llm">第三部分：定义LLM子智能体</h3>
<p>这些是标准 <code>LlmAgent</code> 定义，负责特定任务。其 <code>output_key</code> 参数对将结果存入 <code>session.state</code>（供其他智能体或自定义编排器访问）至关重要。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">GEMINI_FLASH</span> <span class="o">=</span> <span class="s2">&quot;gemini-2.0-flash&quot;</span> <span class="c1"># Define model constant</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="c1"># --- Define the individual LLM agents ---</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="n">story_generator</span> <span class="o">=</span> <span class="n">LlmAgent</span><span class="p">(</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;StoryGenerator&quot;</span><span class="p">,</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="n">model</span><span class="o">=</span><span class="n">GEMINI_2_FLASH</span><span class="p">,</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;You are a story writer. Write a short story (around 100 words) about a cat,</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="s2">based on the topic provided in session state with key &#39;topic&#39;&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>    <span class="n">input_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;current_story&quot;</span><span class="p">,</span>  <span class="c1"># Key for storing output in session state</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="p">)</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="n">critic</span> <span class="o">=</span> <span class="n">LlmAgent</span><span class="p">(</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Critic&quot;</span><span class="p">,</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="n">model</span><span class="o">=</span><span class="n">GEMINI_2_FLASH</span><span class="p">,</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;You are a story critic. Review the story provided in</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="s2">session state with key &#39;current_story&#39;. Provide 1-2 sentences of constructive criticism</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="s2">on how to improve it. Focus on plot or character.&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>    <span class="n">input_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>    <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;criticism&quot;</span><span class="p">,</span>  <span class="c1"># Key for storing criticism in session state</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="p">)</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="n">reviser</span> <span class="o">=</span> <span class="n">LlmAgent</span><span class="p">(</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Reviser&quot;</span><span class="p">,</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>    <span class="n">model</span><span class="o">=</span><span class="n">GEMINI_2_FLASH</span><span class="p">,</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>    <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;You are a story reviser. Revise the story provided in</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="s2">session state with key &#39;current_story&#39;, based on the criticism in</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="s2">session state with key &#39;criticism&#39;. Output only the revised story.&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>    <span class="n">input_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>    <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;current_story&quot;</span><span class="p">,</span>  <span class="c1"># Overwrites the original story</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="p">)</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a><span class="n">grammar_check</span> <span class="o">=</span> <span class="n">LlmAgent</span><span class="p">(</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;GrammarCheck&quot;</span><span class="p">,</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>    <span class="n">model</span><span class="o">=</span><span class="n">GEMINI_2_FLASH</span><span class="p">,</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>    <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;You are a grammar checker. Check the grammar of the story</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a><span class="s2">provided in session state with key &#39;current_story&#39;. Output only the suggested</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a><span class="s2">corrections as a list, or output &#39;Grammar is good!&#39; if there are no errors.&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>    <span class="n">input_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>    <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;grammar_suggestions&quot;</span><span class="p">,</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a><span class="p">)</span>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a><span class="n">tone_check</span> <span class="o">=</span> <span class="n">LlmAgent</span><span class="p">(</span>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ToneCheck&quot;</span><span class="p">,</span>
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>    <span class="n">model</span><span class="o">=</span><span class="n">GEMINI_2_FLASH</span><span class="p">,</span>
</span><span id="__span-4-45"><a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>    <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;You are a tone analyzer. Analyze the tone of the story</span>
</span><span id="__span-4-46"><a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a><span class="s2">provided in session state with key &#39;current_story&#39;. Output only one word: &#39;positive&#39; if</span>
</span><span id="__span-4-47"><a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a><span class="s2">the tone is generally positive, &#39;negative&#39; if the tone is generally negative, or &#39;neutral&#39;</span>
</span><span id="__span-4-48"><a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a><span class="s2">otherwise.&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-4-49"><a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>    <span class="n">input_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-4-50"><a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>    <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;tone_check_result&quot;</span><span class="p">,</span> <span class="c1"># This agent&#39;s output determines the conditional flow</span>
</span><span id="__span-4-51"><a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a><span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="_9">第四部分：实例化并运行自定义智能体</h3>
<p>最后实例化 <code>StoryFlowAgent</code> 并照常使用 <code>Runner</code>：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># --- Create the custom agent instance ---</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">story_flow_agent</span> <span class="o">=</span> <span class="n">StoryFlowAgent</span><span class="p">(</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;StoryFlowAgent&quot;</span><span class="p">,</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>    <span class="n">story_generator</span><span class="o">=</span><span class="n">story_generator</span><span class="p">,</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    <span class="n">critic</span><span class="o">=</span><span class="n">critic</span><span class="p">,</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="n">reviser</span><span class="o">=</span><span class="n">reviser</span><span class="p">,</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="n">grammar_check</span><span class="o">=</span><span class="n">grammar_check</span><span class="p">,</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="n">tone_check</span><span class="o">=</span><span class="n">tone_check</span><span class="p">,</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="p">)</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="c1"># --- Setup Runner and Session ---</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="n">session_service</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;topic&quot;</span><span class="p">:</span> <span class="s2">&quot;a brave kitten exploring a haunted house&quot;</span><span class="p">}</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="n">session</span> <span class="o">=</span> <span class="n">session_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>    <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>    <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>    <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">,</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>    <span class="n">state</span><span class="o">=</span><span class="n">initial_state</span> <span class="c1"># Pass initial state here</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="p">)</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial session state: </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a><span class="n">runner</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>    <span class="n">agent</span><span class="o">=</span><span class="n">story_flow_agent</span><span class="p">,</span> <span class="c1"># Pass the custom orchestrator agent</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>    <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>    <span class="n">session_service</span><span class="o">=</span><span class="n">session_service</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a><span class="p">)</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="c1"># --- Function to Interact with the Agent ---</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="k">def</span><span class="w"> </span><span class="nf">call_agent</span><span class="p">(</span><span class="n">user_input_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a><span class="sd">    Sends a new topic to the agent (overwriting the initial one if needed)</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a><span class="sd">    and runs the workflow.</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>    <span class="n">current_session</span> <span class="o">=</span> <span class="n">session_service</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span> 
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>                                                  <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span> 
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>                                                  <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">current_session</span><span class="p">:</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Session not found!&quot;</span><span class="p">)</span>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>        <span class="k">return</span>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>    <span class="n">current_session</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;topic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_input_topic</span>
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated session state topic to: </span><span class="si">{</span><span class="n">user_input_topic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>    <span class="n">content</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Generate a story about: </span><span class="si">{</span><span class="n">user_input_topic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
</span><span id="__span-5-45"><a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>    <span class="n">events</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">,</span> <span class="n">new_message</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
</span><span id="__span-5-46"><a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>
</span><span id="__span-5-47"><a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>    <span class="n">final_response</span> <span class="o">=</span> <span class="s2">&quot;No final response captured.&quot;</span>
</span><span id="__span-5-48"><a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="__span-5-49"><a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_final_response</span><span class="p">()</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span><span id="__span-5-50"><a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Potential final response from [</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">author</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-5-51"><a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>            <span class="n">final_response</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
</span><span id="__span-5-52"><a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>
</span><span id="__span-5-53"><a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Agent Interaction Result ---&quot;</span><span class="p">)</span>
</span><span id="__span-5-54"><a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Agent Final Response: &quot;</span><span class="p">,</span> <span class="n">final_response</span><span class="p">)</span>
</span><span id="__span-5-55"><a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>
</span><span id="__span-5-56"><a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>    <span class="n">final_session</span> <span class="o">=</span> <span class="n">session_service</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span> 
</span><span id="__span-5-57"><a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>                                                <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span> 
</span><span id="__span-5-58"><a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>                                                <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-5-59"><a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final Session State:&quot;</span><span class="p">)</span>
</span><span id="__span-5-60"><a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-5-61"><a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span><span id="__span-5-62"><a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-5-63"><a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a>
</span><span id="__span-5-64"><a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a><span class="c1"># --- Run the Agent ---</span>
</span><span id="__span-5-65"><a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a><span class="n">call_agent</span><span class="p">(</span><span class="s2">&quot;a lonely robot finding a friend in a junkyard&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>（注：完整可运行代码包括导入和执行逻辑，参见下方链接）</p>
<hr />
<h2 id="_10">完整代码示例</h2>
<details open="open">
<summary>Storyflow智能体</summary>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># StoryFlowAgent示例的完整可运行代码</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncGenerator</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">override</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">LlmAgent</span><span class="p">,</span> <span class="n">BaseAgent</span><span class="p">,</span> <span class="n">LoopAgent</span><span class="p">,</span> <span class="n">SequentialAgent</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.agents.invocation_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvocationContext</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.genai</span><span class="w"> </span><span class="kn">import</span> <span class="n">types</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.sessions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemorySessionService</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.runners</span><span class="w"> </span><span class="kn">import</span> <span class="n">Runner</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.events</span><span class="w"> </span><span class="kn">import</span> <span class="n">Event</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="c1"># --- Constants ---</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="n">APP_NAME</span> <span class="o">=</span> <span class="s2">&quot;story_app&quot;</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="n">USER_ID</span> <span class="o">=</span> <span class="s2">&quot;12345&quot;</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="n">SESSION_ID</span> <span class="o">=</span> <span class="s2">&quot;123344&quot;</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="n">GEMINI_2_FLASH</span> <span class="o">=</span> <span class="s2">&quot;gemini-2.0-flash&quot;</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="c1"># --- Configure Logging ---</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="c1"># --- Custom Orchestrator Agent ---</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="k">class</span><span class="w"> </span><span class="nc">StoryFlowAgent</span><span class="p">(</span><span class="n">BaseAgent</span><span class="p">):</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="sd">    Custom agent for a story generation and refinement workflow.</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="sd">    This agent orchestrates a sequence of LLM agents to generate a story,</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="sd">    critique it, revise it, check grammar and tone, and potentially</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="sd">    regenerate the story if the tone is negative.</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>    <span class="c1"># --- Field Declarations for Pydantic ---</span>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>    <span class="c1"># Declare the agents passed during initialization as class attributes with type hints</span>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>    <span class="n">story_generator</span><span class="p">:</span> <span class="n">LlmAgent</span>
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>    <span class="n">critic</span><span class="p">:</span> <span class="n">LlmAgent</span>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>    <span class="n">reviser</span><span class="p">:</span> <span class="n">LlmAgent</span>
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>    <span class="n">grammar_check</span><span class="p">:</span> <span class="n">LlmAgent</span>
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>    <span class="n">tone_check</span><span class="p">:</span> <span class="n">LlmAgent</span>
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>    <span class="n">loop_agent</span><span class="p">:</span> <span class="n">LoopAgent</span>
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>    <span class="n">sequential_agent</span><span class="p">:</span> <span class="n">SequentialAgent</span>
</span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>
</span><span id="__span-6-46"><a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>    <span class="c1"># model_config allows setting Pydantic configurations if needed, e.g., arbitrary_types_allowed</span>
</span><span id="__span-6-47"><a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>    <span class="n">model_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;arbitrary_types_allowed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span><span id="__span-6-48"><a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>
</span><span id="__span-6-49"><a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="__span-6-50"><a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-6-51"><a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-6-52"><a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>        <span class="n">story_generator</span><span class="p">:</span> <span class="n">LlmAgent</span><span class="p">,</span>
</span><span id="__span-6-53"><a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>        <span class="n">critic</span><span class="p">:</span> <span class="n">LlmAgent</span><span class="p">,</span>
</span><span id="__span-6-54"><a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>        <span class="n">reviser</span><span class="p">:</span> <span class="n">LlmAgent</span><span class="p">,</span>
</span><span id="__span-6-55"><a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a>        <span class="n">grammar_check</span><span class="p">:</span> <span class="n">LlmAgent</span><span class="p">,</span>
</span><span id="__span-6-56"><a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a>        <span class="n">tone_check</span><span class="p">:</span> <span class="n">LlmAgent</span><span class="p">,</span>
</span><span id="__span-6-57"><a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>    <span class="p">):</span>
</span><span id="__span-6-58"><a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-6-59"><a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a><span class="sd">        Initializes the StoryFlowAgent.</span>
</span><span id="__span-6-60"><a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a>
</span><span id="__span-6-61"><a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a><span class="sd">        Args:</span>
</span><span id="__span-6-62"><a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a><span class="sd">            name: The name of the agent.</span>
</span><span id="__span-6-63"><a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a><span class="sd">            story_generator: An LlmAgent to generate the initial story.</span>
</span><span id="__span-6-64"><a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a><span class="sd">            critic: An LlmAgent to critique the story.</span>
</span><span id="__span-6-65"><a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a><span class="sd">            reviser: An LlmAgent to revise the story based on criticism.</span>
</span><span id="__span-6-66"><a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a><span class="sd">            grammar_check: An LlmAgent to check the grammar.</span>
</span><span id="__span-6-67"><a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a><span class="sd">            tone_check: An LlmAgent to analyze the tone.</span>
</span><span id="__span-6-68"><a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-6-69"><a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a>        <span class="c1"># Create internal agents *before* calling super().__init__</span>
</span><span id="__span-6-70"><a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a>        <span class="n">loop_agent</span> <span class="o">=</span> <span class="n">LoopAgent</span><span class="p">(</span>
</span><span id="__span-6-71"><a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CriticReviserLoop&quot;</span><span class="p">,</span> <span class="n">sub_agents</span><span class="o">=</span><span class="p">[</span><span class="n">critic</span><span class="p">,</span> <span class="n">reviser</span><span class="p">],</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">2</span>
</span><span id="__span-6-72"><a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a>        <span class="p">)</span>
</span><span id="__span-6-73"><a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a>        <span class="n">sequential_agent</span> <span class="o">=</span> <span class="n">SequentialAgent</span><span class="p">(</span>
</span><span id="__span-6-74"><a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PostProcessing&quot;</span><span class="p">,</span> <span class="n">sub_agents</span><span class="o">=</span><span class="p">[</span><span class="n">grammar_check</span><span class="p">,</span> <span class="n">tone_check</span><span class="p">]</span>
</span><span id="__span-6-75"><a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a>        <span class="p">)</span>
</span><span id="__span-6-76"><a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a>
</span><span id="__span-6-77"><a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a>        <span class="c1"># Define the sub_agents list for the framework</span>
</span><span id="__span-6-78"><a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a>        <span class="n">sub_agents_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-6-79"><a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a>            <span class="n">story_generator</span><span class="p">,</span>
</span><span id="__span-6-80"><a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a>            <span class="n">loop_agent</span><span class="p">,</span>
</span><span id="__span-6-81"><a id="__codelineno-6-81" name="__codelineno-6-81" href="#__codelineno-6-81"></a>            <span class="n">sequential_agent</span><span class="p">,</span>
</span><span id="__span-6-82"><a id="__codelineno-6-82" name="__codelineno-6-82" href="#__codelineno-6-82"></a>        <span class="p">]</span>
</span><span id="__span-6-83"><a id="__codelineno-6-83" name="__codelineno-6-83" href="#__codelineno-6-83"></a>
</span><span id="__span-6-84"><a id="__codelineno-6-84" name="__codelineno-6-84" href="#__codelineno-6-84"></a>        <span class="c1"># Pydantic will validate and assign them based on the class annotations.</span>
</span><span id="__span-6-85"><a id="__codelineno-6-85" name="__codelineno-6-85" href="#__codelineno-6-85"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="__span-6-86"><a id="__codelineno-6-86" name="__codelineno-6-86" href="#__codelineno-6-86"></a>            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-6-87"><a id="__codelineno-6-87" name="__codelineno-6-87" href="#__codelineno-6-87"></a>            <span class="n">story_generator</span><span class="o">=</span><span class="n">story_generator</span><span class="p">,</span>
</span><span id="__span-6-88"><a id="__codelineno-6-88" name="__codelineno-6-88" href="#__codelineno-6-88"></a>            <span class="n">critic</span><span class="o">=</span><span class="n">critic</span><span class="p">,</span>
</span><span id="__span-6-89"><a id="__codelineno-6-89" name="__codelineno-6-89" href="#__codelineno-6-89"></a>            <span class="n">reviser</span><span class="o">=</span><span class="n">reviser</span><span class="p">,</span>
</span><span id="__span-6-90"><a id="__codelineno-6-90" name="__codelineno-6-90" href="#__codelineno-6-90"></a>            <span class="n">grammar_check</span><span class="o">=</span><span class="n">grammar_check</span><span class="p">,</span>
</span><span id="__span-6-91"><a id="__codelineno-6-91" name="__codelineno-6-91" href="#__codelineno-6-91"></a>            <span class="n">tone_check</span><span class="o">=</span><span class="n">tone_check</span><span class="p">,</span>
</span><span id="__span-6-92"><a id="__codelineno-6-92" name="__codelineno-6-92" href="#__codelineno-6-92"></a>            <span class="n">loop_agent</span><span class="o">=</span><span class="n">loop_agent</span><span class="p">,</span>
</span><span id="__span-6-93"><a id="__codelineno-6-93" name="__codelineno-6-93" href="#__codelineno-6-93"></a>            <span class="n">sequential_agent</span><span class="o">=</span><span class="n">sequential_agent</span><span class="p">,</span>
</span><span id="__span-6-94"><a id="__codelineno-6-94" name="__codelineno-6-94" href="#__codelineno-6-94"></a>            <span class="n">sub_agents</span><span class="o">=</span><span class="n">sub_agents_list</span><span class="p">,</span> <span class="c1"># Pass the sub_agents list directly</span>
</span><span id="__span-6-95"><a id="__codelineno-6-95" name="__codelineno-6-95" href="#__codelineno-6-95"></a>        <span class="p">)</span>
</span><span id="__span-6-96"><a id="__codelineno-6-96" name="__codelineno-6-96" href="#__codelineno-6-96"></a>
</span><span id="__span-6-97"><a id="__codelineno-6-97" name="__codelineno-6-97" href="#__codelineno-6-97"></a>    <span class="nd">@override</span>
</span><span id="__span-6-98"><a id="__codelineno-6-98" name="__codelineno-6-98" href="#__codelineno-6-98"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run_async_impl</span><span class="p">(</span>
</span><span id="__span-6-99"><a id="__codelineno-6-99" name="__codelineno-6-99" href="#__codelineno-6-99"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">InvocationContext</span>
</span><span id="__span-6-100"><a id="__codelineno-6-100" name="__codelineno-6-100" href="#__codelineno-6-100"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">Event</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="__span-6-101"><a id="__codelineno-6-101" name="__codelineno-6-101" href="#__codelineno-6-101"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-6-102"><a id="__codelineno-6-102" name="__codelineno-6-102" href="#__codelineno-6-102"></a><span class="sd">        Implements the custom orchestration logic for the story workflow.</span>
</span><span id="__span-6-103"><a id="__codelineno-6-103" name="__codelineno-6-103" href="#__codelineno-6-103"></a><span class="sd">        Uses the instance attributes assigned by Pydantic (e.g., self.story_generator).</span>
</span><span id="__span-6-104"><a id="__codelineno-6-104" name="__codelineno-6-104" href="#__codelineno-6-104"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-6-105"><a id="__codelineno-6-105" name="__codelineno-6-105" href="#__codelineno-6-105"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Starting story generation workflow.&quot;</span><span class="p">)</span>
</span><span id="__span-6-106"><a id="__codelineno-6-106" name="__codelineno-6-106" href="#__codelineno-6-106"></a>
</span><span id="__span-6-107"><a id="__codelineno-6-107" name="__codelineno-6-107" href="#__codelineno-6-107"></a>        <span class="c1"># 1. Initial Story Generation</span>
</span><span id="__span-6-108"><a id="__codelineno-6-108" name="__codelineno-6-108" href="#__codelineno-6-108"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Running StoryGenerator...&quot;</span><span class="p">)</span>
</span><span id="__span-6-109"><a id="__codelineno-6-109" name="__codelineno-6-109" href="#__codelineno-6-109"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">story_generator</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
</span><span id="__span-6-110"><a id="__codelineno-6-110" name="__codelineno-6-110" href="#__codelineno-6-110"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Event from StoryGenerator: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-111"><a id="__codelineno-6-111" name="__codelineno-6-111" href="#__codelineno-6-111"></a>            <span class="k">yield</span> <span class="n">event</span>
</span><span id="__span-6-112"><a id="__codelineno-6-112" name="__codelineno-6-112" href="#__codelineno-6-112"></a>
</span><span id="__span-6-113"><a id="__codelineno-6-113" name="__codelineno-6-113" href="#__codelineno-6-113"></a>        <span class="c1"># Check if story was generated before proceeding</span>
</span><span id="__span-6-114"><a id="__codelineno-6-114" name="__codelineno-6-114" href="#__codelineno-6-114"></a>        <span class="k">if</span> <span class="s2">&quot;current_story&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">state</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;current_story&quot;</span><span class="p">]:</span>
</span><span id="__span-6-115"><a id="__codelineno-6-115" name="__codelineno-6-115" href="#__codelineno-6-115"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Failed to generate initial story. Aborting workflow.&quot;</span><span class="p">)</span>
</span><span id="__span-6-116"><a id="__codelineno-6-116" name="__codelineno-6-116" href="#__codelineno-6-116"></a>             <span class="k">return</span> <span class="c1"># Stop processing if initial story failed</span>
</span><span id="__span-6-117"><a id="__codelineno-6-117" name="__codelineno-6-117" href="#__codelineno-6-117"></a>
</span><span id="__span-6-118"><a id="__codelineno-6-118" name="__codelineno-6-118" href="#__codelineno-6-118"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Story state after generator: </span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_story&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-119"><a id="__codelineno-6-119" name="__codelineno-6-119" href="#__codelineno-6-119"></a>
</span><span id="__span-6-120"><a id="__codelineno-6-120" name="__codelineno-6-120" href="#__codelineno-6-120"></a>
</span><span id="__span-6-121"><a id="__codelineno-6-121" name="__codelineno-6-121" href="#__codelineno-6-121"></a>        <span class="c1"># 2. Critic-Reviser Loop</span>
</span><span id="__span-6-122"><a id="__codelineno-6-122" name="__codelineno-6-122" href="#__codelineno-6-122"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Running CriticReviserLoop...&quot;</span><span class="p">)</span>
</span><span id="__span-6-123"><a id="__codelineno-6-123" name="__codelineno-6-123" href="#__codelineno-6-123"></a>        <span class="c1"># Use the loop_agent instance attribute assigned during init</span>
</span><span id="__span-6-124"><a id="__codelineno-6-124" name="__codelineno-6-124" href="#__codelineno-6-124"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_agent</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
</span><span id="__span-6-125"><a id="__codelineno-6-125" name="__codelineno-6-125" href="#__codelineno-6-125"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Event from CriticReviserLoop: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-126"><a id="__codelineno-6-126" name="__codelineno-6-126" href="#__codelineno-6-126"></a>            <span class="k">yield</span> <span class="n">event</span>
</span><span id="__span-6-127"><a id="__codelineno-6-127" name="__codelineno-6-127" href="#__codelineno-6-127"></a>
</span><span id="__span-6-128"><a id="__codelineno-6-128" name="__codelineno-6-128" href="#__codelineno-6-128"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Story state after loop: </span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_story&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-129"><a id="__codelineno-6-129" name="__codelineno-6-129" href="#__codelineno-6-129"></a>
</span><span id="__span-6-130"><a id="__codelineno-6-130" name="__codelineno-6-130" href="#__codelineno-6-130"></a>        <span class="c1"># 3. Sequential Post-Processing (Grammar and Tone Check)</span>
</span><span id="__span-6-131"><a id="__codelineno-6-131" name="__codelineno-6-131" href="#__codelineno-6-131"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Running PostProcessing...&quot;</span><span class="p">)</span>
</span><span id="__span-6-132"><a id="__codelineno-6-132" name="__codelineno-6-132" href="#__codelineno-6-132"></a>        <span class="c1"># Use the sequential_agent instance attribute assigned during init</span>
</span><span id="__span-6-133"><a id="__codelineno-6-133" name="__codelineno-6-133" href="#__codelineno-6-133"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequential_agent</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
</span><span id="__span-6-134"><a id="__codelineno-6-134" name="__codelineno-6-134" href="#__codelineno-6-134"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Event from PostProcessing: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-135"><a id="__codelineno-6-135" name="__codelineno-6-135" href="#__codelineno-6-135"></a>            <span class="k">yield</span> <span class="n">event</span>
</span><span id="__span-6-136"><a id="__codelineno-6-136" name="__codelineno-6-136" href="#__codelineno-6-136"></a>
</span><span id="__span-6-137"><a id="__codelineno-6-137" name="__codelineno-6-137" href="#__codelineno-6-137"></a>        <span class="c1"># 4. Tone-Based Conditional Logic</span>
</span><span id="__span-6-138"><a id="__codelineno-6-138" name="__codelineno-6-138" href="#__codelineno-6-138"></a>        <span class="n">tone_check_result</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tone_check_result&quot;</span><span class="p">)</span>
</span><span id="__span-6-139"><a id="__codelineno-6-139" name="__codelineno-6-139" href="#__codelineno-6-139"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Tone check result: </span><span class="si">{</span><span class="n">tone_check_result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-140"><a id="__codelineno-6-140" name="__codelineno-6-140" href="#__codelineno-6-140"></a>
</span><span id="__span-6-141"><a id="__codelineno-6-141" name="__codelineno-6-141" href="#__codelineno-6-141"></a>        <span class="k">if</span> <span class="n">tone_check_result</span> <span class="o">==</span> <span class="s2">&quot;negative&quot;</span><span class="p">:</span>
</span><span id="__span-6-142"><a id="__codelineno-6-142" name="__codelineno-6-142" href="#__codelineno-6-142"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Tone is negative. Regenerating story...&quot;</span><span class="p">)</span>
</span><span id="__span-6-143"><a id="__codelineno-6-143" name="__codelineno-6-143" href="#__codelineno-6-143"></a>            <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">story_generator</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
</span><span id="__span-6-144"><a id="__codelineno-6-144" name="__codelineno-6-144" href="#__codelineno-6-144"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Event from StoryGenerator (Regen): </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-145"><a id="__codelineno-6-145" name="__codelineno-6-145" href="#__codelineno-6-145"></a>                <span class="k">yield</span> <span class="n">event</span>
</span><span id="__span-6-146"><a id="__codelineno-6-146" name="__codelineno-6-146" href="#__codelineno-6-146"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-6-147"><a id="__codelineno-6-147" name="__codelineno-6-147" href="#__codelineno-6-147"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Tone is not negative. Keeping current story.&quot;</span><span class="p">)</span>
</span><span id="__span-6-148"><a id="__codelineno-6-148" name="__codelineno-6-148" href="#__codelineno-6-148"></a>            <span class="k">pass</span>
</span><span id="__span-6-149"><a id="__codelineno-6-149" name="__codelineno-6-149" href="#__codelineno-6-149"></a>
</span><span id="__span-6-150"><a id="__codelineno-6-150" name="__codelineno-6-150" href="#__codelineno-6-150"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Workflow finished.&quot;</span><span class="p">)</span>
</span><span id="__span-6-151"><a id="__codelineno-6-151" name="__codelineno-6-151" href="#__codelineno-6-151"></a>
</span><span id="__span-6-152"><a id="__codelineno-6-152" name="__codelineno-6-152" href="#__codelineno-6-152"></a><span class="c1"># --- Define the individual LLM agents ---</span>
</span><span id="__span-6-153"><a id="__codelineno-6-153" name="__codelineno-6-153" href="#__codelineno-6-153"></a><span class="n">story_generator</span> <span class="o">=</span> <span class="n">LlmAgent</span><span class="p">(</span>
</span><span id="__span-6-154"><a id="__codelineno-6-154" name="__codelineno-6-154" href="#__codelineno-6-154"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;StoryGenerator&quot;</span><span class="p">,</span>
</span><span id="__span-6-155"><a id="__codelineno-6-155" name="__codelineno-6-155" href="#__codelineno-6-155"></a>    <span class="n">model</span><span class="o">=</span><span class="n">GEMINI_2_FLASH</span><span class="p">,</span>
</span><span id="__span-6-156"><a id="__codelineno-6-156" name="__codelineno-6-156" href="#__codelineno-6-156"></a>    <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;You are a story writer. Write a short story (around 100 words) about a cat,</span>
</span><span id="__span-6-157"><a id="__codelineno-6-157" name="__codelineno-6-157" href="#__codelineno-6-157"></a><span class="s2">based on the topic provided in session state with key &#39;topic&#39;&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-6-158"><a id="__codelineno-6-158" name="__codelineno-6-158" href="#__codelineno-6-158"></a>    <span class="n">input_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-159"><a id="__codelineno-6-159" name="__codelineno-6-159" href="#__codelineno-6-159"></a>    <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;current_story&quot;</span><span class="p">,</span>  <span class="c1"># Key for storing output in session state</span>
</span><span id="__span-6-160"><a id="__codelineno-6-160" name="__codelineno-6-160" href="#__codelineno-6-160"></a><span class="p">)</span>
</span><span id="__span-6-161"><a id="__codelineno-6-161" name="__codelineno-6-161" href="#__codelineno-6-161"></a>
</span><span id="__span-6-162"><a id="__codelineno-6-162" name="__codelineno-6-162" href="#__codelineno-6-162"></a><span class="n">critic</span> <span class="o">=</span> <span class="n">LlmAgent</span><span class="p">(</span>
</span><span id="__span-6-163"><a id="__codelineno-6-163" name="__codelineno-6-163" href="#__codelineno-6-163"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Critic&quot;</span><span class="p">,</span>
</span><span id="__span-6-164"><a id="__codelineno-6-164" name="__codelineno-6-164" href="#__codelineno-6-164"></a>    <span class="n">model</span><span class="o">=</span><span class="n">GEMINI_2_FLASH</span><span class="p">,</span>
</span><span id="__span-6-165"><a id="__codelineno-6-165" name="__codelineno-6-165" href="#__codelineno-6-165"></a>    <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;You are a story critic. Review the story provided in</span>
</span><span id="__span-6-166"><a id="__codelineno-6-166" name="__codelineno-6-166" href="#__codelineno-6-166"></a><span class="s2">session state with key &#39;current_story&#39;. Provide 1-2 sentences of constructive criticism</span>
</span><span id="__span-6-167"><a id="__codelineno-6-167" name="__codelineno-6-167" href="#__codelineno-6-167"></a><span class="s2">on how to improve it. Focus on plot or character.&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-6-168"><a id="__codelineno-6-168" name="__codelineno-6-168" href="#__codelineno-6-168"></a>    <span class="n">input_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-169"><a id="__codelineno-6-169" name="__codelineno-6-169" href="#__codelineno-6-169"></a>    <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;criticism&quot;</span><span class="p">,</span>  <span class="c1"># Key for storing criticism in session state</span>
</span><span id="__span-6-170"><a id="__codelineno-6-170" name="__codelineno-6-170" href="#__codelineno-6-170"></a><span class="p">)</span>
</span><span id="__span-6-171"><a id="__codelineno-6-171" name="__codelineno-6-171" href="#__codelineno-6-171"></a>
</span><span id="__span-6-172"><a id="__codelineno-6-172" name="__codelineno-6-172" href="#__codelineno-6-172"></a><span class="n">reviser</span> <span class="o">=</span> <span class="n">LlmAgent</span><span class="p">(</span>
</span><span id="__span-6-173"><a id="__codelineno-6-173" name="__codelineno-6-173" href="#__codelineno-6-173"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Reviser&quot;</span><span class="p">,</span>
</span><span id="__span-6-174"><a id="__codelineno-6-174" name="__codelineno-6-174" href="#__codelineno-6-174"></a>    <span class="n">model</span><span class="o">=</span><span class="n">GEMINI_2_FLASH</span><span class="p">,</span>
</span><span id="__span-6-175"><a id="__codelineno-6-175" name="__codelineno-6-175" href="#__codelineno-6-175"></a>    <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;You are a story reviser. Revise the story provided in</span>
</span><span id="__span-6-176"><a id="__codelineno-6-176" name="__codelineno-6-176" href="#__codelineno-6-176"></a><span class="s2">session state with key &#39;current_story&#39;, based on the criticism in</span>
</span><span id="__span-6-177"><a id="__codelineno-6-177" name="__codelineno-6-177" href="#__codelineno-6-177"></a><span class="s2">session state with key &#39;criticism&#39;. Output only the revised story.&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-6-178"><a id="__codelineno-6-178" name="__codelineno-6-178" href="#__codelineno-6-178"></a>    <span class="n">input_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-179"><a id="__codelineno-6-179" name="__codelineno-6-179" href="#__codelineno-6-179"></a>    <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;current_story&quot;</span><span class="p">,</span>  <span class="c1"># Overwrites the original story</span>
</span><span id="__span-6-180"><a id="__codelineno-6-180" name="__codelineno-6-180" href="#__codelineno-6-180"></a><span class="p">)</span>
</span><span id="__span-6-181"><a id="__codelineno-6-181" name="__codelineno-6-181" href="#__codelineno-6-181"></a>
</span><span id="__span-6-182"><a id="__codelineno-6-182" name="__codelineno-6-182" href="#__codelineno-6-182"></a><span class="n">grammar_check</span> <span class="o">=</span> <span class="n">LlmAgent</span><span class="p">(</span>
</span><span id="__span-6-183"><a id="__codelineno-6-183" name="__codelineno-6-183" href="#__codelineno-6-183"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;GrammarCheck&quot;</span><span class="p">,</span>
</span><span id="__span-6-184"><a id="__codelineno-6-184" name="__codelineno-6-184" href="#__codelineno-6-184"></a>    <span class="n">model</span><span class="o">=</span><span class="n">GEMINI_2_FLASH</span><span class="p">,</span>
</span><span id="__span-6-185"><a id="__codelineno-6-185" name="__codelineno-6-185" href="#__codelineno-6-185"></a>    <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;You are a grammar checker. Check the grammar of the story</span>
</span><span id="__span-6-186"><a id="__codelineno-6-186" name="__codelineno-6-186" href="#__codelineno-6-186"></a><span class="s2">provided in session state with key &#39;current_story&#39;. Output only the suggested</span>
</span><span id="__span-6-187"><a id="__codelineno-6-187" name="__codelineno-6-187" href="#__codelineno-6-187"></a><span class="s2">corrections as a list, or output &#39;Grammar is good!&#39; if there are no errors.&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-6-188"><a id="__codelineno-6-188" name="__codelineno-6-188" href="#__codelineno-6-188"></a>    <span class="n">input_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-189"><a id="__codelineno-6-189" name="__codelineno-6-189" href="#__codelineno-6-189"></a>    <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;grammar_suggestions&quot;</span><span class="p">,</span>
</span><span id="__span-6-190"><a id="__codelineno-6-190" name="__codelineno-6-190" href="#__codelineno-6-190"></a><span class="p">)</span>
</span><span id="__span-6-191"><a id="__codelineno-6-191" name="__codelineno-6-191" href="#__codelineno-6-191"></a>
</span><span id="__span-6-192"><a id="__codelineno-6-192" name="__codelineno-6-192" href="#__codelineno-6-192"></a><span class="n">tone_check</span> <span class="o">=</span> <span class="n">LlmAgent</span><span class="p">(</span>
</span><span id="__span-6-193"><a id="__codelineno-6-193" name="__codelineno-6-193" href="#__codelineno-6-193"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ToneCheck&quot;</span><span class="p">,</span>
</span><span id="__span-6-194"><a id="__codelineno-6-194" name="__codelineno-6-194" href="#__codelineno-6-194"></a>    <span class="n">model</span><span class="o">=</span><span class="n">GEMINI_2_FLASH</span><span class="p">,</span>
</span><span id="__span-6-195"><a id="__codelineno-6-195" name="__codelineno-6-195" href="#__codelineno-6-195"></a>    <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;You are a tone analyzer. Analyze the tone of the story</span>
</span><span id="__span-6-196"><a id="__codelineno-6-196" name="__codelineno-6-196" href="#__codelineno-6-196"></a><span class="s2">provided in session state with key &#39;current_story&#39;. Output only one word: &#39;positive&#39; if</span>
</span><span id="__span-6-197"><a id="__codelineno-6-197" name="__codelineno-6-197" href="#__codelineno-6-197"></a><span class="s2">the tone is generally positive, &#39;negative&#39; if the tone is generally negative, or &#39;neutral&#39;</span>
</span><span id="__span-6-198"><a id="__codelineno-6-198" name="__codelineno-6-198" href="#__codelineno-6-198"></a><span class="s2">otherwise.&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-6-199"><a id="__codelineno-6-199" name="__codelineno-6-199" href="#__codelineno-6-199"></a>    <span class="n">input_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-200"><a id="__codelineno-6-200" name="__codelineno-6-200" href="#__codelineno-6-200"></a>    <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;tone_check_result&quot;</span><span class="p">,</span> <span class="c1"># This agent&#39;s output determines the conditional flow</span>
</span><span id="__span-6-201"><a id="__codelineno-6-201" name="__codelineno-6-201" href="#__codelineno-6-201"></a><span class="p">)</span>
</span><span id="__span-6-202"><a id="__codelineno-6-202" name="__codelineno-6-202" href="#__codelineno-6-202"></a>
</span><span id="__span-6-203"><a id="__codelineno-6-203" name="__codelineno-6-203" href="#__codelineno-6-203"></a><span class="c1"># --- Create the custom agent instance ---</span>
</span><span id="__span-6-204"><a id="__codelineno-6-204" name="__codelineno-6-204" href="#__codelineno-6-204"></a><span class="n">story_flow_agent</span> <span class="o">=</span> <span class="n">StoryFlowAgent</span><span class="p">(</span>
</span><span id="__span-6-205"><a id="__codelineno-6-205" name="__codelineno-6-205" href="#__codelineno-6-205"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;StoryFlowAgent&quot;</span><span class="p">,</span>
</span><span id="__span-6-206"><a id="__codelineno-6-206" name="__codelineno-6-206" href="#__codelineno-6-206"></a>    <span class="n">story_generator</span><span class="o">=</span><span class="n">story_generator</span><span class="p">,</span>
</span><span id="__span-6-207"><a id="__codelineno-6-207" name="__codelineno-6-207" href="#__codelineno-6-207"></a>    <span class="n">critic</span><span class="o">=</span><span class="n">critic</span><span class="p">,</span>
</span><span id="__span-6-208"><a id="__codelineno-6-208" name="__codelineno-6-208" href="#__codelineno-6-208"></a>    <span class="n">reviser</span><span class="o">=</span><span class="n">reviser</span><span class="p">,</span>
</span><span id="__span-6-209"><a id="__codelineno-6-209" name="__codelineno-6-209" href="#__codelineno-6-209"></a>    <span class="n">grammar_check</span><span class="o">=</span><span class="n">grammar_check</span><span class="p">,</span>
</span><span id="__span-6-210"><a id="__codelineno-6-210" name="__codelineno-6-210" href="#__codelineno-6-210"></a>    <span class="n">tone_check</span><span class="o">=</span><span class="n">tone_check</span><span class="p">,</span>
</span><span id="__span-6-211"><a id="__codelineno-6-211" name="__codelineno-6-211" href="#__codelineno-6-211"></a><span class="p">)</span>
</span><span id="__span-6-212"><a id="__codelineno-6-212" name="__codelineno-6-212" href="#__codelineno-6-212"></a>
</span><span id="__span-6-213"><a id="__codelineno-6-213" name="__codelineno-6-213" href="#__codelineno-6-213"></a><span class="c1"># --- Setup Runner and Session ---</span>
</span><span id="__span-6-214"><a id="__codelineno-6-214" name="__codelineno-6-214" href="#__codelineno-6-214"></a><span class="n">session_service</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span>
</span><span id="__span-6-215"><a id="__codelineno-6-215" name="__codelineno-6-215" href="#__codelineno-6-215"></a><span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;topic&quot;</span><span class="p">:</span> <span class="s2">&quot;a brave kitten exploring a haunted house&quot;</span><span class="p">}</span>
</span><span id="__span-6-216"><a id="__codelineno-6-216" name="__codelineno-6-216" href="#__codelineno-6-216"></a><span class="n">session</span> <span class="o">=</span> <span class="n">session_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-6-217"><a id="__codelineno-6-217" name="__codelineno-6-217" href="#__codelineno-6-217"></a>    <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-6-218"><a id="__codelineno-6-218" name="__codelineno-6-218" href="#__codelineno-6-218"></a>    <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-6-219"><a id="__codelineno-6-219" name="__codelineno-6-219" href="#__codelineno-6-219"></a>    <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">,</span>
</span><span id="__span-6-220"><a id="__codelineno-6-220" name="__codelineno-6-220" href="#__codelineno-6-220"></a>    <span class="n">state</span><span class="o">=</span><span class="n">initial_state</span> <span class="c1"># Pass initial state here</span>
</span><span id="__span-6-221"><a id="__codelineno-6-221" name="__codelineno-6-221" href="#__codelineno-6-221"></a><span class="p">)</span>
</span><span id="__span-6-222"><a id="__codelineno-6-222" name="__codelineno-6-222" href="#__codelineno-6-222"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial session state: </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-223"><a id="__codelineno-6-223" name="__codelineno-6-223" href="#__codelineno-6-223"></a>
</span><span id="__span-6-224"><a id="__codelineno-6-224" name="__codelineno-6-224" href="#__codelineno-6-224"></a><span class="n">runner</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-6-225"><a id="__codelineno-6-225" name="__codelineno-6-225" href="#__codelineno-6-225"></a>    <span class="n">agent</span><span class="o">=</span><span class="n">story_flow_agent</span><span class="p">,</span> <span class="c1"># Pass the custom orchestrator agent</span>
</span><span id="__span-6-226"><a id="__codelineno-6-226" name="__codelineno-6-226" href="#__codelineno-6-226"></a>    <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-6-227"><a id="__codelineno-6-227" name="__codelineno-6-227" href="#__codelineno-6-227"></a>    <span class="n">session_service</span><span class="o">=</span><span class="n">session_service</span>
</span><span id="__span-6-228"><a id="__codelineno-6-228" name="__codelineno-6-228" href="#__codelineno-6-228"></a><span class="p">)</span>
</span><span id="__span-6-229"><a id="__codelineno-6-229" name="__codelineno-6-229" href="#__codelineno-6-229"></a>
</span><span id="__span-6-230"><a id="__codelineno-6-230" name="__codelineno-6-230" href="#__codelineno-6-230"></a><span class="c1"># --- Function to Interact with the Agent ---</span>
</span><span id="__span-6-231"><a id="__codelineno-6-231" name="__codelineno-6-231" href="#__codelineno-6-231"></a><span class="k">def</span><span class="w"> </span><span class="nf">call_agent</span><span class="p">(</span><span class="n">user_input_topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-6-232"><a id="__codelineno-6-232" name="__codelineno-6-232" href="#__codelineno-6-232"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-6-233"><a id="__codelineno-6-233" name="__codelineno-6-233" href="#__codelineno-6-233"></a><span class="sd">    Sends a new topic to the agent (overwriting the initial one if needed)</span>
</span><span id="__span-6-234"><a id="__codelineno-6-234" name="__codelineno-6-234" href="#__codelineno-6-234"></a><span class="sd">    and runs the workflow.</span>
</span><span id="__span-6-235"><a id="__codelineno-6-235" name="__codelineno-6-235" href="#__codelineno-6-235"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-6-236"><a id="__codelineno-6-236" name="__codelineno-6-236" href="#__codelineno-6-236"></a>    <span class="n">current_session</span> <span class="o">=</span> <span class="n">session_service</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span> 
</span><span id="__span-6-237"><a id="__codelineno-6-237" name="__codelineno-6-237" href="#__codelineno-6-237"></a>                                                  <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span> 
</span><span id="__span-6-238"><a id="__codelineno-6-238" name="__codelineno-6-238" href="#__codelineno-6-238"></a>                                                  <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-6-239"><a id="__codelineno-6-239" name="__codelineno-6-239" href="#__codelineno-6-239"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">current_session</span><span class="p">:</span>
</span><span id="__span-6-240"><a id="__codelineno-6-240" name="__codelineno-6-240" href="#__codelineno-6-240"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Session not found!&quot;</span><span class="p">)</span>
</span><span id="__span-6-241"><a id="__codelineno-6-241" name="__codelineno-6-241" href="#__codelineno-6-241"></a>        <span class="k">return</span>
</span><span id="__span-6-242"><a id="__codelineno-6-242" name="__codelineno-6-242" href="#__codelineno-6-242"></a>
</span><span id="__span-6-243"><a id="__codelineno-6-243" name="__codelineno-6-243" href="#__codelineno-6-243"></a>    <span class="n">current_session</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;topic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_input_topic</span>
</span><span id="__span-6-244"><a id="__codelineno-6-244" name="__codelineno-6-244" href="#__codelineno-6-244"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated session state topic to: </span><span class="si">{</span><span class="n">user_input_topic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-245"><a id="__codelineno-6-245" name="__codelineno-6-245" href="#__codelineno-6-245"></a>
</span><span id="__span-6-246"><a id="__codelineno-6-246" name="__codelineno-6-246" href="#__codelineno-6-246"></a>    <span class="n">content</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Generate a story about: </span><span class="si">{</span><span class="n">user_input_topic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)])</span>
</span><span id="__span-6-247"><a id="__codelineno-6-247" name="__codelineno-6-247" href="#__codelineno-6-247"></a>    <span class="n">events</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">,</span> <span class="n">new_message</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
</span><span id="__span-6-248"><a id="__codelineno-6-248" name="__codelineno-6-248" href="#__codelineno-6-248"></a>
</span><span id="__span-6-249"><a id="__codelineno-6-249" name="__codelineno-6-249" href="#__codelineno-6-249"></a>    <span class="n">final_response</span> <span class="o">=</span> <span class="s2">&quot;No final response captured.&quot;</span>
</span><span id="__span-6-250"><a id="__codelineno-6-250" name="__codelineno-6-250" href="#__codelineno-6-250"></a>    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="__span-6-251"><a id="__codelineno-6-251" name="__codelineno-6-251" href="#__codelineno-6-251"></a>        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_final_response</span><span class="p">()</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span><span id="__span-6-252"><a id="__codelineno-6-252" name="__codelineno-6-252" href="#__codelineno-6-252"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Potential final response from [</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">author</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-253"><a id="__codelineno-6-253" name="__codelineno-6-253" href="#__codelineno-6-253"></a>            <span class="n">final_response</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
</span><span id="__span-6-254"><a id="__codelineno-6-254" name="__codelineno-6-254" href="#__codelineno-6-254"></a>
</span><span id="__span-6-255"><a id="__codelineno-6-255" name="__codelineno-6-255" href="#__codelineno-6-255"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Agent Interaction Result ---&quot;</span><span class="p">)</span>
</span><span id="__span-6-256"><a id="__codelineno-6-256" name="__codelineno-6-256" href="#__codelineno-6-256"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Agent Final Response: &quot;</span><span class="p">,</span> <span class="n">final_response</span><span class="p">)</span>
</span><span id="__span-6-257"><a id="__codelineno-6-257" name="__codelineno-6-257" href="#__codelineno-6-257"></a>
</span><span id="__span-6-258"><a id="__codelineno-6-258" name="__codelineno-6-258" href="#__codelineno-6-258"></a>    <span class="n">final_session</span> <span class="o">=</span> <span class="n">session_service</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span> 
</span><span id="__span-6-259"><a id="__codelineno-6-259" name="__codelineno-6-259" href="#__codelineno-6-259"></a>                                                <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span> 
</span><span id="__span-6-260"><a id="__codelineno-6-260" name="__codelineno-6-260" href="#__codelineno-6-260"></a>                                                <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-6-261"><a id="__codelineno-6-261" name="__codelineno-6-261" href="#__codelineno-6-261"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final Session State:&quot;</span><span class="p">)</span>
</span><span id="__span-6-262"><a id="__codelineno-6-262" name="__codelineno-6-262" href="#__codelineno-6-262"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-6-263"><a id="__codelineno-6-263" name="__codelineno-6-263" href="#__codelineno-6-263"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span><span id="__span-6-264"><a id="__codelineno-6-264" name="__codelineno-6-264" href="#__codelineno-6-264"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-265"><a id="__codelineno-6-265" name="__codelineno-6-265" href="#__codelineno-6-265"></a>
</span><span id="__span-6-266"><a id="__codelineno-6-266" name="__codelineno-6-266" href="#__codelineno-6-266"></a><span class="c1"># --- Run the Agent ---</span>
</span><span id="__span-6-267"><a id="__codelineno-6-267" name="__codelineno-6-267" href="#__codelineno-6-267"></a><span class="n">call_agent</span><span class="p">(</span><span class="s2">&quot;a lonely robot finding a friend in a junkyard&quot;</span><span class="p">)</span>
</span></code></pre></div>
</details>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright Google 2025
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "content.code.copy", "content.tabs.link", "content.code.select", "navigation.instant", "navigation.instant.progress", "navigation.path", "navigation.top", "navigation.tracking", "navigation.indexes", "toc.follow"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>