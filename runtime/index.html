
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Google ADK(Agent Development Kit ) 是由谷歌开源的 AI 代理框架，专为开发和部署 AI 代理而设计，支持 Gemini 模型和 Google AI 工具的紧密集成，一个开源的、代码优先的Python工具包，用于灵活可控地构建、评估和部署复杂AI智能体。">
      
      
      
        <link rel="canonical" href="https://google-agent-sdk.agentdevhub.com/runtime/">
      
      
        <link rel="prev" href="../callbacks/design-patterns-and-best-practices/">
      
      
        <link rel="next" href="../events/">
      
      
      <link rel="icon" href="../assets/agent-development-kit.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.11">
    
    
      
        <title>运行时系统 - Google ADK(Agent Development Kit ) 中文文档</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Google Sans";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="white">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      <!--
 Copyright 2025 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!-- Determine classes -->


  


<!-- Header -->
<header class="md-header md-header--shadow" data-md-component="header">
  <nav
    class="md-header__inner md-grid"
    aria-label="Header"
  >

    <!-- Link to home -->
    <a
      href=".."
      title="Google ADK(Agent Development Kit ) 中文文档"
      class="md-header__button md-logo"
      aria-label="Google ADK(Agent Development Kit ) 中文文档"
      data-md-component="logo"
    >
      
  <img src="../assets/agent-development-kit.png" alt="logo">

    </a>

    <!-- Button to open drawer -->
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>

    <!-- Header title -->
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            <a
      href=".."
      title="Google ADK(Agent Development Kit ) 中文文档"
      aria-label="Google ADK(Agent Development Kit ) 中文文档"
      data-md-component="logo"
    >
            Google ADK(Agent Development Kit ) 中文文档
            </a>
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              运行时系统
            
            </a>
          </span>
        </div>
      </div>
    </div>

    <!-- Color palette toggle -->
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="white"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="white" data-md-color-accent="white"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    

    <!-- User preference: color palette -->
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    

    <!-- Site language selector -->
    

    <!-- Button to open search modal -->
    
      

      <!-- Check if search is actually enabled - see https://t.ly/DT_0V -->
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>

        <!-- Search interface -->
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    

    <!-- Repository information -->
    
      <div class="md-header__source">
        <a href="https://github.com/agentdevhub/Google-Agent-SDK" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    Google-Agent-SDK
  </div>
</a>
      </div>
    
  </nav>

  <!-- Navigation tabs (sticky) -->
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Google ADK(Agent Development Kit ) 中文文档" class="md-nav__button md-logo" aria-label="Google ADK(Agent Development Kit ) 中文文档" data-md-component="logo">
      
  <img src="../assets/agent-development-kit.png" alt="logo">

    </a>
    Google ADK(Agent Development Kit ) 中文文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/agentdevhub/Google-Agent-SDK" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    Google-Agent-SDK
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    首页
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../get-started/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    入门指南
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            入门指南
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../get-started/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    安装指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../get-started/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    快速入门
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../get-started/quickstart-streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    快速入门 (streaming)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../get-started/tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    教程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../get-started/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    测试方法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/google/adk-samples" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    示例代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../get-started/about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    关于 ADK
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../agents/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    代理系统
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            代理系统
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agents/llm-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LLM 代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../agents/workflow-agents/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    工作流代理
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            工作流代理
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agents/workflow-agents/sequential-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    顺序代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agents/workflow-agents/loop-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    循环代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agents/workflow-agents/parallel-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    并行代理
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agents/custom-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    自定义代理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agents/multi-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    多代理系统
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agents/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    模型
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../tools/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    工具集
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            工具集
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/function-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    函数工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/built-in-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    内置工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/third-party-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    第三方工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/google-cloud-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Google Cloud 工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/mcp-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MCP 工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/openapi-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OpenAPI 工具
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools/authentication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    身份验证
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../deploy/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    部署
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            部署
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deploy/agent-engine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent Engine
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deploy/cloud-run/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cloud Run
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../sessions/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    会话与记忆
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            会话与记忆
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sessions/session/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    会话
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sessions/state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    状态
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sessions/memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    记忆机制
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../artifacts/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    制品
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            制品
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../callbacks/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    回调函数
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            回调函数
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../callbacks/types-of-callbacks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    回调类型
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../callbacks/design-patterns-and-best-practices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    回调模式
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="./" class="md-nav__link md-nav__link--active">
              
  
  
  <span class="md-ellipsis">
    运行时
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            运行时
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../events/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    事件
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            事件
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../context/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    上下文
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            上下文
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../evaluate/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    评估
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            评估
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    指南
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            指南
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/responsible-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    负责任代理指南
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    贡献指南
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API 参考
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      什么是运行时？
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      核心概念：事件循环
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      核心机制：事件循环详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心机制：事件循环详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#runner" class="md-nav__link">
    <span class="md-ellipsis">
      Runner 的角色（协调中枢）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      执行逻辑的角色（智能体、工具、回调）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      运行时关键组件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="运行时关键组件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#runner_1" class="md-nav__link">
    <span class="md-ellipsis">
      Runner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      执行逻辑组件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event" class="md-nav__link">
    <span class="md-ellipsis">
      Event
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    <span class="md-ellipsis">
      Services
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#session" class="md-nav__link">
    <span class="md-ellipsis">
      Session
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#invocation" class="md-nav__link">
    <span class="md-ellipsis">
      Invocation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      运作机制：简化调用流程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="运作机制：简化调用流程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      逐步解析
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      重要运行时行为
    </span>
  </a>
  
    <nav class="md-nav" aria-label="重要运行时行为">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      状态更新与提交时机
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      会话状态的"脏读"
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#partialtrue" class="md-nav__link">
    <span class="md-ellipsis">
      流式与非流式输出（partial=True）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_async" class="md-nav__link">
    <span class="md-ellipsis">
      异步优先（run_async）
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="_1">运行时系统</h1>
<h2 id="_2">什么是运行时？</h2>
<p>ADK Runtime 是支撑智能体应用在用户交互过程中运行的核心引擎。这个系统负责调度您定义的智能体、工具和回调函数，响应用户输入来协调执行流程，管理信息流转、状态变更以及与外部服务（如大模型或存储系统）的交互。</p>
<p>您可以将 Runtime 视为智能体应用的<strong>"发动机"</strong>。您负责定义各个组件（智能体、工具），而 Runtime 则处理它们之间的协作运行机制以满足用户请求。</p>
<h2 id="_3">核心概念：事件循环</h2>
<p>ADK Runtime 的核心运行机制是<strong>事件循环</strong>。这个循环在 <code>Runner</code> 组件与您定义的"执行逻辑"（包括智能体、大模型调用、回调和工具）之间建立双向通信通道。</p>
<p><img alt="intro_components.png" src="../assets/event-loop.png" /></p>
<p>简单来说：</p>
<ol>
<li><code>Runner</code> 接收用户查询后，请求主 <code>Agent</code> 开始处理</li>
<li><code>Agent</code>（及其关联逻辑）持续运行直到需要报告结果（如生成响应、调用工具请求或状态变更）——此时会<strong>产出</strong>一个 <code>Event</code></li>
<li><code>Runner</code> 接收该 <code>Event</code> 后，处理相关操作（如通过 <code>Services</code> 保存状态变更），并将事件转发（例如到用户界面）</li>
<li>只有当 <code>Runner</code> 完成事件处理后，<code>Agent</code> 的逻辑才会从暂停处<strong>恢复</strong>执行，此时可能已观察到 Runner 提交的变更效果</li>
<li>该循环持续进行，直到智能体对当前用户查询不再产出新事件</li>
</ol>
<p>这种事件驱动的循环机制是 ADK 执行智能体代码的基础模式。</p>
<h2 id="_4">核心机制：事件循环详解</h2>
<p>事件循环定义了 <code>Runner</code> 与自定义代码（智能体、工具、回调，在设计文档中统称为"执行逻辑"或"逻辑组件"）之间的交互范式，明确划分了职责边界：</p>
<h3 id="runner">Runner 的角色（协调中枢）</h3>
<p><code>Runner</code> 作为单次用户调用的中央协调器，在循环中承担以下职责：</p>
<ol>
<li><strong>初始化</strong>：接收终端用户查询（<code>new_message</code>），通常通过 <code>SessionService</code> 将其追加到会话历史</li>
<li><strong>启动</strong>：调用主智能体的执行方法（如 <code>agent_to_run.run_async(...)</code>）启动事件生成流程</li>
<li><strong>接收与处理</strong>：等待智能体逻辑 <code>yield</code> 产出 <code>Event</code>。收到事件后立即处理：<ul>
<li>使用配置的 <code>Services</code>（<code>SessionService</code>、<code>ArtifactService</code>、<code>MemoryService</code>）提交 <code>event.actions</code> 中的变更（如 <code>state_delta</code>、<code>artifact_delta</code>）</li>
<li>执行其他内部簿记操作</li>
</ul>
</li>
<li><strong>向上传递</strong>：将处理完成的事件转发（如传递给调用应用或界面渲染）</li>
<li><strong>迭代</strong>：通知智能体逻辑已完成当前事件处理，允许其恢复执行并产出<em>下一个</em>事件</li>
</ol>
<p><em>Runner 循环概念示意：</em></p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># Simplified view of Runner&#39;s main loop logic</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">new_query</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Event</span><span class="p">]:</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="c1"># 1. Append new_query to session event history (via SessionService)</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">session_service</span><span class="o">.</span><span class="n">append_event</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">Event</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">new_query</span><span class="p">))</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="c1"># 2. Kick off event loop by calling the agent</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">agent_event_generator</span> <span class="o">=</span> <span class="n">agent_to_run</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">agent_event_generator</span><span class="p">:</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>        <span class="c1"># 3. Process the generated event and commit changes</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="n">session_service</span><span class="o">.</span><span class="n">append_event</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span> <span class="c1"># Commits state/artifact deltas etc.</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="c1"># memory_service.update_memory(...) # If applicable</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="c1"># artifact_service might have already been called via context during agent run</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="c1"># 4. Yield event for upstream processing (e.g., UI rendering)</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="k">yield</span> <span class="n">event</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>        <span class="c1"># Runner implicitly signals agent generator can continue after yielding</span>
</span></code></pre></div>
<h3 id="_5">执行逻辑的角色（智能体、工具、回调）</h3>
<p>智能体、工具和回调中的代码负责实际计算和决策制定，其与循环的交互包括：</p>
<ol>
<li><strong>执行</strong>：基于当前 <code>InvocationContext</code>（包括恢复执行时的会话状态）运行逻辑</li>
<li><strong>产出</strong>：当需要通信时（发送消息、调用工具、报告状态变更），构建包含相关内容和操作的 <code>Event</code>，然后通过 <code>yield</code> 将事件传回 <code>Runner</code></li>
<li><strong>暂停</strong>：关键的是，智能体逻辑在 <code>yield</code> 语句后<strong>立即暂停</strong>，等待 <code>Runner</code> 完成步骤3（处理与提交）</li>
<li><strong>恢复</strong>：只有当 <code>Runner</code> 处理完产出的事件后，智能体逻辑才从 <code>yield</code> 后的语句继续执行</li>
<li><strong>观察更新状态</strong>：恢复后，智能体逻辑可以可靠访问反映先前产出事件所提交变更的会话状态（<code>ctx.session.state</code>）</li>
</ol>
<p><em>执行逻辑概念示意：</em></p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># Simplified view of logic inside Agent.run_async, callbacks, or tools</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="c1"># ... previous code runs based on current state ...</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="c1"># 1. Determine a change or output is needed, construct the event</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="c1"># Example: Updating state</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="n">update_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;field_1&#39;</span><span class="p">:</span> <span class="s1">&#39;value_2&#39;</span><span class="p">}</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="n">event_with_state_change</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>    <span class="n">author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="n">actions</span><span class="o">=</span><span class="n">EventActions</span><span class="p">(</span><span class="n">state_delta</span><span class="o">=</span><span class="n">update_data</span><span class="p">),</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>    <span class="n">content</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span><span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;State updated.&quot;</span><span class="p">)])</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    <span class="c1"># ... other event fields ...</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="p">)</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="c1"># 2. Yield the event to the Runner for processing &amp; commit</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="k">yield</span> <span class="n">event_with_state_change</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; EXECUTION PAUSES HERE &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; RUNNER PROCESSES &amp; COMMITS THE EVENT &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="c1"># 3. Resume execution ONLY after Runner is done processing the above event.</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="c1"># Now, the state committed by the Runner is reliably reflected.</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="c1"># Subsequent code can safely assume the change from the yielded event happened.</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="n">val</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;field_1&#39;</span><span class="p">]</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="c1"># here `val` is guaranteed to be &quot;value_2&quot; (assuming Runner committed successfully)</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resumed execution. Value of field_1 is now: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="c1"># ... subsequent code continues ...</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="c1"># Maybe yield another event later...</span>
</span></code></pre></div>
<p>这种由 <code>Event</code> 对象协调的、<code>Runner</code> 与执行逻辑之间的产出/暂停/恢复协作循环，构成了 ADK Runtime 的核心架构。</p>
<h2 id="_6">运行时关键组件</h2>
<p>ADK Runtime 中多个组件协同工作来执行智能体调用，理解它们的角色有助于厘清事件循环的运作机制：</p>
<ol>
<li>
<h3 id="runner_1"><code>Runner</code></h3>
<ul>
<li><strong>角色</strong>：单次用户查询（<code>run_async</code>）的主入口和协调器</li>
<li><strong>功能</strong>：管理整体事件循环，接收执行逻辑产出的事件，协调服务处理并提交事件操作（状态/产物变更），将处理完成的事件向上传递（如到UI）。本质上是基于产出事件驱动逐轮对话（定义于 <code>google.adk.runners.runner.py</code>）</li>
</ul>
</li>
<li>
<h3 id="_7">执行逻辑组件</h3>
<ul>
<li><strong>角色</strong>：包含自定义代码和智能体核心能力的部分</li>
<li><strong>组成</strong>：</li>
<li><code>Agent</code>（<code>BaseAgent</code>、<code>LlmAgent</code> 等）：处理信息并决策行动的主逻辑单元，实现产出事件的 <code>_run_async_impl</code> 方法</li>
<li><code>Tools</code>（<code>BaseTool</code>、<code>FunctionTool</code>、<code>AgentTool</code> 等）：智能体（通常通过 <code>LlmAgent</code>）与外界交互或执行特定任务的外部功能，执行后返回结果并包装为事件</li>
<li><code>Callbacks</code>（函数）：附加到智能体的用户定义函数（如 <code>before_agent_callback</code>、<code>after_model_callback</code>），挂钩到执行流特定节点，可能修改行为或状态，其效果通过事件捕获</li>
<li><strong>功能</strong>：执行实际思考、计算或外部交互，通过<strong>产出 <code>Event</code> 对象</strong>来通信结果或需求，并暂停直到 Runner 处理完成</li>
</ul>
</li>
<li>
<h3 id="event"><code>Event</code></h3>
<ul>
<li><strong>角色</strong>：<code>Runner</code> 与执行逻辑间传递的消息载体</li>
<li><strong>功能</strong>：表示原子事件（用户输入、智能体文本、工具调用/结果、状态变更请求、控制信号），既携带事件内容也包含预期副作用（<code>actions</code> 如 <code>state_delta</code>）（定义于 <code>google.adk.events.event.py</code>）</li>
</ul>
</li>
<li>
<h3 id="services"><code>Services</code></h3>
<ul>
<li><strong>角色</strong>：管理持久化或共享资源的后端组件，主要由 <code>Runner</code> 在事件处理时使用</li>
<li><strong>组成</strong>：</li>
<li><code>SessionService</code>（<code>BaseSessionService</code>、<code>InMemorySessionService</code> 等）：管理 <code>Session</code> 对象，包括保存/加载、对会话状态应用 <code>state_delta</code>、将事件追加到 <code>event history</code></li>
<li><code>ArtifactService</code>（<code>BaseArtifactService</code>、<code>InMemoryArtifactService</code>、<code>GcsArtifactService</code> 等）：管理二进制产物数据的存储检索。虽然 <code>save_artifact</code> 通过上下文在执行逻辑中调用，但事件中的 <code>artifact_delta</code> 向Runner/SessionService确认操作</li>
<li><code>MemoryService</code>（<code>BaseMemoryService</code> 等）：（可选）管理用户跨会话的长期语义记忆</li>
<li><strong>功能</strong>：提供持久化层。<code>Runner</code> 与之交互以确保 <code>event.actions</code> 信号的变化在<em>执行逻辑恢复前</em>可靠存储</li>
</ul>
</li>
<li>
<h3 id="session"><code>Session</code></h3>
<ul>
<li><strong>角色</strong>：存储用户与应用间<em>特定对话</em>状态与历史的数据容器</li>
<li><strong>功能</strong>：存储当前 <code>state</code> 字典、所有历史 <code>events</code>（<code>event history</code>）列表及相关产物引用，是由 <code>SessionService</code> 管理的主要交互记录（定义于 <code>google.adk.sessions.session.py</code>）</li>
</ul>
</li>
<li>
<h3 id="invocation"><code>Invocation</code></h3>
<ul>
<li><strong>角色</strong>：表示从 <code>Runner</code> 接收<em>单次</em>用户查询到智能体逻辑停止产出事件期间所有发生的概念术语</li>
<li><strong>功能</strong>：一次调用可能涉及多次智能体运行（如使用智能体转移或 <code>AgentTool</code>）、多次大模型调用、工具执行和回调执行，全部通过 <code>InvocationContext</code> 中的单个 <code>invocation_id</code> 关联</li>
</ul>
</li>
</ol>
<p>这些参与者通过事件循环持续交互来处理用户请求。</p>
<h2 id="_8">运作机制：简化调用流程</h2>
<p>以下展示涉及大模型智能体调用工具的典型用户查询简化流程：</p>
<p><img alt="intro_components.png" src="../assets/invocation-flow.png" /></p>
<h3 id="_9">逐步解析</h3>
<ol>
<li><strong>用户输入</strong>：用户发送查询（如"法国首都是哪里？"）</li>
<li><strong>Runner启动</strong>：<code>Runner.run_async</code> 开始运行，与 <code>SessionService</code> 交互加载相关 <code>Session</code>，将用户查询作为首个 <code>Event</code> 加入会话历史，准备 <code>InvocationContext</code>（<code>ctx</code>）</li>
<li><strong>智能体执行</strong>：<code>Runner</code> 调用指定根智能体（如 <code>LlmAgent</code>）的 <code>agent.run_async(ctx)</code></li>
<li><strong>大模型调用（示例）</strong>：<code>Agent_Llm</code> 判断需要信息（可能通过调用工具），准备 <code>LLM</code> 请求。假设大模型决定调用 <code>MyTool</code></li>
<li><strong>产出函数调用事件</strong>：<code>Agent_Llm</code> 接收大模型的 <code>FunctionCall</code> 响应，包装为 <code>Event(author='Agent_Llm', content=Content(parts=[Part(function_call=...)]))</code> 后 <code>yield</code> 该事件</li>
<li><strong>智能体暂停</strong>：<code>Agent_Llm</code> 在 <code>yield</code> 后立即暂停执行</li>
<li><strong>Runner处理</strong>：<code>Runner</code> 接收函数调用事件，传递给 <code>SessionService</code> 记录历史，<code>Runner</code> 将事件向上传递给 <code>User</code>（或应用）</li>
<li><strong>智能体恢复</strong>：<code>Runner</code> 通知事件处理完成，<code>Agent_Llm</code> 恢复执行</li>
<li><strong>工具执行</strong>：<code>Agent_Llm</code> 内部流程继续执行请求的 <code>MyTool</code>，调用 <code>tool.run_async(...)</code></li>
<li><strong>工具返回结果</strong>：<code>MyTool</code> 执行并返回结果（如 <code>{'result': 'Paris'}</code>）</li>
<li><strong>产出函数响应事件</strong>：智能体（<code>Agent_Llm</code>）将工具结果包装为包含 <code>FunctionResponse</code>（如 <code>Event(author='Agent_Llm', content=Content(role='user', parts=[Part(function_response=...)]))</code>）的 <code>Event</code>。若工具修改状态（<code>state_delta</code>）或保存产物（<code>artifact_delta</code>），事件可能还包含 <code>actions</code>。智能体 <code>yield</code> 该事件</li>
<li><strong>智能体暂停</strong>：<code>Agent_Llm</code> 再次暂停</li>
<li><strong>Runner处理</strong>：<code>Runner</code> 接收函数响应事件，传递给 <code>SessionService</code> 应用 <code>state_delta</code>/<code>artifact_delta</code> 并加入历史，<code>Runner</code> 向上传递事件</li>
<li><strong>智能体恢复</strong>：<code>Agent_Llm</code> 恢复执行，此时工具结果和状态变更已确认提交</li>
<li><strong>最终大模型调用（示例）</strong>：<code>Agent_Llm</code> 将工具结果返回 <code>LLM</code> 生成自然语言响应</li>
<li><strong>产出最终文本事件</strong>：<code>Agent_Llm</code> 接收大模型的最终文本，包装为 <code>Event(author='Agent_Llm', content=Content(parts=[Part(text=...)]))</code> 后 <code>yield</code> 产出</li>
<li><strong>智能体暂停</strong>：<code>Agent_Llm</code> 暂停</li>
<li><strong>Runner处理</strong>：<code>Runner</code> 接收最终文本事件，传递给 <code>SessionService</code> 记录历史，向上传递给 <code>User</code>，通常标记为 <code>is_final_response()</code></li>
<li><strong>智能体恢复并结束</strong>：<code>Agent_Llm</code> 恢复，完成本次调用任务后其 <code>run_async</code> 生成器终止</li>
<li><strong>Runner完成</strong>：<code>Runner</code> 检测智能体生成器耗尽，结束本次调用的循环</li>
</ol>
<p>这种产出/暂停/处理/恢复的循环机制确保状态变更被一致应用，且执行逻辑在产出事件后总是基于最新提交的状态运行。</p>
<h2 id="_10">重要运行时行为</h2>
<p>理解 ADK Runtime 处理状态、流式输出和异步操作的关键特性，对于构建稳定高效的智能体至关重要。</p>
<h3 id="_11">状态更新与提交时机</h3>
<ul>
<li>
<p><strong>规则</strong>：当代码（在智能体、工具或回调中）修改会话状态（如 <code>context.state['my_key'] = 'new_value'</code>）时，变更最初记录在当前 <code>InvocationContext</code> 的本地副本中。只有当中包含对应 <code>state_delta</code> 的 <code>Event</code> 被代码 <code>yield</code> 产出且经 <code>Runner</code> 处理后，变更才<strong>保证被持久化</strong>（由 <code>SessionService</code> 保存）</p>
</li>
<li>
<p><strong>影响</strong>：从 <code>yield</code> 恢复后运行的代码可以可靠假定<em>产出事件</em>中的状态变更已提交</p>
</li>
</ul>
<div class="language-py highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># Inside agent logic (conceptual)</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="c1"># 1. Modify state</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">ctx</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;processing&#39;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="n">event1</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="n">EventActions</span><span class="p">(</span><span class="n">state_delta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;processing&#39;</span><span class="p">}))</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="c1"># 2. Yield event with the delta</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="k">yield</span> <span class="n">event1</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="c1"># --- PAUSE --- Runner processes event1, SessionService commits &#39;status&#39; = &#39;processing&#39; ---</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="c1"># 3. Resume execution</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="c1"># Now it&#39;s safe to rely on the committed state</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="n">current_status</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="c1"># Guaranteed to be &#39;processing&#39;</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status after resuming: </span><span class="si">{</span><span class="n">current_status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="_12">会话状态的"脏读"</h3>
<ul>
<li><strong>定义</strong>：虽然提交发生在产出<em>之后</em>，但在<em>同次调用内</em>后续运行（且<em>状态变更事件尚未实际产出和处理前</em>）的代码<strong>常可观察到本地未提交的变更</strong>，这种现象称为"脏读"</li>
<li><strong>示例</strong>：</li>
</ul>
<div class="language-py highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># Code in before_agent_callback</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;field_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;value_1&#39;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="c1"># State is locally set to &#39;value_1&#39;, but not yet committed by Runner</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="c1"># ... agent runs ...</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="c1"># Code in a tool called later *within the same invocation*</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="c1"># Readable (dirty read), but &#39;value_1&#39; isn&#39;t guaranteed persistent yet.</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="n">val</span> <span class="o">=</span> <span class="n">tool_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;field_1&#39;</span><span class="p">]</span> <span class="c1"># &#39;val&#39; will likely be &#39;value_1&#39; here</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dirty read value in tool: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="c1"># Assume the event carrying the state_delta={&#39;field_1&#39;: &#39;value_1&#39;}</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="c1"># is yielded *after* this tool runs and is processed by the Runner.</span>
</span></code></pre></div>
<ul>
<li><strong>影响</strong>：</li>
<li><strong>优势</strong>：允许复杂步骤中不同逻辑部分（如多次回调或工具调用）无需等待完整产出/提交周期即可通过状态协调</li>
<li><strong>注意</strong>：关键逻辑过度依赖脏读存在风险。若调用在携带 <code>state_delta</code> 的事件被 <code>Runner</code> 处理前失败，未提交的变更将丢失。关键状态转换应确保关联事件能被成功处理</li>
</ul>
<h3 id="partialtrue">流式与非流式输出（<code>partial=True</code>）</h3>
<p>这主要涉及大模型响应处理方式，特别是使用流式生成API时：</p>
<ul>
<li><strong>流式</strong>：大模型逐令牌或分块生成响应</li>
<li>框架（通常在 <code>BaseLlmFlow</code> 内）为单个概念响应产出多个 <code>Event</code> 对象，多数事件带 <code>partial=True</code> 标记</li>
<li><code>Runner</code> 收到含 <code>partial=True</code> 标记的事件时通常<strong>立即向上传递</strong>（供UI显示）但<strong>跳过处理其 <code>actions</code></strong>（如 <code>state_delta</code>）</li>
<li>最终框架会为该响应产出标记为非分块（<code>partial=False</code> 或通过 <code>turn_complete=True</code> 隐式标记）的结束事件</li>
<li><code>Runner</code> <strong>仅完整处理该结束事件</strong>，提交关联的 <code>state_delta</code> 或 <code>artifact_delta</code></li>
<li><strong>非流式</strong>：大模型一次性生成完整响应。框架产出单个非分块标记事件，<code>Runner</code> 完整处理</li>
<li><strong>意义</strong>：确保基于大模型<em>完整</em>响应原子性应用状态变更，同时允许UI在生成过程中渐进显示文本</li>
</ul>
<h2 id="run_async">异步优先（<code>run_async</code>）</h2>
<ul>
<li><strong>核心设计</strong>：ADK Runtime 基于 Python 的 <code>asyncio</code> 库构建，高效处理并发操作（如等待大模型响应或工具执行）而不阻塞</li>
<li><strong>主入口</strong>：<code>Runner.run_async</code> 是执行智能体调用的主要方法，所有核心可运行组件（智能体、特定流程）内部均使用 <code>async def</code> 方法</li>
<li><strong>同步便捷接口（<code>run</code>）</strong>：同步方法 <code>Runner.run</code> 主要为便捷性存在（如简单脚本或测试环境），内部通常只是调用 <code>Runner.run_async</code> 并管理异步事件循环执行</li>
<li><strong>开发体验</strong>：建议应用逻辑（如使用 ADK 的 web 服务器）采用 <code>asyncio</code> 设计</li>
<li><strong>同步回调/工具</strong>：框架可无缝处理 <code>async def</code> 和常规 <code>def</code> 函数形式的工具或回调。长时间运行的<em>同步</em>工具或回调（特别是阻塞I/O操作）可能阻塞主 <code>asyncio</code> 事件循环。框架可能通过 <code>asyncio.to_thread</code> 等机制在独立线程池运行此类阻塞代码以避免影响其他异步任务。但CPU密集型同步代码仍会阻塞所在线程</li>
</ul>
<p>理解这些行为有助于编写更健壮的 ADK 应用，并调试与状态一致性、流式更新和异步执行相关的问题。</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright Google 2025
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate", "content.code.copy", "content.tabs.link", "content.code.select", "navigation.instant", "navigation.instant.progress", "navigation.path", "navigation.top", "navigation.tracking", "navigation.indexes", "toc.follow"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>