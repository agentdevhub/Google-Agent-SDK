# 回调机制：观察、定制与控制智能体行为

## 引言：什么是回调及其价值

回调是ADK框架的核心功能，它提供了一种强大的机制来介入智能体的执行流程。通过回调，您可以在不修改ADK核心框架代码的前提下，在预定义的特定节点观察、定制甚至控制智能体的行为。

**本质解析**  
回调本质上是由用户定义的标准Python函数。当创建智能体时，您需要将这些函数与智能体关联。ADK框架会在智能体生命周期的关键阶段自动调用这些函数，例如：

* 在智能体主逻辑运行前或运行后  
* 在向大模型发送请求前或接收响应后  
* 在执行工具（如Python函数或其他智能体）前或完成执行后  

![intro_components.png](../assets/callback_flow.png)

**核心价值**  
回调机制能带来显著的灵活性并实现高级功能：

* **观察与调试**：在关键步骤记录详细信息以供监控和故障排查  
* **定制与控制**：修改流经智能体的数据（如大模型请求或工具结果），或根据业务逻辑完全跳过某些步骤  
* **安全防护**：实施安全规则、验证输入输出、阻止违规操作  
* **状态管理**：在执行过程中读取或动态更新智能体的会话状态  
* **集成增强**：触发外部操作（API调用、通知）或添加缓存等特性  

**注册方式**  
在创建`Agent`或`LlmAgent`实例时，通过将定义好的Python函数作为参数传递给智能体构造函数（`__init__`）来注册回调。

```py
--8<-- "examples/python/snippets/callbacks/callback_basic.py:callback_basic"
```

## 回调机制：拦截与控制原理

当ADK框架运行到可触发回调的节点时（例如调用大模型前），会检查是否为此智能体注册了对应的回调函数。若存在注册函数，框架将执行该函数。

**上下文核心**  
回调函数并非孤立运行。框架会提供特殊的**上下文对象**（`CallbackContext`或`ToolContext`）作为参数，这些对象包含智能体当前执行状态的关键信息，包括调用详情、会话状态，以及可能存在的服务引用（如工件或内存）。您需要通过这些上下文对象来理解当前状态并与框架交互（详见"上下文对象"专章）。

**流程控制（核心机制）**  
回调最强大的特性在于其**返回值**能影响智能体的后续行为，这是实现执行流拦截与控制的关键：

1. **`return None`（允许默认行为）**  

    * 此返回值表示回调已完成其工作（如日志记录、检查、对`llm_request`等可变输入参数的微调），ADK智能体应**继续正常执行流程**  
    * 对于`before_*`类回调（`before_agent`、`before_model`、`before_tool`），返回`None`意味着将继续执行后续步骤（运行智能体逻辑、调用大模型、执行工具）  
    * 对于`after_*`类回调（`after_agent`、`after_model`、`after_tool`），返回`None`表示直接使用上一步骤产生的结果（智能体输出、大模型响应、工具结果）  

```py
--8<-- "examples/python/snippets/callbacks/before_model_callback.py"
```